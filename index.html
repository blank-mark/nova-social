<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Single-file Messenger ‚Äî Nova Prospect (Firebase)</title>

  <!-- Minimal CSS: just layout, no decoration -->
  <style>
    html,body{height:100%;margin:0;font-family:Arial, Helvetica, sans-serif;}
    .app{display:flex;flex-direction:column;height:100vh;}
    .header{height:64px;display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #ddd;}
    .header .brand{font-weight:700;margin-right:12px;}
    .header .user{margin-left:auto;display:flex;align-items:center;gap:8px;}
    .header img{width:40px;height:40px;border-radius:50%;}
    .main{flex:1;display:flex;overflow:hidden;}
    .left{width:260px;border-right:1px solid #ddd;display:flex;flex-direction:column;padding:8px;box-sizing:border-box;overflow:auto;}
    .right{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    .friends-search{display:flex;gap:6px;margin-bottom:8px;}
    .friends-list{flex:1;overflow:auto;}
    .friend-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer;}
    .friend-item img{width:36px;height:36px;border-radius:50%;}
    .chat-header{height:56px;border-bottom:1px solid #ddd;display:flex;align-items:center;padding:8px 12px;box-sizing:border-box;}
    .messages{flex:1;overflow:auto;padding:12px;box-sizing:border-box;background:#fafafa;}
    .composer{height:72px;border-top:1px solid #ddd;display:flex;align-items:center;padding:6px;gap:6px;box-sizing:border-box;}
    .composer input[type="text"]{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;}
    .btn{padding:8px 10px;border:1px solid #888;border-radius:6px;background:#fff;cursor:pointer;}
    .msg{margin-bottom:8px;max-width:70%;}
    .msg.me{margin-left:auto;text-align:right;}
    .msg .bubble{display:inline-block;padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff;}
    .sticker{font-size:24px;}
    .small{font-size:12px;color:#666;}
    /* mobile fallback */
    @media (max-width:600px){
      .left{width:40%;min-width:200px;}
    }
  </style>

  <!-- Firebase compat SDKs (single-file simplicity). Using compat so code is concise. -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
  <div id="app" class="app">
    <!-- Header with sign-in button / user info -->
    <div class="header">
      <div class="brand">Nova Prospect ‚Äî Messenger</div>
      <div id="auth-controls">
        <button id="loginBtn" class="btn">–í–æ–π—Ç–∏ —Å Google</button>
      </div>
      <div id="userBox" class="user" style="display:none">
        <img id="userPhoto" src="" alt="avatar"/>
        <div style="display:flex;flex-direction:column;align-items:flex-end;">
          <div id="userName"></div>
          <div id="userEmail" class="small"></div>
        </div>
        <button id="logoutBtn" class="btn" style="margin-left:10px;">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- Main area: left (friends + add), right (chat) -->
    <div class="main" style="display:none" id="mainUI">
      <div class="left">
        <div style="margin-bottom:8px;">
          <strong>–ú–æ–∏ –¥—Ä—É–∑—å—è</strong>
        </div>

        <div class="friends-search">
          <input id="searchUsername" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:6px;" />
          <button id="addFriendBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div id="friendsList" class="friends-list"></div>

        <div style="margin-top:8px;font-size:12px;color:#444">
          <div><strong>–°—Ç–∏–∫–µ—Ä—ã:</strong></div>
          <div id="stickers" style="display:flex;gap:6px;margin-top:6px;"></div>
        </div>
      </div>

      <div class="right">
        <div id="chatHeader" class="chat-header">–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞ —Å–ª–µ–≤–∞</div>
        <div id="messages" class="messages"></div>

        <div class="composer">
          <input id="messageInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
          <input id="fileInput" type="file" accept="image/*" style="display:none" />
          <button id="uploadBtn" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
          <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Username modal (simple, inline) -->
    <div id="usernameModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;">
      <div style="background:#fff;padding:16px;border-radius:8px;width:320px;box-sizing:border-box;">
        <h3>–ü—Ä–∏–¥—É–º–∞–π—Ç–µ username</h3>
        <p class="small">Username –±—É–¥–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏ –ø–æ–∑–≤–æ–ª–∏—Ç –¥—Ä—É–≥–∏–º –¥–æ–±–∞–≤–ª—è—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è.</p>
        <input id="usernameInput" type="text" placeholder="username (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_-)" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;" />
        <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end;">
          <button id="saveUsernameBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div id="usernameError" class="small" style="color:red;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <script>
  /************************************************************************
   * Single-file Messenger (Firebase compat v9) ‚Äî main logic
   *
   * Features implemented:
   * - Google Sign-in (popup)
   * - First-time username creation and uniqueness check
   * - users collection: users/{uid} with fields: uid, username, email, photoURL, friends[]
   * - Add friend by username (adds target uid to current user's friends array)
   * - Left friends list (avatars + username)
   * - One-to-one messages stored in collection 'messages' with:
   *     { text, senderId, receiverId, participants: [uidA, uidB], timestamp, type, mediaURL }
   * - Real-time updates via onSnapshot for user doc and messages
   * - Image upload to Storage (chat_images/)
   *
   * Note: this is intentionally minimal UI and minimal CSS per request.
   ************************************************************************/

  // ---------- Firebase config (provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
    authDomain: "nova-prospect-chat.firebaseapp.com",
    projectId: "nova-prospect-chat",
    storageBucket: "nova-prospect-chat.firebasestorage.app",
    messagingSenderId: "256806164650",
    appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
    measurementId: "G-9V0Q2E2FNB"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ---------- DOM ----------
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authControls = document.getElementById('auth-controls');
  const userBox = document.getElementById('userBox');
  const userPhoto = document.getElementById('userPhoto');
  const userName = document.getElementById('userName');
  const userEmail = document.getElementById('userEmail');
  const mainUI = document.getElementById('mainUI');

  const searchUsername = document.getElementById('searchUsername');
  const addFriendBtn = document.getElementById('addFriendBtn');
  const friendsListEl = document.getElementById('friendsList');

  const messagesEl = document.getElementById('messages');
  const chatHeader = document.getElementById('chatHeader');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');

  const usernameModal = document.getElementById('usernameModal');
  const usernameInput = document.getElementById('usernameInput');
  const saveUsernameBtn = document.getElementById('saveUsernameBtn');
  const usernameError = document.getElementById('usernameError');

  const stickersContainer = document.getElementById('stickers');
  const STICKERS = ['üòä','üëç','üî•','üéâ','üòÖ','ü§ò'];

  // ---------- App state ----------
  let currentUser = null; // firebase user auth object
  let currentUserDoc = null; // user's Firestore doc data
  let userDocUnsub = null;
  let messagesUnsub = null;
  let selectedFriend = null; // { uid, username, email, photoURL }

  // Initialize sticker buttons
  STICKERS.forEach(s=>{
    const b = document.createElement('button');
    b.className = 'btn sticker';
    b.textContent = s;
    b.title = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∏–∫–µ—Ä ' + s;
    b.onclick = () => sendSticker(s);
    stickersContainer.appendChild(b);
  });

  // ---------- Auth handlers ----------
  loginBtn.onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
      // onAuthStateChanged will handle UI
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + err.message);
      console.error(err);
    }
  };

  logoutBtn.onclick = async () => {
    await auth.signOut();
    location.reload();
  };

  // Listen auth state
  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      showUserInfo(user);
      await ensureUserDoc(user);
      startUserListener(user.uid);
      document.getElementById('app').style.display = 'block';
      mainUI.style.display = 'flex';
      authControls.style.display = 'none';
      userBox.style.display = 'flex';
      renderFriends(); // initial
    } else {
      // show login
      authControls.style.display = 'block';
      userBox.style.display = 'none';
      mainUI.style.display = 'none';
    }
  });

  function showUserInfo(user){
    userPhoto.src = user.photoURL || '';
    userName.textContent = user.displayName || (user.email || '').split('@')[0];
    userEmail.textContent = user.email || '';
  }

  // ---------- Username creation (first login) ----------
  async function ensureUserDoc(user){
    const uref = db.collection('users').doc(user.uid);
    const doc = await uref.get();
    if (doc.exists) {
      currentUserDoc = doc.data();
      return;
    }
    // ask for username
    usernameModal.style.display = 'flex';
  }

  saveUsernameBtn.onclick = async () => {
    const val = (usernameInput.value || '').trim();
    usernameError.textContent = '';
    if (!val) { usernameError.textContent = '–í–≤–µ–¥–∏—Ç–µ username'; return; }
    if (!/^[a-zA-Z0-9_\-]{3,20}$/.test(val)) {
      usernameError.textContent = '–î–æ–ø—É—Å—Ç–∏–º—ã –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _ –∏ -, –¥–ª–∏–Ω–∞ 3-20';
      return;
    }
    // uniqueness check
    try {
      const q = await db.collection('users').where('username','==',val).get();
      if (!q.empty) {
        usernameError.textContent = '–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç';
        return;
      }
      // create user doc
      const userObj = {
        uid: currentUser.uid,
        username: val,
        email: currentUser.email || '',
        photoURL: currentUser.photoURL || '',
        friends: []
      };
      await db.collection('users').doc(currentUser.uid).set(userObj);
      currentUserDoc = userObj;
      usernameModal.style.display = 'none';
      usernameInput.value = '';
      renderFriends();
    } catch (err) {
      console.error(err);
      usernameError.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
    }
  };

  // ---------- User doc realtime listener ----------
  function startUserListener(uid){
    if (userDocUnsub) userDocUnsub();
    userDocUnsub = db.collection('users').doc(uid).onSnapshot(doc=>{
      if (doc.exists) {
        currentUserDoc = doc.data();
        renderFriends();
      }
    }, err=>console.error('user listener err',err));
  }

  // ---------- Friends rendering & adding ----------
  async function renderFriends(){
    friendsListEl.innerHTML = '';
    if (!currentUserDoc) return;
    const friends = currentUserDoc.friends || [];
    if (friends.length === 0){
      friendsListEl.innerHTML = '<div class="small" style="padding:8px">–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–æ username.</div>';
      return;
    }
    // For each friend uid, fetch user doc (lightweight)
    for (const fid of friends){
      try {
        const fdoc = await db.collection('users').doc(fid).get();
        if (!fdoc.exists) continue;
        const f = fdoc.data();
        const item = document.createElement('div');
        item.className = 'friend-item';
        item.dataset.uid = f.uid;
        item.innerHTML = `<img src="${f.photoURL||''}" alt="a"/><div style="display:flex;flex-direction:column"><div style="font-weight:600">${f.username||f.email||f.uid}</div><div class="small">${f.email||''}</div></div>`;
        item.onclick = ()=>selectFriend(f);
        friendsListEl.appendChild(item);
      } catch (err) {
        console.error('error fetching friend',err);
      }
    }
  }

  addFriendBtn.onclick = async () => {
    const username = (searchUsername.value || '').trim();
    if (!username) { alert('–í–≤–µ–¥–∏—Ç–µ username'); return; }
    if (!currentUser) { alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
    // find user by username
    try {
      const q = await db.collection('users').where('username','==',username).get();
      if (q.empty) { alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
      const found = q.docs[0].data();
      if (found.uid === currentUser.uid) { alert('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è'); return; }
      const friends = currentUserDoc?.friends || [];
      if (friends.includes(found.uid)) { alert('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö'); return; }
      // Add friend uid to current user's friends array
      await db.collection('users').doc(currentUser.uid).update({
        friends: firebase.firestore.FieldValue.arrayUnion(found.uid)
      });
      // UI will update via onSnapshot
      searchUsername.value = '';
      alert('–î–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è: ' + (found.username || found.email));
    } catch (err) {
      console.error(err);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: ' + err.message);
    }
  };

  // ---------- Chat selection ----------
  function selectFriend(friendDoc){
    selectedFriend = friendDoc;
    chatHeader.innerHTML = `<img src="${friendDoc.photoURL||''}" style="width:36px;height:36px;border-radius:50%;margin-right:8px;vertical-align:middle"/> <strong>${friendDoc.username||friendDoc.email}</strong>`;
    messagesEl.innerHTML = '';
    if (messagesUnsub) messagesUnsub();
    // subscribe to messages where currentUser is participant (array-contains) and filter by partner
    messagesUnsub = db.collection('messages')
      .where('participants','array-contains', currentUser.uid)
      .orderBy('timestamp')
      .onSnapshot(snap => {
        const msgs = [];
        snap.forEach(d=>{
          const data = d.data();
          // filter to the conversation between currentUser and selectedFriend
          if (!data.participants || !data.participants.includes(selectedFriend.uid)) return;
          msgs.push({...data, id:d.id});
        });
        renderMessages(msgs);
      }, err => console.error('messages listener err',err));
  }

  // ---------- Render messages ----------
  function renderMessages(msgs){
    messagesEl.innerHTML = '';
    if (msgs.length === 0){
      messagesEl.innerHTML = '<div class="small">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ.</div>';
      return;
    }
    for (const m of msgs){
      const div = document.createElement('div');
      div.className = 'msg ' + (m.senderId === currentUser.uid ? 'me' : 'them');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      if (m.type === 'image' && m.mediaURL){
        const img = document.createElement('img');
        img.src = m.mediaURL;
        img.style.maxWidth = '240px';
        img.style.display = 'block';
        img.style.borderRadius = '6px';
        bubble.appendChild(img);
        if (m.text) {
          const t = document.createElement('div'); t.textContent = m.text; t.className='small'; bubble.appendChild(t);
        }
      } else if (m.type === 'sticker'){
        const s = document.createElement('div'); s.textContent = m.text; s.className='sticker'; bubble.appendChild(s);
      } else {
        bubble.textContent = m.text || '';
      }
      // timestamp
      const time = document.createElement('div');
      const ts = m.timestamp && m.timestamp.toDate ? m.timestamp.toDate() : (m.timestamp ? new Date(m.timestamp) : null);
      time.className = 'small';
      time.style.marginTop = '6px';
      time.style.opacity = '0.8';
      time.textContent = ts ? ts.toLocaleString() : '';
      bubble.appendChild(time);

      div.appendChild(bubble);
      messagesEl.appendChild(div);
    }
    // scroll to bottom
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // ---------- Sending messages ----------
  sendBtn.onclick = async () => {
    const text = (messageInput.value || '').trim();
    if (!selectedFriend) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞'); return; }
    if (!text) { return; }
    await sendMessage({ text, type: 'text' });
    messageInput.value = '';
  };

  async function sendSticker(emoji){
    if (!selectedFriend) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞'); return; }
    await sendMessage({ text: emoji, type: 'sticker' });
  }

  uploadBtn.onclick = ()=> fileInput.click();

  fileInput.onchange = async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    if (!selectedFriend) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞'); return; }
    // simple validation
    if (!file.type.startsWith('image/')) { alert('–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'); return; }
    const fname = `chat_images/${Date.now()}_${currentUser.uid}_${file.name.replace(/\s/g,'_')}`;
    try {
      const ref = storage.ref().child(fname);
      const snap = await ref.put(file);
      const url = await snap.ref.getDownloadURL();
      await sendMessage({ text: '', type: 'image', mediaURL: url });
      fileInput.value = '';
    } catch (err) {
      console.error(err);
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message);
    }
  };

  async function sendMessage({ text='', type='text', mediaURL=null }){
    const msg = {
      text,
      senderId: currentUser.uid,
      receiverId: selectedFriend.uid,
      participants: [currentUser.uid, selectedFriend.uid],
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      type,
      mediaURL: mediaURL || null
    };
    try {
      await db.collection('messages').add(msg);
    } catch (err) {
      console.error('sendMessage err',err);
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + err.message);
    }
  }

  // ---------- Cleanup on unload ----------
  window.addEventListener('beforeunload', ()=>{
    if (userDocUnsub) userDocUnsub();
    if (messagesUnsub) messagesUnsub();
  });

  // ---------- Small helper: show main UI if already signed in (handled by onAuthStateChanged) ----------

  </script>

  <!--
    FIRESTORE & STORAGE SECURITY RULES (copy & paste into Firebase console ‚Äî Firestore and Storage respectively).
    –≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤—ã—à–µ –ª–æ–≥–∏–∫–æ–π.
    –ü–æ—è—Å–Ω–µ–Ω–∏—è:
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: request.auth != null
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç users/{uid}
    - –°–æ–æ–±—â–µ–Ω–∏—è –º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ request.auth.uid —è–≤–ª—è–µ—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –¥–∏–∞–ª–æ–≥–∞
    - Storage —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

    ---------------------------
    Firestore rules (Firestore ‚Üí Rules)
    ---------------------------
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        // USERS collection
        match /users/{userId} {
          allow read: if request.auth != null; // any authenticated user can read users
          allow create: if request.auth != null && request.auth.uid == userId
                        && request.resource.data.uid == userId
                        && request.resource.data.keys().hasAll(['uid','username','email','photoURL','friends']);
          // only owner can update their own doc; they can update friends array and their fields
          allow update: if request.auth != null && request.auth.uid == userId
                        && request.resource.data.uid == userId;
          allow delete: if false; // prevent deleting user docs via client (handle via admin)
        }

        // MESSAGES collection
        match /messages/{messageId} {
          allow create: if request.auth != null
                        // new message must include participants array and senderId must be request.auth.uid
                        && request.resource.data.keys().hasAll(['participants','senderId','receiverId','timestamp','type'])
                        && request.resource.data.participants.size() == 2
                        && request.resource.data.participants.contains(request.auth.uid)
                        && request.resource.data.senderId == request.auth.uid;
          allow read: if request.auth != null
                      && resource.data.participants != null
                      && resource.data.participants.contains(request.auth.uid);
          allow update, delete: if request.auth != null
                                && resource.data.participants != null
                                && resource.data.participants.contains(request.auth.uid);
        }

        // Optionally allow other collections rules...
      }
    }

    ---------------------------
    Storage rules (Storage ‚Üí Rules)
    ---------------------------
    rules_version = '2';
    service firebase.storage {
      match /b/{bucket}/o {
        // Allow authenticated users to read/write files
        match /{allPaths=**} {
          allow read, write: if request.auth != null;
        }
      }
    }

    ---------------------------
    Notes and recommendations:
    - –≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ–ø—É—Å–∫–∞—é—Ç, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏ user-–¥–æ–∫—É–º–µ–Ω—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
    - –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —á—É–∂–æ–π users/{uid} (–Ω–∞–ø—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π –∫ —á—É–∂–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É),
      —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: update —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É.
    - –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ messages –ø—Ä–æ–≤–µ—Ä—è—é—Ç, —á—Ç–æ –∞–≤—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ participants.
    - –î–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–π –º–æ–¥–µ–ª–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É "threads" (–¥–∏–∞–ª–æ–≥–∏) –∏ –ø–æ–º–µ—â–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ subcollections,
      –∞ —Ç–∞–∫–∂–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ participants –Ω–µ –º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è.
    - –î–ª—è production: —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞, —Ä–∞–∑–º–µ—Ä/—Ç–∏–ø –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤),
      –ª–∏–º–∏—Ç—ã –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ —Ç.–ø.
  -->
</body>
</html>
