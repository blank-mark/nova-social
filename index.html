<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NovaNet ‚Äî —É–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (Twitter-like) ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π</title>
<style>
/* =====================================================================
   NovaNet - –£–ª—É—á—à–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –≤ —Å—Ç–∏–ª–µ Twitter / —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–æ—Ü—Å–µ—Ç—å
   –í–µ—Å—å CSS –≤—Å—Ç—Ä–æ–µ–Ω. –ê–¥–∞–ø—Ç–∏–≤–µ–Ω, —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –û–¥–∏–Ω —Ñ–∞–π–ª.
   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏: –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü, composer –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è,
   –∑–∞—â–∏—Ç–∞ –æ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º.
   ===================================================================== */

/* -------------------------
   –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã
   ------------------------- */
:root{
  --bg: #0f1724;
  --panel: linear-gradient(180deg,#0b1220, #0f172a);
  --muted: #9aa6b2;
  --text: #e6eef6;
  --accent: #1d9bf0; /* twitter like */
  --accent-2: #60a5fa;
  --danger: #ff5a5f;
  --glass: rgba(255,255,255,0.03);
  --soft-shadow: 0 6px 18px rgba(2,6,23,0.6);
  --card-radius: 14px;
  --border: rgba(255,255,255,0.04);
  --max-width: 1100px;
  --transition: 220ms cubic-bezier(.2,.9,.3,1);
  --glass-2: rgba(255,255,255,0.02);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* Light theme */
body.light{
  --bg: #f6f8fb;
  --panel: linear-gradient(180deg,#ffffff,#f8fafc);
  --muted: #5b6b76;
  --text: #07122a;
  --accent: #0d6efd;
  --accent-2: #60a5fa;
  --danger: #d9534f;
  --glass: rgba(0,0,0,0.03);
  --soft-shadow: 0 6px 18px rgba(2,6,23,0.08);
  --border: rgba(0,0,0,0.06);
  --glass-2: rgba(0,0,0,0.02);
}

/* -------------------------
   Reset / base
   ------------------------- */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  transition: background var(--transition), color var(--transition);
}

/* Center wrapper */
.app-wrap{
  display:flex;
  justify-content:center;
  padding:18px;
}

/* Main app frame */
.app{
  display:grid;
  grid-template-columns: 260px 1fr 320px;
  gap:18px;
  width:100%;
  max-width:var(--max-width);
  align-items:start;
}

/* Mobile adjustments */
@media (max-width:1000px){
  .app{grid-template-columns: 1fr; padding:12px}
  .right-col{display:none}
  .left-col{position:sticky; top:0; z-index:20}
}

/* -------------------------
   Left column (nav)
   ------------------------- */
.left-col{
  background:var(--panel);
  border-radius:16px;
  padding:18px;
  min-height:80vh;
  box-shadow:var(--soft-shadow);
  border:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* Logo */
.brand{
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:6px;
}
.brand .logo{
  width:46px;height:46px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:white;font-size:20px;box-shadow:0 8px 24px rgba(29,155,240,0.18);
}
.brand .title{
  font-weight:700;font-size:18px;color:var(--text)
}
.brand .tag{font-size:12px;color:var(--muted)}

/* Navigation buttons */
.nav{
  display:flex;flex-direction:column;gap:8px;margin-top:6px;
}
.nav button{
  display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;background:transparent;
  color:var(--text);font-weight:600;border:1px solid transparent;transition:all var(--transition);
}
.nav button .ico{width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:18px}
.nav button:hover{background:var(--glass);transform:translateY(-2px)}
.nav button.active{background:linear-gradient(90deg, rgba(29,155,240,0.12), rgba(96,165,250,0.06)); border:1px solid rgba(29,155,240,0.12)}

/* Compose button */
.compose{
  margin-top:auto;
}
.btn-primary{
  width:100%;
  padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:white;font-weight:700;box-shadow:0 10px 30px rgba(29,155,240,0.14);transition:transform var(--transition);
}
.btn-primary:hover{transform:translateY(-3px)}
.small{font-size:13px;padding:8px}

/* -------------------------
   Center column (feed)
   ------------------------- */
.center-col{
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* New post composer (card) */
.composer{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  padding:14px;border-radius:14px;border:1px solid var(--border);box-shadow:var(--soft-shadow);
}
.composer-top{display:flex;gap:12px;align-items:flex-start}
.avatar-sm{width:48px;height:48px;border-radius:50%;background:var(--glass);display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:var(--text);font-size:16px}
.composer textarea{
  flex:1;min-height:72px;background:transparent;border:none;color:var(--text);
  resize:none;font-size:15px;padding:6px;outline:none;
}
.composer-actions{display:flex;justify-content:space-between;align-items:center;padding-top:8px}
.file-input{display:flex;gap:8px;align-items:center}
.icon-btn{padding:8px;border-radius:10px;background:transparent;border:1px dashed rgba(255,255,255,0.03);cursor:pointer}
.counter{color:var(--muted);font-size:13px;margin-right:12px}

/* Post card */
.post-card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  padding:14px;border-radius:14px;border:1px solid var(--border);box-shadow:var(--soft-shadow);
  display:flex;gap:12px;align-items:flex-start;
}
.post-main{flex:1}
.post-meta{display:flex;gap:10px;align-items:center;font-size:13px;color:var(--muted)}
.post-text{margin-top:8px;font-size:15px;line-height:1.45;color:var(--text)}
.post-media{margin-top:10px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
.post-media img{width:100%;height:auto;display:block}

/* Actions row */
.actions-row{display:flex;gap:18px;margin-top:12px;align-items:center}
.action{
  display:flex;gap:8px;align-items:center;color:var(--muted);cursor:pointer;padding:8px;border-radius:10px;transition:all var(--transition)
}
.action:hover{background:var(--glass);color:var(--accent);transform:translateY(-3px)}

/* Highlight liked */
.action.liked{color: #ff7aa2; background: rgba(255,122,162,0.06)}

/* -------------------------
   Right column (trends, suggestions)
   ------------------------- */
.right-col{
  background:var(--panel);border-radius:16px;padding:14px;border:1px solid var(--border);box-shadow:var(--soft-shadow);min-height:80vh;
}
.section-title{font-weight:700;margin-bottom:8px;color:var(--text)}
.trend, .who{
  padding:10px;border-radius:12px;background:transparent;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:var(--muted);
}
.trend:hover, .who:hover{background:var(--glass);transform:translateY(-3px);color:var(--text)}
.trend small{display:block;font-size:12px;color:var(--muted)}

/* -------------------------
   Profile compact
   ------------------------- */
.profile-compact{display:flex;gap:12px;align-items:center;padding:10px;border-radius:12px;background:var(--glass)}
.profile-compact .info{flex:1}
.profile-compact .name{font-weight:700}
.profile-compact .sub{font-size:13px;color:var(--muted)}

/* -------------------------
   Auth modal / page
   ------------------------- */
.auth-wrap{
  max-width:900px;margin:60px auto;padding:18px;display:grid;grid-template-columns:1fr 420px;gap:20px;
}
.auth-left{display:flex;flex-direction:column;gap:12px;justify-content:center}
.auth-card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  padding:18px;border-radius:14px;border:1px solid var(--border);box-shadow:var(--soft-shadow);
}
.input{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.input input{padding:12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}

/* -------------------------
   Small utilities
   ------------------------- */
.flex{display:flex;align-items:center;gap:8px}
.center{text-align:center}
.pink{color:#ff7aa2}
.muted{color:var(--muted)}
.sep{height:1px;background:var(--border);margin:12px 0;border-radius:2px}

/* -------------------------
   Notifications toast
   ------------------------- */
.toast{
  position:fixed;right:22px;bottom:22px;padding:12px 14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid var(--border);box-shadow:0 12px 40px rgba(2,6,23,0.45);color:var(--text);
  animation:toastin 280ms ease both;
}
@keyframes toastin{from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:translateY(0)}}

/* -------------------------
   Responsive tweaks
   ------------------------- */
@media (max-width:700px){
  .nav button span.text{display:none}
  .left-col{padding:10px}
  .compose{display:none}
  .composer textarea{min-height:56px}
}
</style>
</head>
<body>

<!--
  –ò—Å–ø—Ä–∞–≤–ª—ë–Ω–Ω—ã–π –æ–¥–∏–Ω —Ñ–∞–π–ª: composer —Ç–µ–ø–µ—Ä—å –ø–æ—Å—Ç–æ—è–Ω–µ–Ω (–Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü).
  –í—Å–µ —Ä–µ–Ω–¥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–Ω—É—Ç—Ä–∏ #pageContent ‚Äî —ç—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ document.getElementById(...).style is null.
-->

<div id="root">

  <!-- AUTH / MAIN SWITCH -->
  <div id="authPage" class="auth-wrap" style="display:none">
    <div class="auth-left">
      <div style="font-weight:800;font-size:28px;color:var(--text)">NovaNet</div>
      <div style="font-size:15px;color:var(--muted)">–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ—Ç—å ‚Äî —Ç–µ–ø–µ—Ä—å —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º UI –≤ —Å—Ç–∏–ª–µ Twitter.</div>

      <div class="auth-card">
        <div style="font-weight:700;margin-bottom:8px">–í—Ö–æ–¥</div>
        <div class="input"><label class="muted">–õ–æ–≥–∏–Ω</label><input id="in_user" placeholder="–ª–æ–≥–∏–Ω"></div>
        <div class="input"><label class="muted">–ü–∞—Ä–æ–ª—å</label><input id="in_pass" type="password" placeholder="–ø–∞—Ä–æ–ª—å"></div>
        <div style="display:flex;gap:8px">
          <button class="btn-primary small" onclick="actionLogin()">–í–æ–π—Ç–∏</button>
          <button class="small" onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
      </div>

      <div class="sep"></div>

      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800">NN</div>
        <div>
          <div style="font-weight:700">NovaNet</div>
          <div class="muted" style="font-size:13px">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π MVP ‚Äî –º–∞–∫—Å–∏–º—É–º –∑–∞–±–æ—Ç—ã –æ –¥–∏–∑–∞–π–Ω–µ</div>
        </div>
      </div>

    </div>

    <div>
      <div class="auth-card">
        <div style="font-weight:700;margin-bottom:8px">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>
        <div class="input"><label class="muted">–õ–æ–≥–∏–Ω</label><input id="up_user" placeholder="–ª–æ–≥–∏–Ω"></div>
        <div class="input"><label class="muted">–ü–∞—Ä–æ–ª—å</label><input id="up_pass" type="password" placeholder="–ø–∞—Ä–æ–ª—å"></div>
        <div class="input"><label class="muted">–ò–º—è (–ø—É–±–ª–∏—á–Ω–æ–µ)</label><input id="up_name" placeholder="–∏–º—è"></div>
        <div style="display:flex;gap:8px">
          <button class="btn-primary small" onclick="actionRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
          <button class="small" onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="auth-card">
        <div style="font-weight:700">–ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä</div>
        <ul style="margin-top:8px;color:var(--muted);line-height:1.6;padding-left:18px">
          <li>–ü—É–±–ª–∏–∫–∞—Ü–∏–∏, –ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</li>
          <li>–ß–∞—Ç—ã –≤ —Å—Ç–∏–ª–µ Telegram</li>
          <li>–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ–¥–ø–∏—Å–∫–∏</li>
        </ul>
      </div>

    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" style="display:none" class="app-wrap">
    <div class="app">

      <!-- LEFT NAV -->
      <div class="left-col" id="leftCol">
        <div class="brand">
          <div class="logo">NN</div>
          <div>
            <div class="title">NovaNet</div>
            <div class="tag">–°–æ—Ü—Å–µ—Ç—å MVP</div>
          </div>
        </div>

        <div class="nav" role="navigation" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
          <button id="btnFeed" class="active" onclick="showFeed()"><span class="ico">üè†</span><span class="text"> <span class="text">–ì–ª–∞–≤–Ω–∞—è</span></span></button>
          <button id="btnExplore" onclick="showExplore()"><span class="ico">üîç</span><span class="text"> –û–±–∑–æ—Ä</span></button>
          <button id="btnMessages" onclick="showChats()"><span class="ico">üí¨</span><span class="text"> –ß–∞—Ç—ã</span></button>
          <button id="btnProfile" onclick="showProfile()"><span class="ico">üë§</span><span class="text"> –ü—Ä–æ—Ñ–∏–ª—å</span></button>
          <button id="btnDrafts" onclick="showDrafts()"><span class="ico">üìù</span><span class="text"> –ß–µ—Ä–Ω–æ–≤–∏–∫–∏</span></button>
          <button onclick="toggleTheme()"><span class="ico">üåó</span><span class="text"> –¢–µ–º–∞</span></button>
        </div>

        <div class="compose">
          <button class="btn-primary" onclick="openComposer()">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</button>
        </div>

        <div style="margin-top:10px">
          <div class="profile-compact">
            <div class="avatar-sm" id="sideAvatar">U</div>
            <div class="info">
              <div class="name" id="sideName">–ì–æ—Å—Ç—å</div>
              <div class="sub" id="sideHandle">@guest</div>
            </div>
          </div>
        </div>

      </div>

      <!-- CENTER FEED -->
      <main class="center-col" id="centerCol">

        <!-- Composer (in feed) ‚Äî —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–ø–µ—Ä—å –ü–ï–†–ú–ê–ù–ï–ù–¢–ï–ù –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è -->
        <div id="composerCard" class="composer" style="display:none">
          <div class="composer-top">
            <div class="avatar-sm" id="composerAvatar">U</div>
            <textarea id="composerText" maxlength="280" placeholder="–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?"></textarea>
          </div>

          <div class="composer-actions">
            <div class="file-input">
              <label class="icon-btn" title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">
                <input type="file" id="composerFile" style="display:none" accept="image/*" onchange="previewComposerMedia(event)">
                üñº
              </label>
              <div id="composerPreview" style="min-width:0"></div>
            </div>
            <div style="display:flex;align-items:center">
              <div class="counter" id="charsLeft">280</div>
              <button class="btn-primary small" onclick="publishPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
          </div>
        </div>

        <!-- Page content (–≤—Å—ë, —á—Ç–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è: –ª–µ–Ω—Ç–∞, —á–∞—Ç—ã, –ø—Ä–æ—Ñ–∏–ª—å) -->
        <div id="pageContent">
          <!-- –≤–Ω—É—Ç—Ä–∏ –±—É–¥–µ—Ç feedList / chat area / profile –∏ —Ç.–¥. -->
          <div id="feedList"></div>
        </div>

      </main>

      <!-- RIGHT TRENDS / SUGGESTIONS -->
      <aside class="right-col">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="section-title">–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç</div>
            <div class="muted" style="font-size:13px">–¢—Ä–µ–Ω–¥—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</div>
          </div>
          <div style="font-size:12px;color:var(--muted)">–û–±–Ω–æ–≤–ª–µ–Ω–æ</div>
        </div>

        <div style="margin-top:12px" id="trends">
          <!-- trends populated by JS -->
        </div>

        <div class="sep"></div>

        <div>
          <div class="section-title">–ö–æ–≥–æ —á–∏—Ç–∞—Ç—å</div>
          <div id="whoToFollow">
            <!-- suggestions populated by JS -->
          </div>
        </div>

      </aside>

    </div>
  </div>

</div>

<!-- Toast container -->
<div id="toastContainer" style="position:fixed;right:18px;bottom:18px;z-index:9999"></div>

<script>
/* =====================================================================
   NovaNet ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π JS
   –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
   - composerCard —Ç–µ–ø–µ—Ä—å –ø–æ—Å—Ç–æ—è–Ω–µ–Ω –≤ DOM (–Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è).
   - –≤—Å–µ —Ä–µ–Ω–¥–µ—Ä—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ #pageContent (pageContent), –∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç —Ü–µ–Ω—Ç—Ä.
   - –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º (–µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è).
   - –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (showFeed/showChats/showProfile/...)
   ===================================================================== */

/* -------------------------
   –ü—Ä–∏–º–∏—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   ------------------------- */
const STATE = {
  users: JSON.parse(localStorage.getItem('nn_users') || '[]'),
  posts: JSON.parse(localStorage.getItem('nn_posts') || '[]'),
  chats: JSON.parse(localStorage.getItem('nn_chats') || '{}'),
  current: JSON.parse(localStorage.getItem('nn_current') || 'null'),
  drafts: JSON.parse(localStorage.getItem('nn_drafts') || '[]'),
  theme: localStorage.getItem('nn_theme') || 'dark'
};

/* -------------------------
   Helpers
   ------------------------- */
function saveAll(){
  localStorage.setItem('nn_users', JSON.stringify(STATE.users));
  localStorage.setItem('nn_posts', JSON.stringify(STATE.posts));
  localStorage.setItem('nn_chats', JSON.stringify(STATE.chats));
  localStorage.setItem('nn_drafts', JSON.stringify(STATE.drafts));
  localStorage.setItem('nn_current', JSON.stringify(STATE.current));
}
function toast(msg, time=2500){
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(()=>{ try{ el.style.opacity=0; el.remove(); }catch(e){} }, time);
}
function uid(){ return Date.now() + Math.floor(Math.random()*999) }

/* -------------------------
   Theme management
   ------------------------- */
function applyTheme(){
  if(STATE.theme === 'light') document.body.classList.add('light');
  else document.body.classList.remove('light');
  localStorage.setItem('nn_theme', STATE.theme);
}
function toggleTheme(){
  STATE.theme = STATE.theme === 'light' ? 'dark' : 'light';
  applyTheme();
}

/* -------------------------
   Initial boot: show auth or app
   ------------------------- */
function boot(){
  applyTheme();
  if(STATE.current){
    showApp();
  }else{
    showAuth();
  }
}

/* -------------------------
   AUTH: register / login
   ------------------------- */
function showAuth(){
  const authPage = document.getElementById('authPage');
  const app = document.getElementById('app');
  if(authPage) authPage.style.display = 'grid';
  if(app) app.style.display = 'none';
}
function showApp(){
  const authPage = document.getElementById('authPage');
  const app = document.getElementById('app');
  if(authPage) authPage.style.display = 'none';
  if(app) app.style.display = 'block';
  refreshUI();
  showFeed();
}
function actionRegister(){
  const username = (document.getElementById('up_user').value || '').trim();
  const pass = (document.getElementById('up_pass').value || '').trim();
  const name = (document.getElementById('up_name').value || '').trim() || username;
  if(!username || !pass){ toast('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'); return }
  if(STATE.users.find(u=>u.username===username)){ toast('–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –µ—Å—Ç—å'); return }
  const user = {
    id: uid(),
    username,
    password: pass,
    displayName: name,
    bio: '',
    avatar: '', /* dataURL */
    followers: [],
    following: []
  };
  STATE.users.push(user);
  STATE.current = user;
  saveAll();
  toast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω –∏ –≤—ã –≤–æ—à–ª–∏');
  showApp();
}
function actionLogin(){
  const username = (document.getElementById('in_user').value || '').trim();
  const pass = (document.getElementById('in_pass').value || '').trim();
  const user = STATE.users.find(u=>u.username===username && u.password===pass);
  if(!user){ toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); return }
  STATE.current = user;
  saveAll();
  toast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
  showApp();
}
function logout(){
  STATE.current = null;
  saveAll();
  location.reload();
}

/* -------------------------
   Simple navigation actions
   ------------------------- */
function showFeed(){
  activateNav('btnFeed');
  showComposerInline(true);
  renderFeed();
}
function showExplore(){ activateNav('btnExplore'); showComposerInline(false); renderExplore(); }
function showChats(){ activateNav('btnMessages'); showComposerInline(false); renderChats(); }
function showProfile(){ activateNav('btnProfile'); showComposerInline(false); renderProfile(); }
function showDrafts(){ activateNav('btnDrafts'); showComposerInline(false); renderDrafts(); }
function activateNav(id){
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
}

/* -------------------------
   Composer actions
   ------------------------- */
function openComposer(){
  const el = document.getElementById('composerCard');
  if(!el) return;
  el.style.display = 'block';
  const ta = document.getElementById('composerText');
  if(ta) ta.focus();
}
function showComposerInline(show){
  const el = document.getElementById('composerCard');
  if(!el) return; // –±–µ–∑–æ–ø–∞—Å–Ω–æ, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
  el.style.display = show ? 'block' : 'none';
}

/* -------------------------
   Attach char counter after DOM ready
   ------------------------- */
function attachComposerCounter(){
  const txt = document.getElementById('composerText');
  if(txt){
    txt.addEventListener('input', ()=> {
      const left = 280 - txt.value.length;
      const counter = document.getElementById('charsLeft');
      if(counter) counter.textContent = left;
    });
  }
}

/* preview media */
function previewComposerMedia(e){
  const file = e.target.files[0];
  const preview = document.getElementById('composerPreview');
  if(!preview) return;
  preview.innerHTML = '';
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    const img = document.createElement('img');
    img.src = reader.result;
    img.style.maxWidth='160px'; img.style.maxHeight='90px'; img.style.borderRadius='8px';
    preview.appendChild(img);
    preview.dataset.img = reader.result;
  };
  reader.readAsDataURL(file);
}

/* publish post */
function publishPost(){
  if(!STATE.current){ toast('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç'); return }
  const txt = document.getElementById('composerText');
  const preview = document.getElementById('composerPreview');
  if(!txt || !preview){ toast('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞'); return }
  const content = (txt.value || '').trim();
  if(!content && !preview.dataset.img){ toast('–ü—É—Å—Ç–æ–π –ø–æ—Å—Ç'); return }
  const post = {
    id: uid(),
    author: STATE.current.username,
    authorName: STATE.current.displayName || STATE.current.username,
    avatar: STATE.current.avatar || '',
    text: content,
    media: preview.dataset.img || '',
    likes: [],
    comments: [],
    reposts: 0,
    createdAt: new Date().toISOString()
  };
  STATE.posts.unshift(post);
  saveAll();
  txt.value=''; preview.innerHTML=''; preview.dataset.img='';
  const counter = document.getElementById('charsLeft'); if(counter) counter.textContent = 280;
  toast('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω');
  renderFeed();
}

/* -------------------------
   Render feed
   ------------------------- */
function renderFeed(){
  const feedList = document.getElementById('feedList');
  const pageContent = document.getElementById('pageContent');
  if(!pageContent) return;
  // ensure feedList exists inside pageContent
  if(!feedList){
    const fl = document.createElement('div');
    fl.id = 'feedList';
    pageContent.appendChild(fl);
  }
  const c = document.getElementById('feedList');
  c.innerHTML = '';
  if(STATE.posts.length===0){
    c.innerHTML = `<div class="post-card" style="justify-content:center"><div class="muted center">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤ ‚Äî –±—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º</div></div>`;
    return;
  }
  STATE.posts.forEach(post=>{
    const card = document.createElement('div');
    card.className = 'post-card';
    const left = document.createElement('div');
    left.style.minWidth='56px';
    left.innerHTML = `<div class="avatar-sm">${(post.author||'U')[0].toUpperCase()}</div>`;
    const main = document.createElement('div');
    main.className='post-main';
    const meta = document.createElement('div');
    meta.className = 'post-meta';
    const date = new Date(post.createdAt);
    meta.innerHTML = `<strong style="color:var(--text)">${escapeHtml(post.authorName)}</strong>
                      <span class="muted">@${escapeHtml(post.author)}</span>
                      <span class="muted">¬∑ ${timeAgo(date)}</span>`;
    const text = document.createElement('div');
    text.className='post-text';
    text.innerHTML = linkify(escapeHtml(post.text));
    main.appendChild(meta);
    main.appendChild(text);
    if(post.media){
      const mediaWrap = document.createElement('div');
      mediaWrap.className='post-media';
      mediaWrap.innerHTML = `<img src="${post.media}" alt="media">`;
      main.appendChild(mediaWrap);
    }

    // actions
    const actions = document.createElement('div');
    actions.className='actions-row';
    // like
    const like = document.createElement('div');
    like.className='action';
    if(post.likes.includes(STATE.current?.username)) like.classList.add('liked');
    like.innerHTML = `‚ù§Ô∏è <span>${post.likes.length}</span>`;
    like.onclick = ()=>{ toggleLike(post.id); };
    // comment
    const comm = document.createElement('div');
    comm.className='action';
    comm.innerHTML = `üí¨ <span>${post.comments.length}</span>`;
    comm.onclick = ()=> openComments(post.id);
    // repost
    const rep = document.createElement('div');
    rep.className='action';
    rep.innerHTML = `üîÅ <span>${post.reposts}</span>`;
    rep.onclick = ()=>{ repost(post.id) };
    // delete if mine
    const del = document.createElement('div');
    del.className='action';
    del.innerHTML = `üóë`;
    if(STATE.current && STATE.current.username === post.author){
      del.onclick = ()=>{ deletePost(post.id); };
    } else {
      del.style.opacity = 0.3; del.style.pointerEvents='none';
    }

    actions.appendChild(like);
    actions.appendChild(comm);
    actions.appendChild(rep);
    actions.appendChild(del);
    main.appendChild(actions);

    card.appendChild(left);
    card.appendChild(main);
    c.appendChild(card);
  });
}

/* -------------------------
   Utilities: like/comment/repost/delete
   ------------------------- */
function toggleLike(postId){
  if(!STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return }
  const post = STATE.posts.find(p=>p.id===postId);
  if(!post) return;
  const u = STATE.current.username;
  if(post.likes.includes(u)) post.likes = post.likes.filter(x=>x!==u);
  else post.likes.push(u);
  saveAll();
  renderFeed();
}
function openComments(postId){
  const post = STATE.posts.find(p=>p.id===postId);
  if(!post) return;
  const text = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:');
  if(text && text.trim()){
    post.comments.push({id:uid(), user: STATE.current?.username || 'guest', text:text.trim(), createdAt:new Date().toISOString()});
    saveAll();
    toast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω');
    renderFeed();
  }
}
function repost(postId){
  const post = STATE.posts.find(p=>p.id===postId);
  if(!post) return;
  post.reposts = (post.reposts || 0) + 1;
  saveAll();
  toast('–†–µ–ø–æ—Å—Ç ‚Äî —É—Å–ø–µ—à–Ω–æ');
  renderFeed();
}
function deletePost(postId){
  const idx = STATE.posts.findIndex(p=>p.id===postId);
  if(idx>-1){
    const ok = confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?');
    if(!ok) return;
    STATE.posts.splice(idx,1);
    saveAll();
    renderFeed();
  }
}

/* -------------------------
   Simple profile rendering
   ------------------------- */
function renderProfile(){
  const pageContent = document.getElementById('pageContent');
  if(!pageContent) return;
  pageContent.innerHTML = ''; // –æ—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω–æ –Ω–µ composerCard
  const main = pageContent;
  const user = STATE.current;
  if(!user) { main.innerHTML = '<div class="auth-card">–í–æ–π–¥–∏—Ç–µ</div>'; return; }

  const card = document.createElement('div');
  card.className = 'auth-card';
  card.style.padding='16px';
  card.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:84px;height:84px;border-radius:14px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:800">${user.displayName?.[0] || user.username[0] || 'U'}</div>
      <div style="flex:1">
        <div style="font-weight:800">${escapeHtml(user.displayName || user.username)}</div>
        <div class="muted">@${escapeHtml(user.username)}</div>
      </div>
      <div>
        <button class="btn-primary small" onclick="editProfile()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
    <div style="margin-top:12px;color:var(--muted)">${escapeHtml(user.bio || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}</div>
    <div class="sep"></div>
    <div style="display:flex;gap:12px">
      <div><strong>${user.followers.length}</strong><div class="muted">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div></div>
      <div><strong>${user.following.length}</strong><div class="muted">–ü–æ–¥–ø–∏—Å–∫–∏</div></div>
    </div>
  `;
  main.appendChild(card);

  // list user's posts
  const postsTitle = document.createElement('div');
  postsTitle.className='section-title';
  postsTitle.style.marginTop='12px';
  postsTitle.textContent = '–ú–æ–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏';
  main.appendChild(postsTitle);

  const list = document.createElement('div');
  STATE.posts.filter(p=>p.author===user.username).forEach(p=>{
    const row = document.createElement('div');
    row.className = 'post-card';
    row.innerHTML = `<div style="min-width:54px"><div class="avatar-sm">${p.author[0].toUpperCase()}</div></div>
      <div class="post-main">
       <div class="post-meta"><strong style="color:var(--text)">${escapeHtml(p.authorName)}</strong><span class="muted">@${escapeHtml(p.author)}</span><span class="muted">¬∑ ${timeAgo(new Date(p.createdAt))}</span></div>
       <div class="post-text">${escapeHtml(p.text)}</div>
      </div>`;
    list.appendChild(row);
  });
  main.appendChild(list);
}

/* edit profile prompt */
function editProfile(){
  if(!STATE.current) return;
  const name = prompt('–ò–º—è (–ø—É–±–ª–∏—á–Ω–æ–µ):', STATE.current.displayName || STATE.current.username);
  if(name!==null) STATE.current.displayName = name.trim() || STATE.current.username;
  const bio = prompt('–û–ø–∏—Å–∞–Ω–∏–µ:', STATE.current.bio || '');
  if(bio!==null) STATE.current.bio = bio.trim();
  const avatar = prompt('–í—Å—Ç–∞–≤—å—Ç–µ dataURL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ (–∏–ª–∏ –æ—Ç–º–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞):', STATE.current.avatar || '');
  if(avatar!==null && avatar.trim()){
    STATE.current.avatar = avatar.trim();
  }
  const idx = STATE.users.findIndex(u=>u.username===STATE.current.username);
  if(idx>-1) STATE.users[idx]=STATE.current;
  saveAll();
  toast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
  renderProfile();
  refreshUI();
}

/* -------------------------
   Explore / trends / suggestions
   ------------------------- */
function renderExplore(){
  const pageContent = document.getElementById('pageContent');
  if(!pageContent) return;
  pageContent.innerHTML = '';
  const card = document.createElement('div'); card.className='auth-card';
  card.innerHTML = `<div style="font-weight:800">–û–±–∑–æ—Ä</div><div class="muted" style="margin-top:8px">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ—Å—Ç—ã</div>`;
  pageContent.appendChild(card);

  const top = [...STATE.posts].sort((a,b)=>b.likes.length - a.likes.length).slice(0,10);
  const list = document.createElement('div');
  list.style.marginTop='12px';
  top.forEach(p=>{
    const c = document.createElement('div'); c.className='post-card';
    c.innerHTML = `<div style="min-width:54px"><div class="avatar-sm">${p.author[0].toUpperCase()}</div></div>
      <div class="post-main"><div class="post-meta"><strong>${escapeHtml(p.authorName)}</strong><span class="muted">@${escapeHtml(p.author)}</span></div>
      <div class="post-text">${escapeHtml(p.text)}</div></div>`;
    list.appendChild(c);
  });
  pageContent.appendChild(list);
}

/* populate right column trends & who to follow */
function refreshRight(){
  const trends = document.getElementById('trends');
  if(!trends) return;
  trends.innerHTML = '';
  const hashtags = {};
  STATE.posts.forEach(p=>{
    const matches = (p.text || '').match(/#\w+/g);
    if(matches) matches.forEach(h=>hashtags[h] = (hashtags[h]||0)+1);
  });
  const sorted = Object.entries(hashtags).sort((a,b)=>b[1]-a[1]).slice(0,6);
  if(sorted.length===0){
    const fallback = ['#–¥–∏–∑–∞–π–Ω','#–º—É–∑—ã–∫–∞','#–Ω–æ–≤–æ—Å—Ç–∏','#—á–∞—Ç','#—Å—Ç–∞—Ä—Ç–∞–ø'];
    fallback.forEach((t,i)=> {
      const el = document.createElement('div'); el.className='trend';
      el.innerHTML = `<div><small class="muted">–¢—Ä–µ–Ω–¥ ‚Ä¢ ${i+1}</small><div>${t}</div></div><div class="muted">‚ñ≤ ${Math.floor(Math.random()*900)+100}</div>`;
      trends.appendChild(el);
    });
  } else {
    sorted.forEach(([tag,count],i)=>{
      const el = document.createElement('div'); el.className='trend';
      el.innerHTML = `<div><small class="muted">–¢—Ä–µ–Ω–¥ ‚Ä¢ ${i+1}</small><div>${escapeHtml(tag)}</div></div><div class="muted">‚ñ≤ ${count*10}</div>`;
      trends.appendChild(el);
    });
  }

  const w = document.getElementById('whoToFollow'); if(!w) return;
  w.innerHTML = '';
  const candidates = STATE.users.filter(u=>u.username !== STATE.current?.username).slice(0,5);
  if(candidates.length===0){
    w.innerHTML = `<div class="muted">–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</div>`;
  } else {
    candidates.forEach(u=>{
      const el = document.createElement('div'); el.className='who';
      el.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div style="width:44px;height:44px;background:var(--glass);display:flex;align-items:center;justify-content:center;border-radius:10px">${u.displayName?.[0]||u.username[0]}</div>
      <div style="min-width:0"><div style="font-weight:700">${escapeHtml(u.displayName||u.username)}</div><div class="muted" style="font-size:13px">@${escapeHtml(u.username)}</div></div></div>
      <div><button class="small" onclick="follow('${u.username}', this)">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button></div>`;
      w.appendChild(el);
    });
  }
}

/* -------------------------
   Follow / unfollow
   ------------------------- */
function follow(username, btn){
  if(!STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return }
  if(STATE.current.username === username){ toast('–ù–µ–ª—å–∑—è –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ–±—è'); return }
  const target = STATE.users.find(u=>u.username===username);
  if(!target) return;
  const me = STATE.users.find(u=>u.username===STATE.current.username);
  if(me.following.includes(username)){
    me.following = me.following.filter(x=>x!==username);
    target.followers = target.followers.filter(x=>x!==me.username);
    if(btn) btn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
  } else {
    me.following.push(username);
    target.followers.push(me.username);
    if(btn) btn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è';
  }
  STATE.current = me;
  saveAll();
  refreshUI();
  refreshRight();
}

/* -------------------------
   Chats (simple)
   ------------------------- */
function renderChats(){
  const pageContent = document.getElementById('pageContent');
  if(!pageContent) return;
  pageContent.innerHTML = '';
  const card = document.createElement('div'); card.className='auth-card';
  card.innerHTML = `<div style="font-weight:800">–ß–∞—Ç—ã</div><div class="muted" style="margin-top:8px">–ü—Ä–æ—Å—Ç–æ–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä ‚Äî —Å–ø–∏—Å–∫–∏ —Å–ª–µ–≤–∞, –ø–µ—Ä–µ–ø–∏—Å–∫–∞ —Å–ø—Ä–∞–≤–∞</div>`;
  pageContent.appendChild(card);

  const layout = document.createElement('div');
  layout.style.display='flex'; layout.style.gap='12px'; layout.style.marginTop='12px';

  const left = document.createElement('div'); left.style.width='220px';
  left.className='auth-card';
  left.style.padding='10px';
  STATE.users.forEach(u=>{
    if(!STATE.current || u.username === STATE.current.username) return;
    const item = document.createElement('div'); item.style.padding='8px'; item.style.cursor='pointer';
    item.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:36px;height:36px;border-radius:8px;background:var(--glass);display:flex;align-items:center;justify-content:center">${u.username[0]}</div><div><div style="font-weight:700">${escapeHtml(u.displayName||u.username)}</div><div class="muted" style="font-size:13px">@${escapeHtml(u.username)}</div></div></div>`;
    item.onclick = () => openChatWith(u.username);
    left.appendChild(item);
  });

  const right = document.createElement('div'); right.style.flex=1; right.className='auth-card';
  right.id = 'chatArea';
  right.style.minHeight='240px';
  right.innerHTML = `<div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç —Å–ª–µ–≤–∞</div>`;

  layout.appendChild(left); layout.appendChild(right);
  pageContent.appendChild(layout);
}

/* open chat */
function openChatWith(username){
  const area = document.getElementById('chatArea');
  if(!area) return;
  area.innerHTML = '';
  const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
  header.innerHTML = `<div style="font-weight:800">${username}</div><div class="muted">@${username}</div>`;
  area.appendChild(header);

  const convo = document.createElement('div'); convo.style.minHeight='220px'; convo.style.maxHeight='400px'; convo.style.overflowY='auto'; convo.style.marginTop='12px';
  const key = chatKey(STATE.current.username, username);
  const messages = STATE.chats[key] || [];
  messages.forEach(m=>{
    const bubble = document.createElement('div');
    bubble.style.maxWidth='70%'; bubble.style.padding='10px'; bubble.style.borderRadius='12px'; bubble.style.marginBottom='8px';
    if(m.sender === STATE.current.username){
      bubble.style.background = 'linear-gradient(90deg,var(--accent),var(--accent-2))'; bubble.style.color='white'; bubble.style.marginLeft='auto';
    } else {
      bubble.style.background = 'var(--glass)'; bubble.style.color='var(--text)';
    }
    bubble.textContent = m.text;
    convo.appendChild(bubble);
  });
  area.appendChild(convo);

  const inputRow = document.createElement('div'); inputRow.style.display='flex'; inputRow.style.gap='8px'; inputRow.style.marginTop='12px';
  inputRow.innerHTML = `<input id="chatInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)"><button class="btn-primary small">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>`;
  area.appendChild(inputRow);

  inputRow.querySelector('button').onclick = () => {
    const text = document.getElementById('chatInput').value.trim();
    if(!text) return;
    STATE.chats[key] = STATE.chats[key] || [];
    STATE.chats[key].push({sender: STATE.current.username, text, ts: new Date().toISOString()});
    saveAll();
    openChatWith(username); // re-render
  };
}

/* chat key (consistent) */
function chatKey(a,b){ return [a,b].sort().join('__'); }

/* -------------------------
   Simple search & UI refresh
   ------------------------- */
function refreshUI(){
  const sideAvatar = document.getElementById('sideAvatar');
  const sideName = document.getElementById('sideName');
  const sideHandle = document.getElementById('sideHandle');
  if(STATE.current){
    if(sideAvatar) sideAvatar.textContent = (STATE.current.displayName || STATE.current.username)[0].toUpperCase();
    if(sideName) sideName.textContent = STATE.current.displayName || STATE.current.username;
    if(sideHandle) sideHandle.textContent = `@${STATE.current.username}`;
  } else {
    if(sideAvatar) sideAvatar.textContent = 'G';
    if(sideName) sideName.textContent = '–ì–æ—Å—Ç—å';
    if(sideHandle) sideHandle.textContent = '@guest';
  }
  refreshRight();
}

/* -------------------------
   Misc pages
   ------------------------- */
function showRegister(){ const authPage = document.getElementById('authPage'); const app = document.getElementById('app'); if(authPage) authPage.style.display='grid'; if(app) app.style.display='none' }
function showLogin(){ showRegister(); }
function showDrafts(){ alert('–ß–µ—Ä–Ω–æ–≤–∏–∫–∏: –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞ (—Ñ–∏—á—É –º–æ–∂–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å)'); }

/* -------------------------
   Helpers: timeAgo, escapeHtml, linkify
   ------------------------- */
function timeAgo(d){
  if(typeof d === 'string') d = new Date(d);
  const s = Math.floor((Date.now() - d.getTime())/1000);
  if(s < 60) return `${s}s`;
  if(s < 3600) return `${Math.floor(s/60)}m`;
  if(s < 86400) return `${Math.floor(s/3600)}h`;
  return `${Math.floor(s/86400)}d`;
}
function escapeHtml(str){
  if(!str) return '';
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function linkify(text){
  if(!text) return '';
  return text
    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:var(--accent)">$1</a>')
    .replace(/#(\w+)/g, '<span style="color:var(--accent)">#$1</span>')
    .replace(/@(\w+)/g, '<span style="color:var(--muted)">@\$1</span>');
}

/* -------------------------
   Bootstrap demo content (only first run)
   ------------------------- */
(function seedDemo(){
  if(localStorage.getItem('nn_seeded')) return;
  const demoUsers = [
    { id:uid(), username:'alice', password:'123', displayName:'–ê–ª–∏—Å–∞', bio:'–õ—é–±–ª—é –º—É–∑—ã–∫—É –∏ –∫–æ—Ñ–µ', avatar:'', followers:[], following:[] },
    { id:uid(), username:'bob', password:'123', displayName:'–ë–æ–±', bio:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', avatar:'', followers:[], following:[] },
    { id:uid(), username:'carla', password:'123', displayName:'–ö–∞—Ä–ª–∞', bio:'–§–æ—Ç–æ–≥—Ä–∞—Ñ', avatar:'', followers:[], following:[] }
  ];
  STATE.users = demoUsers;
  STATE.posts = [
    { id:uid(), author:'alice', authorName:'–ê–ª–∏—Å–∞', avatar:'', text:'–ü–µ—Ä–≤—ã–π –ø–æ—Å—Ç –≤ NovaNet! #–¥–∏–∑–∞–π–Ω', media:'', likes:[], comments:[], reposts:0, createdAt:new Date(Date.now()-3600*1000).toISOString() },
    { id:uid(), author:'bob', authorName:'–ë–æ–±', avatar:'', text:'–°–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç: https://example.com', media:'', likes:[], comments:[], reposts:0, createdAt:new Date(Date.now()-7200*1000).toISOString() },
    { id:uid(), author:'carla', authorName:'–ö–∞—Ä–ª–∞', avatar:'', text:'–§–æ—Ç–æ —Å –ø—Ä–æ–≥—É–ª–∫–∏', media:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect width="100%" height="100%" fill="%230b1220"/><text x="50%" y="50%" fill="%23ffffff" font-size="30" font-family="Arial" text-anchor="middle">–ü—Ä–∏–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</text></svg>', likes:[], comments:[], reposts:0, createdAt:new Date(Date.now()-1000*60*60*24).toISOString() }
  ];
  localStorage.setItem('nn_seeded','1');
  saveAll();
})();

/* -------------------------
   Expose for debugging
   ------------------------- */
window.NovaNet = {
  STATE, saveAll, toast
};

/* -------------------------
   DOMContentLoaded wiring
   ------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // show correct screen
  if(STATE.current) {
    showApp();
  } else {
    const authPage = document.getElementById('authPage');
    const app = document.getElementById('app');
    if(authPage) authPage.style.display='grid';
    if(app) app.style.display='none';
  }
  applyTheme();
  attachComposerCounter();
  refreshUI();
  renderFeed();
  refreshRight();
});

/* ===========================
   Paste image convenience
   =========================== */
document.addEventListener('paste', (e)=>{
  if(!e.clipboardData) return;
  const items = e.clipboardData.items;
  if(!items) return;
  for(let i=0;i<items.length;i++){
    const it = items[i];
    if(it.kind === 'file'){
      const blob = it.getAsFile();
      if(blob && blob.type.startsWith('image/')){
        const reader = new FileReader();
        reader.onload = ()=>{
          const preview = document.getElementById('composerPreview');
          if(preview){
            preview.innerHTML = `<img src="${reader.result}" style="max-width:160px;border-radius:8px">`;
            preview.dataset.img = reader.result;
            toast('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ (–≤—Å—Ç–∞–≤–∫–∞)');
          }
        };
        reader.readAsDataURL(blob);
      }
    }
  }
});
</script>

<!-- ===============================
     Firebase integration (module)
     - –Ω–µ –º–µ–Ω—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥, –∞ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç/–¥–æ–ø–æ–ª–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏
     - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Email/Password (–µ—Å–ª–∏ –≤ –ø–æ–ª–µ –≤–≤–µ–¥—ë–Ω email —Å @)
     - —Å–ª—É—à–∞–µ—Ç posts –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç STATE.posts
     - –ø—É–±–ª–∏–∫—É–µ—Ç –ø–æ—Å—Ç—ã –≤ Firestore + –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–µ–¥–∏–∞ –≤ Storage (–µ—Å–ª–∏ –µ—Å—Ç—å)
     - –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–∞–π–∫–∏ —á–µ—Ä–µ–∑ arrayUnion/arrayRemove
================================= -->
<script type="module">
/* eslint-disable no-console */
/*
  –í–ù–ò–ú–ê–ù–ò–ï:
  - –∑–∞–º–µ–Ω–∏—Ç—å firebaseConfig –Ω–∏–∂–µ –Ω–∞ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase Console,
    –µ—Å–ª–∏ —É —Ç–µ–±—è –¥—Ä—É–≥–∏–µ, –ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–∏. (–¢—ã —Ä–∞–Ω–µ–µ –ø—Ä–∏—Å—ã–ª–∞–ª –∫–æ–Ω—Ñ–∏–≥ ‚Äî –µ—Å–ª–∏ –æ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ.)
  - –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ GitHub Pages: –≤ Firebase Console -> Authentication -> Authorized domains
    –¥–æ–±–∞–≤—å –¥–æ–º–µ–Ω: username.github.io –∏–ª–∏ —Å–≤–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–æ–º–µ–Ω.
*/

// --------- –ò–º–ø–æ—Ä—Ç—ã SDK (–º–æ–¥—É–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è v9) ----------
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

// --------- –¢–í–û–ô firebaseConfig (–µ—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç, —á—Ç–æ —É —Ç–µ–±—è –≤ –∫–æ–Ω—Å–æ–ª–∏) ----------
const firebaseConfig = {
  apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
  authDomain: "nova-prospect-chat.firebaseapp.com",
  projectId: "nova-prospect-chat",
  storageBucket: "nova-prospect-chat.firebasestorage.app",
  messagingSenderId: "256806164650",
  appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
  measurementId: "G-9V0Q2E2FNB"
};

// --------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ----------
let firebaseApp, auth, db, storage;
try {
  firebaseApp = initializeApp(firebaseConfig);
  auth = getAuth(firebaseApp);
  db = getFirestore(firebaseApp);
  storage = getStorage(firebaseApp);
  console.log("Firebase initialized");
} catch (err) {
  console.warn("Firebase init failed:", err);
}

// --------- –ü–æ–ª–µ–∑–Ω—ã–µ –≤—Ä–∞–ø–ø–µ—Ä—ã ----------
function emailLike(input) {
  return typeof input === 'string' && input.includes('@');
}

function usernameFromEmail(email) {
  if(!email) return null;
  return email.split('@')[0];
}

// --------- –ü–µ—Ä–µ–∫—Ä—ã–≤–∞–µ–º/–¥–æ–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ----------
if (auth && db) {

  // —Å–ª—É—à–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // –ø–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firestore (–∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –µ—Å–ª–∏ –Ω–µ—Ç)
      const udocRef = doc(db, "users", user.uid);
      const snap = await getDoc(udocRef);
      if (!snap.exists()) {
        // —Å–æ–∑–¥–∞—ë–º –ø—Ä–æ—Ñ–∏–ª—å –≤ users
        const username = user.displayName ? user.displayName.replace(/\s+/g, '') : usernameFromEmail(user.email) || ("u"+Date.now());
        await setDoc(udocRef, {
          uid: user.uid,
          email: user.email || null,
          username: username,
          displayName: user.displayName || username,
          bio: "",
          followers: [],
          following: []
        });
      }
      const userDoc = await getDoc(udocRef);
      const ud = userDoc.data();
      // –ø—Ä–∏–≤–æ–¥–∏–º –≤ —Ñ–æ—Ä–º–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–∂–∏–¥–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
      window.STATE.current = {
        id: ud.uid,
        uid: ud.uid,
        username: ud.username,
        displayName: ud.displayName || ud.username,
        bio: ud.bio || "",
        avatar: ud.avatar || "",
        followers: ud.followers || [],
        following: ud.following || []
      };
      localStorage.setItem('nn_current', JSON.stringify(window.STATE.current));
      // –∑–∞–≥—Ä—É–∑–∏–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á—Ç–æ–±—ã –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Ä–∞–±–æ—Ç–∞–ª–∞)
      await loadUsersFromFirestore();
      refreshUI();
      toast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω (Firebase)");
      // –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      showApp();
    } else {
      // –≤—ã—Ö–æ–¥
      // –Ω–µ –æ—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –±—ç–∫–∞–ø
      console.log("User signed out");
    }
  });

  // —Å–ª—É—à–∞–µ–º –ª–µ–Ω—Ç—É posts –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  try {
    const postsColl = collection(db, "posts");
    const q = query(postsColl, orderBy("createdAt", "desc"));
    onSnapshot(q, (snap) => {
      const arr = [];
      snap.forEach(docSnap => {
        const data = docSnap.data();
        arr.push({
          id: docSnap.id,
          author: data.author || (data.authorName || "unknown"),
          authorName: data.authorName || data.author,
          authorUid: data.authorUid || null,
          text: data.text || "",
          media: data.media || "",
          likes: data.likes || [],
          comments: data.comments || [],
          reposts: data.reposts || 0,
          createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().toISOString() : data.createdAt) : new Date().toISOString()
        });
      });
      window.STATE.posts = arr;
      // –µ—Å–ª–∏ feed –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è ‚Äî –æ–±–Ω–æ–≤–∏–º
      try { renderFeed(); } catch(e){ console.warn(e); }
    });
  } catch (e) {
    console.warn("Failed to listen posts:", e);
  }

  // —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ users –∏–∑ Firestore
  async function loadUsersFromFirestore() {
    try {
      const usersSnapshot = await getDocs(collection(db, "users"));
      const arr = [];
      usersSnapshot.forEach(s => {
        const d = s.data();
        arr.push({
          id: d.uid || s.id,
          username: d.username || (d.email ? usernameFromEmail(d.email) : s.id),
          displayName: d.displayName || d.username || (d.email?usernameFromEmail(d.email):s.id),
          bio: d.bio || "",
          avatar: d.avatar || "",
          followers: d.followers || [],
          following: d.following || []
        });
      });
      window.STATE.users = arr;
      saveAll();
      refreshUI();
      refreshRight();
    } catch (err) {
      console.warn("loadUsersFromFirestore error", err);
    }
  }

  // –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º actionRegister: –µ—Å–ª–∏ up_user —Å–æ–¥–µ—Ä–∂–∏—Ç @ ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Firebase Auth Email/Password
  window.actionRegister = async function() {
    const up_user = (document.getElementById('up_user')?.value || '').trim();
    const up_pass = (document.getElementById('up_pass')?.value || '').trim();
    const up_name = (document.getElementById('up_name')?.value || '').trim() || up_user;
    if(!up_user || !up_pass){ toast('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω (email) –∏ –ø–∞—Ä–æ–ª—å'); return; }

    if(emailLike(up_user)) {
      try {
        const cred = await createUserWithEmailAndPassword(auth, up_user, up_pass);
        // –æ–±–Ω–æ–≤–∏–º displayName
        try { await setDoc(doc(db, "users", cred.user.uid), {
          uid: cred.user.uid,
          email: up_user,
          username: up_name.replace(/\s+/g,'') || usernameFromEmail(up_user),
          displayName: up_name,
          bio: "",
          followers: [],
          following: []
        }); } catch(e){ console.warn("set user doc error", e); }
        // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é
        try { await sendEmailVerification(cred.user); toast('–ü–∏—Å—å–º–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ email'); } catch(e){ /* ignore */ }
        toast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ (Firebase)');
      } catch (err) {
        console.error(err);
        toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (err.message || err.code));
      }
    } else {
      // fallback: –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
      if(window.STATE.users.find(u=>u.username===up_user)){ toast('–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –µ—Å—Ç—å (–ª–æ–∫–∞–ª—å–Ω–æ)'); return }
      const user = {
        id: uid(),
        username: up_user,
        password: up_pass,
        displayName: up_name,
        bio: '',
        avatar: '',
        followers: [],
        following: []
      };
      window.STATE.users.push(user);
      window.STATE.current = user;
      saveAll();
      toast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ (Firebase —Ç—Ä–µ–±—É–µ—Ç email –¥–ª—è –æ–±–ª–∞—á–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏). –í–≤–µ–¥–∏—Ç–µ email —Å @ —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–ª–∞—á–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.');
      showApp();
    }
  };

  // –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º actionLogin: –µ—Å–ª–∏ –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ email (—Å @) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º Firebase Auth
  window.actionLogin = async function() {
    const in_user = (document.getElementById('in_user')?.value || '').trim();
    const in_pass = (document.getElementById('in_pass')?.value || '').trim();
    if(!in_user || !in_pass){ toast('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω (email) –∏ –ø–∞—Ä–æ–ª—å'); return; }

    if(emailLike(in_user)) {
      try {
        const cred = await signInWithEmailAndPassword(auth, in_user, in_pass);
        // onAuthStateChanged –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–µ
        toast('–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Firebase –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ');
      } catch (err) {
        console.error(err);
        toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (err.message || err.code));
      }
    } else {
      // fallback to local
      const user = window.STATE.users.find(u=>u.username===in_user && u.password===in_pass);
      if(!user){ toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å (–ª–æ–∫–∞–ª—å–Ω–æ)'); return }
      window.STATE.current = user;
      saveAll();
      toast('–õ–æ–∫–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
      showApp();
    }
  };

  // –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º publishPost ‚Äî –ø—É–±–ª–∏–∫—É–µ–º –≤ Firestore, –∞ –Ω–µ –≤ localStorage
  window.publishPost = async function() {
    if(!window.STATE.current){ toast('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç'); return }
    const txt = document.getElementById('composerText');
    const preview = document.getElementById('composerPreview');
    if(!txt || !preview){ toast('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞'); return }
    const content = (txt.value || '').trim();
    if(!content && !preview.dataset.img){ toast('–ü—É—Å—Ç–æ–π –ø–æ—Å—Ç'); return }

    try {
      let mediaUrl = "";
      if(preview.dataset.img) {
        // –∑–∞–≥—Ä—É–∂–∞–µ–º –≤ Firebase Storage
        const filename = "posts/" + Date.now() + "_" + Math.random().toString(36).slice(2,10);
        const ref = storageRef(storage, filename);
        // uploadString expects base64 data URL
        await uploadString(ref, preview.dataset.img, 'data_url');
        mediaUrl = await getDownloadURL(ref);
      }
      // –ø–∏—à–µ–º doc –≤ posts
      const p = {
        author: window.STATE.current.username,
        authorName: window.STATE.current.displayName || window.STATE.current.username,
        authorUid: window.STATE.current.uid || null,
        text: content,
        media: mediaUrl,
        likes: [],
        comments: [],
        reposts: 0,
        createdAt: serverTimestamp()
      };
      await addDoc(collection(db, "posts"), p);
      // –æ—á–∏—Å—Ç–∏–º composer
      txt.value = '';
      preview.innerHTML = '';
      delete preview.dataset.img;
      const counter = document.getElementById('charsLeft'); if(counter) counter.textContent = 280;
      toast('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω (–≤ –æ–±–ª–∞–∫–µ)');
      // renderFeed will update automatically via onSnapshot
    } catch (err) {
      console.error("publishPost error", err);
      toast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + (err.message || err.code));
    }
  };

  // override toggleLike to use Firestore update
  window.toggleLike = async function(postId) {
    if(!window.STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return }
    try {
      const postDoc = doc(db, "posts", postId);
      // find local state to inspect whether liked
      const post = window.STATE.posts.find(p=>p.id===postId);
      const username = window.STATE.current.username;
      if(post && post.likes && post.likes.includes(username)) {
        await updateDoc(postDoc, { likes: arrayRemove(username) });
      } else {
        await updateDoc(postDoc, { likes: arrayUnion(username) });
      }
      // —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ onSnapshot
    } catch (err) {
      console.error("toggleLike error", err);
      toast('–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞');
    }
  };

  // override openComments to add comment to array in doc
  window.openComments = async function(postId) {
    if(!window.STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return }
    const text = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:');
    if(!text || !text.trim()) return;
    try {
      const postDoc = doc(db, "posts", postId);
      const commentObj = { id: "c"+Date.now(), user: window.STATE.current.username, text: text.trim(), createdAt: new Date().toISOString() };
      await updateDoc(postDoc, { comments: arrayUnion(commentObj) });
      toast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω');
    } catch (err) {
      console.error("openComments error", err);
      toast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
    }
  };

  // override follow to update Firestore users documents
  window.follow = async function(username, btn) {
    if(!window.STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return }
    if(window.STATE.current.username === username){ toast('–ù–µ–ª—å–∑—è –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ–±—è'); return }
    try {
      // find target user uid (from STATE.users)
      const target = window.STATE.users.find(u=>u.username===username);
      if(!target){ toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return }
      // need to find target user doc (by username)
      // search users collection for username
      const usersSnap = await getDocs(collection(db,"users"));
      let targetDoc = null;
      let myDoc = null;
      usersSnap.forEach(snap=>{
        const d = snap.data();
        if(d.username === username) targetDoc = { ref: doc(db,"users",snap.id), data: d };
        if(d.username === window.STATE.current.username) myDoc = { ref: doc(db,"users",snap.id), data: d };
      });
      if(!targetDoc || !myDoc) {
        toast('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ–±–ª–∞–∫–µ');
        return;
      }
      // toggle follow
      const meUsername = window.STATE.current.username;
      const already = (targetDoc.data.followers || []).includes(meUsername);
      if(already) {
        await updateDoc(targetDoc.ref, { followers: arrayRemove(meUsername) });
        await updateDoc(myDoc.ref, { following: arrayRemove(username) });
        if(btn) btn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
      } else {
        await updateDoc(targetDoc.ref, { followers: arrayUnion(meUsername) });
        await updateDoc(myDoc.ref, { following: arrayUnion(username) });
        if(btn) btn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è';
      }
      // refresh local users
      await loadUsersFromFirestore();
      toast('–ü–æ–¥–ø–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
    } catch (err) {
      console.error("follow error", err);
      toast('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏');
    }
  };

  // load users on start
  loadUsersFromFirestore().catch(e=>console.warn(e));
} else {
  console.warn("Firebase not initialized ‚Äî cloud features unavailable");
}

/* ======================
   –ö–æ–Ω–µ—Ü –º–æ–¥—É–ª—è Firebase
   ====================== */
</script>

</body>
</html>
