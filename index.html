<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Nova Prospect ‚Äî Messenger (username required)</title>

<!-- Minimal CSS with theme variables (light/dark) + modal styles -->
<style>
  :root{
    --bg:#0f1720; --panel:#11151a; --muted:#9aa5b1; --accent:#2b8cff; --bubble:#172027;
    --glass: rgba(255,255,255,0.03); --text:#e6eef6;
  }
  :root[data-theme="light"]{
    --bg: #f5f7fb;
    --panel: #ffffff;
    --muted: #6b7280;
    --accent: #1d4ed8;
    --bubble: #f3f6fb;
    --glass: rgba(0,0,0,0.03);
    --text: #0f1720;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, Roboto, Arial, sans-serif;background:var(--bg);color:var(--text)}
  .app{display:grid;grid-template-columns:280px 1fr 320px;grid-template-rows:64px 1fr;height:100vh;gap:8px;padding:8px;}
  .header{grid-column:1/-1;height:64px;background:var(--panel);display:flex;align-items:center;padding:12px;border-radius:8px}
  .brand{font-weight:700;margin-right:12px}
  .header .actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  img.avatar{width:40px;height:40px;border-radius:8px;object-fit:cover}

  .sidebar{background:var(--panel);border-radius:8px;padding:12px;overflow:auto}
  .contacts{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .contact{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
  .contact:hover{background:var(--glass)}
  .contact .name{font-weight:600}
  .searchRow{display:flex;gap:8px}

  .chatPanel{background:linear-gradient(180deg, transparent 0%, transparent 100%);border-radius:8px;display:flex;flex-direction:column;overflow:hidden}
  .chatHeader{height:64px;display:flex;align-items:center;padding:12px;border-bottom:1px solid rgba(0,0,0,0.06)}
  .chatBody{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  .msgRow{max-width:70%;display:flex;flex-direction:column;gap:6px}
  .msgRow.me{align-self:flex-end;text-align:right}
  .bubble{padding:10px 12px;border-radius:12px;background:var(--bubble);border:1px solid rgba(0,0,0,0.06);color:var(--text)}
  .bubble.img{padding:6px}
  .time{font-size:11px;color:var(--muted)}
  .composer{height:72px;border-top:1px solid rgba(0,0,0,0.06);display:flex;gap:8px;align-items:center;padding:10px}
  .input{flex:1;padding:10px;border-radius:10px;background:var(--panel);border:1px solid rgba(0,0,0,0.06);color:var(--text)}
  .btn{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:#fff}
  .rightPanel{background:var(--panel);border-radius:8px;padding:12px;overflow:auto}
  .small{font-size:13px;color:var(--muted)}
  .stickerBtn{background:transparent;border:1px solid rgba(0,0,0,0.04);padding:6px;border-radius:8px;cursor:pointer}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#222;padding:10px 14px;border-radius:8px;color:#fff;border:1px solid rgba(255,255,255,0.04)}
  @media (max-width:1000px){
    .app{grid-template-columns:1fr;grid-template-rows:64px auto 1fr;gap:8px}
    .rightPanel{display:none}
  }

  /* Modal for username */
  .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--panel);padding:20px;border-radius:10px;min-width:320px;max-width:420px}
  .modal h3{margin:0 0 8px 0}
  .modal .small{margin-bottom:8px}
  .input-inline{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text);margin-bottom:8px}
  .err{color:#ff7b7b;font-size:13px;margin-top:6px}
</style>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="app" id="app">
    <div class="header">
      <div class="brand">Nova Prospect</div>
      <div class="small">Single-file messenger</div>

      <div class="actions" id="authArea">
        <button id="loginBtn" class="btn">–í–æ–π—Ç–∏ —Å Google</button>
      </div>

      <div class="actions" id="userArea" style="display:none">
        <img id="meAvatar" class="avatar" src="" alt="me"/>
        <div style="display:flex;flex-direction:column;align-items:flex-end;margin-left:8px;">
          <!-- Display both displayName (Google) and username (app) -->
          <div id="meName" style="font-weight:700"></div>
          <div class="small" id="meUsername" style="margin-top:4px"></div>
          <div class="small" id="meEmail" style="margin-top:2px"></div>
        </div>

        <button id="themeToggleBtn" class="btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" style="margin-left:10px;display:none">üåì</button>

        <button id="logoutBtn" class="btn" style="margin-left:8px">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- Left: contacts/search -->
    <div class="sidebar">
      <div class="searchRow">
        <input id="usernameSearch" class="input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ username" />
        <button id="addBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div style="font-weight:700">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
        <div class="small">–æ–Ω–ª–∞–π–Ω</div>
      </div>

      <div class="contacts" id="contactsList"></div>

      <div style="margin-top:12px">
        <div class="small">–°—Ç–∏–∫–µ—Ä—ã</div>
        <div style="display:flex;gap:6px;margin-top:8px" id="stickersRow"></div>
      </div>
    </div>

    <!-- Center: chat -->
    <div class="chatPanel" id="chatPanel">
      <div class="chatHeader" id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç</div>
      <div class="chatBody" id="chatBody"></div>

      <div class="composer">
        <input id="msgInput" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <input id="fileInput" type="file" accept="image/*" style="display:none"/>
        <button id="attachBtn" class="btn">üìé</button>
        <button id="sendBtn" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- Right: info -->
    <div class="rightPanel" id="rightPanel">
      <div id="rightContent"><div class="small">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ</div></div>
    </div>
  </div>

  <!-- Username modal (hidden by default) -->
  <div id="usernameModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h3>–ü—Ä–∏–¥—É–º–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π username</h3>
      <div class="small">Username –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —Ç–µ–±—è –º–æ–≥–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–∑—å—è. –î–æ–ø—É—Å—Ç–∏–º—ã –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, "_" –∏ "-", –¥–ª–∏–Ω–∞ 3‚Äì20.</div>
      <input id="usernameField" class="input-inline" placeholder="username (–Ω–∞–ø—Ä–∏–º–µ—Ä: mark_ivan)" />
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="usernameCancel" class="btn">–í—ã–π—Ç–∏</button>
        <button id="usernameSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div id="usernameErr" class="err"></div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
/* ==========================
   Config (provided)
   ========================== */
const firebaseConfig = {
  apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
  authDomain: "nova-prospect-chat.firebaseapp.com",
  projectId: "nova-prospect-chat",
  storageBucket: "nova-prospect-chat.firebasestorage.app",
  messagingSenderId: "256806164650",
  appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
  measurementId: "G-9V0Q2E2FNB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ==========================
   DOM
   ========================== */
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authArea = document.getElementById('authArea');
const userArea = document.getElementById('userArea');
const meAvatar = document.getElementById('meAvatar');
const meName = document.getElementById('meName');
const meUsername = document.getElementById('meUsername');
const meEmail = document.getElementById('meEmail');
const themeToggleBtn = document.getElementById('themeToggleBtn');

const usernameSearch = document.getElementById('usernameSearch');
const addBtn = document.getElementById('addBtn');
const contactsList = document.getElementById('contactsList');

const chatHeader = document.getElementById('chatHeader');
const chatBody = document.getElementById('chatBody');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const attachBtn = document.getElementById('attachBtn');
const fileInput = document.getElementById('fileInput');
const rightContent = document.getElementById('rightContent');

const toastEl = document.getElementById('toast');
const stickersRow = document.getElementById('stickersRow');

const usernameModal = document.getElementById('usernameModal');
const usernameField = document.getElementById('usernameField');
const usernameSave = document.getElementById('usernameSave');
const usernameCancel = document.getElementById('usernameCancel');
const usernameErr = document.getElementById('usernameErr');

/* ==========================
   State
   ========================== */
let me = null;
let myDoc = null;
let userUnsub = null;
let messagesUnsub = null;
let selected = null;

const STICKERS = ['üòä','üëç','üî•','üéâ','üòÖ','ü§ò'];
STICKERS.forEach(s=>{
  const b = document.createElement('button'); b.className='stickerBtn'; b.textContent=s;
  b.onclick = ()=>sendSticker(s);
  stickersRow.appendChild(b);
});

/* ==========================
   Theme logic (unchanged)
   ========================== */
const isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/.test(navigator.userAgent);
const root = document.documentElement;
const prefersDarkMQ = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

function applyTheme(theme){ root.setAttribute('data-theme', theme === 'light' ? 'light' : 'dark'); }

function initTheme(){
  if(isMobile){
    const initial = prefersDarkMQ && prefersDarkMQ.matches ? 'dark' : 'light';
    applyTheme(initial);
    themeToggleBtn.style.display = 'none';
    if(prefersDarkMQ && prefersDarkMQ.addEventListener){
      prefersDarkMQ.addEventListener('change', e => {
        applyTheme(e.matches ? 'dark' : 'light');
        toast('–¢–µ–º–∞: ' + (e.matches ? '—Ç—ë–º–Ω–∞—è' : '—Å–≤–µ—Ç–ª–∞—è'));
      });
    } else if (prefersDarkMQ && prefersDarkMQ.addListener){
      prefersDarkMQ.addListener(e => {
        applyTheme(e.matches ? 'dark' : 'light');
        toast('–¢–µ–º–∞: ' + (e.matches ? '—Ç—ë–º–Ω–∞—è' : '—Å–≤–µ—Ç–ª–∞—è'));
      });
    }
  } else {
    themeToggleBtn.style.display = 'inline-block';
    const saved = localStorage.getItem('np_theme');
    if(saved === 'light' || saved === 'dark'){ applyTheme(saved); }
    else applyTheme('dark');
    themeToggleBtn.onclick = () => {
      const cur = root.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
      const next = cur === 'light' ? 'dark' : 'light';
      applyTheme(next);
      localStorage.setItem('np_theme', next);
      toast('–¢–µ–º–∞: ' + (next === 'light' ? '—Å–≤–µ—Ç–ª–∞—è' : '—Ç—ë–º–Ω–∞—è'));
    };
  }
}
initTheme();

/* ==========================
   Helpers
   ========================== */
function toast(msg, ms=3500){
  toastEl.textContent = msg; toastEl.style.display='block';
  clearTimeout(toastEl._t); toastEl._t = setTimeout(()=> toastEl.style.display='none', ms);
}
function safeLog(){ console.log.apply(console, arguments); }

/* ==========================
   Auth
   ========================== */
loginBtn.onclick = async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithPopup(provider);
  } catch(err){
    toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (err.message||err.code));
    console.error('auth err', err);
  }
};
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  location.reload();
};

auth.onAuthStateChanged(async user=>{
  if(user){
    me = user;
    authArea.style.display = 'none';
    userArea.style.display = 'flex';
    meAvatar.src = user.photoURL || '';
    meName.textContent = user.displayName || '';
    meEmail.textContent = user.email || '';
    await ensureUserDoc(user);
    // enforce username creation if needed
    await promptForUsernameIfNeeded();
    startUserListener(user.uid);
    renderContacts();
  } else {
    authArea.style.display = 'flex';
    userArea.style.display = 'none';
  }
});

/* ==========================
   Ensure user doc (no change to structure)
   ========================== */
async function ensureUserDoc(user){
  const ref = db.collection('users').doc(user.uid);
  const doc = await ref.get();
  if(!doc.exists){
    // create basic doc with temporary username (email prefix + random) ‚Äî but require the user to set their own username afterwards
    const basic = {
      uid: user.uid,
      username: (user.email||'user').split('@')[0] + '_' + Math.floor(Math.random()*900),
      email: user.email||'',
      photoURL: user.photoURL||'',
      friends: []
    };
    await ref.set(basic);
    myDoc = basic;
  } else {
    myDoc = doc.data();
  }
}

/* ==========================
   Check if username needs to be defined by user
   - If user doc doesn't exist OR username looks auto-generated (has trailing _digits),
     show modal and block usage until user saves a custom username.
   ========================== */
function looksAutoGenerated(username){
  if(!username) return true;
  // pattern like something_123 or random suffix created earlier
  return /_[0-9]{1,4}$/.test(username);
}

async function promptForUsernameIfNeeded(){
  // If myDoc is not ready, wait a bit (shouldn't happen)
  if(!myDoc) return;
  if(!myDoc.username || looksAutoGenerated(myDoc.username)){
    // show modal and block (we already hide nothing else, but we prevent showing username in header and prevent actions by checking this flag)
    usernameField.value = '';
    usernameErr.textContent = '';
    usernameModal.style.display = 'flex';
    // prevent interacting with main UI effectively ‚Äî rely on modal's presence and checks
    // Save handler
    const saveHandler = async () => {
      usernameErr.textContent = '';
      const val = (usernameField.value || '').trim();
      if(!val){ usernameErr.textContent = '–í–≤–µ–¥–∏—Ç–µ username'; return; }
      if(!/^[a-zA-Z0-9_\-]{3,20}$/.test(val)){
        usernameErr.textContent = '–î–æ–ø—É—Å—Ç–∏–º—ã –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, "_" –∏ "-", –¥–ª–∏–Ω–∞ 3‚Äì20';
        return;
      }
      try {
        // uniqueness check
        const q = await db.collection('users').where('username','==',val).get();
        if(!q.empty){
          // if the only document is the user's own doc, allow (case of rare same value)
          if(!(q.docs.length === 1 && q.docs[0].id === me.uid)){
            usernameErr.textContent = '–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç';
            return;
          }
        }
        // persist username to user's doc
        await db.collection('users').doc(me.uid).update({ username: val });
        myDoc.username = val;
        // update UI: show in header under name
        meUsername.textContent = '@' + val;
        toast('Username —Å–æ—Ö—Ä–∞–Ω—ë–Ω: @' + val, 4000);
        // hide modal and remove listeners
        usernameModal.style.display = 'none';
        usernameSave.removeEventListener('click', saveHandler);
        usernameCancel.removeEventListener('click', cancelHandler);
      } catch(err){
        console.error('username save err', err);
        usernameErr.textContent = '–û—à–∏–±–∫–∞: ' + (err.message||err.code);
      }
    };
    const cancelHandler = () => {
      // If user closes without username, sign them out ‚Äî enforced requirement
      usernameModal.style.display = 'none';
      usernameSave.removeEventListener('click', saveHandler);
      usernameCancel.removeEventListener('click', cancelHandler);
      toast('Username –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω. –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞.');
      auth.signOut();
    };
    usernameSave.addEventListener('click', saveHandler);
    usernameCancel.addEventListener('click', cancelHandler);
  } else {
    // show username in header
    meUsername.textContent = '@' + myDoc.username;
  }
}

/* ==========================
   User doc listener
   ========================== */
function startUserListener(uid){
  if(userUnsub) userUnsub();
  userUnsub = db.collection('users').doc(uid).onSnapshot(doc=>{
    if(doc.exists) {
      myDoc = doc.data();
      // ensure header username sync
      if(myDoc.username) meUsername.textContent = '@' + myDoc.username;
      renderContacts();
    }
  }, err=>{
    console.error('user listener err', err);
    toast('–û—à–∏–±–∫–∞ listeners: ' + (err.message||err.code));
  });
}

/* ==========================
   Render contacts
   ========================== */
async function renderContacts(){
  contactsList.innerHTML = '';
  if(!myDoc) return;
  const friends = myDoc.friends || [];
  if(friends.length === 0){
    contactsList.innerHTML = `<div class="small">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –¥–æ–±–∞–≤—å –ø–æ username</div>`;
    return;
  }
  const promises = friends.map(uid => db.collection('users').doc(uid).get().then(d=>d.exists?d.data():null));
  const results = await Promise.all(promises);
  results.filter(Boolean).forEach(f=>{
    const el = document.createElement('div'); el.className='contact';
    el.innerHTML = `<img src="${f.photoURL||''}" class="avatar" style="width:44px;height:44px;border-radius:8px"/><div><div class="name">${f.username||f.email}</div><div class="small">${f.email||''}</div></div>`;
    el.onclick = ()=>selectContact(f);
    contactsList.appendChild(el);
  });
}

/* ==========================
   Add friend
   ========================== */
addBtn.onclick = async ()=>{
  const username = (usernameSearch.value||'').trim();
  if(!username){ toast('–í–≤–µ–¥–∏—Ç–µ username'); return; }
  if(!me){ toast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
  // enforce that current user has username set
  if(!myDoc || !myDoc.username || looksAutoGenerated(myDoc.username)){
    toast('–°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–≤–æ–π username');
    return;
  }
  try {
    const q = await db.collection('users').where('username','==',username).get();
    if(q.empty){ toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    const target = q.docs[0].data();
    if(target.uid === me.uid){ toast('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è'); return; }
    if((myDoc.friends||[]).includes(target.uid)){}
    if((myDoc.friends||[]).includes(target.uid)){ toast('–£–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö'); return; }
    await db.collection('users').doc(me.uid).update({ friends: firebase.firestore.FieldValue.arrayUnion(target.uid) });
    usernameSearch.value = '';
    toast('–î–æ–±–∞–≤–ª–µ–Ω: ' + (target.username||target.email));
  } catch(err){
    console.error('add friend err', err);
    toast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + (err.message||err.code));
  }
};

/* ==========================
   Select contact & messages subscription (unchanged)
   ========================== */
function selectContact(friend){
  selected = friend;
  chatHeader.innerHTML = `<img src="${friend.photoURL||''}" class="avatar" style="width:44px;height:44px;margin-right:10px"/> <div style="font-weight:700">${friend.username||friend.email}</div>`;
  rightContent.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${friend.photoURL||''}" class="avatar" style="width:72px;height:72px;border-radius:10px"/><div><div style="font-weight:700">${friend.username}</div><div class="small">${friend.email||''}</div></div></div>`;
  if(messagesUnsub) messagesUnsub();
  messagesUnsub = db.collection('messages')
    .where('participants','array-contains', me.uid)
    .onSnapshot(snap=>{
      const msgs = [];
      snap.forEach(d=>{
        const data = d.data();
        if(!data.participants || !data.participants.includes(selected.uid)) return;
        msgs.push(Object.assign({id:d.id}, data));
      });
      msgs.sort((a,b)=>{
        const ta = (a.timestamp && a.timestamp.toDate) ? a.timestamp.toDate().getTime() : (a._localTime||0);
        const tb = (b.timestamp && b.timestamp.toDate) ? b.timestamp.toDate().getTime() : (b._localTime||0);
        return ta - tb;
      });
      renderMessages(msgs);
    }, err=>{
      console.error('messages listener err', err);
      if(err && err.message && err.message.toLowerCase().includes('index')){
        toast('Firestore: –∑–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–¥–µ–∫—Å. –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤ Console.');
      } else {
        toast('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + (err.message||err.code));
      }
    });
}

/* ==========================
   Render messages & senders (unchanged)
   ========================== */
function renderMessages(msgs){
  chatBody.innerHTML = '';
  if(msgs.length === 0){
    chatBody.innerHTML = `<div class="small">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>`;
    return;
  }
  for(const m of msgs){
    const row = document.createElement('div'); row.className='msgRow ' + (m.senderId===me.uid ? 'me':'');
    const bubble = document.createElement('div'); bubble.className='bubble';
    if(m.type === 'image' && m.mediaURL){
      const img = document.createElement('img'); img.src = m.mediaURL; img.style.maxWidth='360px'; img.style.borderRadius='8px';
      bubble.appendChild(img);
      if(m.text) { const t = document.createElement('div'); t.className='small'; t.textContent = m.text; bubble.appendChild(t); }
    } else if(m.type === 'sticker'){
      const s = document.createElement('div'); s.style.fontSize='28px'; s.textContent = m.text; bubble.appendChild(s);
    } else {
      bubble.textContent = m.text || '';
    }
    const time = document.createElement('div'); time.className='time';
    const ts = (m.timestamp && m.timestamp.toDate) ? m.timestamp.toDate() : null;
    time.textContent = ts ? ts.toLocaleString() : '';
    row.appendChild(bubble);
    row.appendChild(time);
    chatBody.appendChild(row);
  }
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* ==========================
   Sending messages (unchanged)
   ========================== */
sendBtn.onclick = async ()=>{
  const text = (msgInput.value||'').trim();
  if(!selected){ toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç'); return; }
  if(!text) return;
  await sendMessage({ text, type: 'text' });
  msgInput.value = '';
};

async function sendSticker(s){
  if(!selected){ toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç'); return; }
  await sendMessage({ text: s, type: 'sticker' });
}

attachBtn.onclick = ()=> fileInput.click();

fileInput.onchange = async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  if(!selected){ toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç'); return; }
  const path = `chat_images/${Date.now()}_${me.uid}_${file.name.replace(/\s/g,'_')}`;
  try {
    const ref = storage.ref().child(path);
    const snap = await ref.put(file);
    const url = await snap.ref.getDownloadURL();
    await sendMessage({ text: '', type: 'image', mediaURL: url });
    fileInput.value = '';
  } catch(err){
    console.error('upload err', err);
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (err.message||err.code));
  }
};

async function sendMessage({ text='', type='text', mediaURL=null }){
  // prevent sending if user hasn't set username
  if(!myDoc || !myDoc.username || looksAutoGenerated(myDoc.username)){
    toast('–°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–≤–æ–π username');
    return;
  }
  const payload = {
    text,
    senderId: me.uid,
    receiverId: selected.uid,
    participants: [me.uid, selected.uid],
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    type,
    mediaURL: mediaURL || null
  };
  try {
    await db.collection('messages').add(payload);
  } catch(err){
    console.error('sendMessage err', err);
    if(err && err.message && err.message.toLowerCase().includes('index')){
      toast('–û—à–∏–±–∫–∞: –∑–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–¥–µ–∫—Å–∞. –°–æ–∑–¥–∞–π—Ç–µ –∏–Ω–¥–µ–∫—Å –≤ Firestore Console.');
    } else if (err && err.code && err.code.includes('permission')){
      toast('–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ Firestore: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ security rules.');
    } else {
      toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (err.message||err.code));
    }
  }
}

/* ==========================
   Cleanup on unload
   ========================== */
window.addEventListener('beforeunload', ()=>{
  if(userUnsub) userUnsub();
  if(messagesUnsub) messagesUnsub();
});
</script>

<!--
  –ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
  - –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ (–∏–ª–∏ –µ—Å–ª–∏ username –≤—ã–≥–ª—è–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º),
    –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä–æ–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –¥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ username –Ω–µ –ø–æ–∑–≤–æ–ª–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —á–∞—Ç–æ–º.
  - –í –º–æ–¥–∞–ª–µ username –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ —Ñ–æ—Ä–º–∞—Ç –∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å.
  - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–π–¥–µ—Ç, –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏–≤ username, –æ–Ω –±—É–¥–µ—Ç —Ä–∞–∑–ª–æ–≥–∏–Ω–µ–Ω (–ø–æ –∫–Ω–æ–ø–∫–µ "–í—ã–π—Ç–∏" –≤ –º–æ–¥–∞–ª–µ).
  - –Ø –Ω–µ –º–µ–Ω—è–ª –æ—Å—Ç–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ security rules ‚Äî —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏–ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–¥–∞–Ω–∏—è username.
-->
</body>
</html>

