<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Messenger</title>
    <!-- Bootstrap –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≤—ë—Ä—Å—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; }
        #app { display: none; }
        .chat-container { max-width: 800px; margin: 20px auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .sidebar { border-right: 1px solid #ddd; height: 600px; overflow-y: auto; }
        .chat-area { height: 600px; display: flex; flex-direction: column; }
        .messages { flex-grow: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; }
        .message { margin-bottom: 10px; display: flex; }
        .message.sent { justify-content: flex-end; }
        .message .bubble { max-width: 70%; padding: 8px 12px; border-radius: 18px; background: white; }
        .message.sent .bubble { background: #dcf8c6; }
        .message img { max-width: 200px; max-height: 200px; border-radius: 10px; }
        .sticker { font-size: 48px; cursor: pointer; }
        .sticker:hover { opacity: 0.7; }
        #friendRequests .badge { margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container mt-5" id="login">
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <h1>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h1>
                <button id="googleSignIn" class="btn btn-primary btn-lg mt-3">
                    <i class="fab fa-google"></i> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                </button>
            </div>
        </div>
    </div>

    <div id="app">
        <div class="container-fluid chat-container">
            <div class="row">
                <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å: –ø—Ä–æ—Ñ–∏–ª—å, –¥—Ä—É–∑—å—è, –∑–∞–ø—Ä–æ—Å—ã -->
                <div class="col-md-4 sidebar p-3">
                    <div class="d-flex align-items-center mb-3">
                        <img id="userPhoto" src="" alt="" class="rounded-circle me-2" width="40" height="40">
                        <div>
                            <h5 id="userName"></h5>
                            <small id="userEmail"></small>
                        </div>
                        <button id="signOut" class="btn btn-sm btn-outline-secondary ms-auto">–í—ã–π—Ç–∏</button>
                    </div>

                    <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ username (–µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω) -->
                    <div id="usernameSection" class="mb-3">
                        <input type="text" id="usernameInput" class="form-control" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ username">
                        <button id="saveUsername" class="btn btn-success btn-sm mt-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>

                    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞ -->
                    <div class="input-group mb-3">
                        <input type="text" id="friendUsername" class="form-control" placeholder="Username –¥—Ä—É–≥–∞">
                        <button id="addFriend" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>

                    <!-- –í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã -->
                    <div id="friendRequests" class="mb-3"></div>

                    <!-- –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π -->
                    <h6>–î—Ä—É–∑—å—è</h6>
                    <div id="friendsList" class="list-group"></div>
                </div>

                <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
                <div class="col-md-8 p-0">
                    <div id="chatArea" class="chat-area">
                        <div class="bg-light p-2 border-bottom" id="chatHeader">
                            <strong>–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è</strong>
                        </div>
                        <div id="messages" class="messages"></div>
                        <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞, –µ—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞) -->
                        <div id="messageForm" class="p-2 border-top bg-light" style="display: none;">
                            <div class="input-group">
                                <input type="text" id="messageInput" class="form-control" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
                                <button id="sendMessage" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                                <button id="stickerBtn" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#stickerPanel">üòä</button>
                                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                                <button id="uploadImageBtn" class="btn btn-outline-secondary"><i class="fas fa-image"></i></button>
                            </div>
                            <!-- –ü–∞–Ω–µ–ª—å —Å–æ —Å—Ç–∏–∫–µ—Ä–∞–º–∏ (—Å–∫—Ä—ã—Ç–∞) -->
                            <div class="collapse mt-2" id="stickerPanel">
                                <div class="d-flex">
                                    <span class="sticker me-2" data-sticker="üëç">üëç</span>
                                    <span class="sticker me-2" data-sticker="‚ù§Ô∏è">‚ù§Ô∏è</span>
                                    <span class="sticker me-2" data-sticker="üòÇ">üòÇ</span>
                                    <span class="sticker me-2" data-sticker="üò¢">üò¢</span>
                                    <span class="sticker me-2" data-sticker="üéâ">üéâ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (modular) -->
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js",
                "firebase/storage": "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js"
            }
        }
    </script>

    <script type="module">
        // ---------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ----------
        import { initializeApp } from 'firebase/app';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, onSnapshot, addDoc, orderBy, serverTimestamp, arrayUnion, arrayRemove, getDocs, writeBatch, Timestamp } from 'firebase/firestore';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'firebase/storage';

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
  authDomain: "nova-prospect-chat.firebaseapp.com",
  projectId: "nova-prospect-chat",
  storageBucket: "nova-prospect-chat.firebasestorage.app",
  messagingSenderId: "256806164650",
  appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
  measurementId: "G-9V0Q2E2FNB"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        // ---------- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ----------
        let currentUser = null;
        let currentFriendId = null;      // –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥—Ä—É–≥ –¥–ª—è —á–∞—Ç–∞
        let currentFriendshipId = null;  // ID friendship —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥—Ä—É–≥–æ–º
        let unsubscribeFriends = null;
        let unsubscribeMessages = null;
        let unsubscribeRequests = null;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const loginDiv = document.getElementById('login');
        const appDiv = document.getElementById('app');
        const googleSignInBtn = document.getElementById('googleSignIn');
        const signOutBtn = document.getElementById('signOut');
        const userPhoto = document.getElementById('userPhoto');
        const userNameSpan = document.getElementById('userName');
        const userEmailSpan = document.getElementById('userEmail');
        const usernameSection = document.getElementById('usernameSection');
        const usernameInput = document.getElementById('usernameInput');
        const saveUsernameBtn = document.getElementById('saveUsername');
        const friendUsernameInput = document.getElementById('friendUsername');
        const addFriendBtn = document.getElementById('addFriend');
        const friendsListDiv = document.getElementById('friendsList');
        const friendRequestsDiv = document.getElementById('friendRequests');
        const chatHeader = document.getElementById('chatHeader');
        const messagesDiv = document.getElementById('messages');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessage');
        const uploadImageBtn = document.getElementById('uploadImageBtn');
        const imageUpload = document.getElementById('imageUpload');
        const stickerBtn = document.getElementById('stickerBtn');
        const stickerPanel = document.getElementById('stickerPanel');

        // ---------- –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ----------
        googleSignInBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
            }
        });

        signOutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginDiv.style.display = 'none';
                appDiv.style.display = 'block';

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                userPhoto.src = user.photoURL || '';
                userNameSpan.textContent = user.displayName || '–ë–µ–∑ –∏–º–µ–Ω–∏';
                userEmailSpan.textContent = user.email;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Firestore, –∏ –µ—Å—Ç—å –ª–∏ username
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    // –°–æ–∑–¥–∞—ë–º –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await setDoc(userRef, {
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        username: '',
                        createdAt: serverTimestamp()
                    });
                    usernameSection.style.display = 'block';
                } else {
                    const userData = userSnap.data();
                    if (!userData.username) {
                        usernameSection.style.display = 'block';
                    } else {
                        usernameSection.style.display = 'none';
                        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã–µ –æ –¥—Ä—É–∑—å—è—Ö
                        loadFriendsAndRequests();
                    }
                }
            } else {
                currentUser = null;
                loginDiv.style.display = 'block';
                appDiv.style.display = 'none';
                // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
                if (unsubscribeFriends) unsubscribeFriends();
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeRequests) unsubscribeRequests();
            }
        });

        // ---------- –°–û–•–†–ê–ù–ï–ù–ò–ï USERNAME ----------
        saveUsernameBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            if (!username) {
                alert('–í–≤–µ–¥–∏—Ç–µ username');
                return;
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
            const usersRef = collection(db, 'users');
            const q = query(usersRef, where('username', '==', username));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                alert('–¢–∞–∫–æ–π username —É–∂–µ –∑–∞–Ω—è—Ç');
                return;
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            await updateDoc(doc(db, 'users', currentUser.uid), { username });
            usernameSection.style.display = 'none';
            loadFriendsAndRequests();
        });

        // ---------- –ó–ê–ì–†–£–ó–ö–ê –î–†–£–ó–ï–ô –ò –ó–ê–ü–†–û–°–û–í (real-time) ----------
        function loadFriendsAndRequests() {
            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ accepted –¥—Ä—É–∑–µ–π
            const friendshipsRef = collection(db, 'friendships');
            const qFriends = query(friendshipsRef, where('participants', 'array-contains', currentUser.uid), where('status', '==', 'accepted'));
            unsubscribeFriends = onSnapshot(qFriends, (snapshot) => {
                const friendIds = [];
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const otherUid = data.participants.find(uid => uid !== currentUser.uid);
                    friendIds.push(otherUid);
                });
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥—Ä—É–∑—å—è—Ö
                loadFriendsData(friendIds);
            });

            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã (pending –∏ requester != currentUser)
            const qRequests = query(friendshipsRef, where('participants', 'array-contains', currentUser.uid), where('status', '==', 'pending'), where('requester', '!=', currentUser.uid));
            unsubscribeRequests = onSnapshot(qRequests, (snapshot) => {
                displayFriendRequests(snapshot.docs);
            });
        }

        async function loadFriendsData(friendIds) {
            if (friendIds.length === 0) {
                friendsListDiv.innerHTML = '<p class="text-muted">–ù–µ—Ç –¥—Ä—É–∑–µ–π</p>';
                return;
            }
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const usersData = [];
            for (const uid of friendIds) {
                const userSnap = await getDoc(doc(db, 'users', uid));
                if (userSnap.exists()) {
                    usersData.push({ id: uid, ...userSnap.data() });
                }
            }
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º
            friendsListDiv.innerHTML = '';
            usersData.forEach(user => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action d-flex align-items-center';
                btn.innerHTML = `
                    <img src="${user.photoURL || ''}" class="rounded-circle me-2" width="30" height="30">
                    <span>${user.displayName || user.username || user.email}</span>
                `;
                btn.onclick = () => selectFriend(user.id, user.displayName || user.username || user.email);
                friendsListDiv.appendChild(btn);
            });
        }

        function displayFriendRequests(requests) {
            if (requests.length === 0) {
                friendRequestsDiv.innerHTML = '';
                return;
            }
            let html = '<h6>–ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è <span class="badge bg-danger">'+requests.length+'</span></h6>';
            requests.forEach(async (docSnap) => {
                const data = docSnap.data();
                const requesterUid = data.requester;
                const userSnap = await getDoc(doc(db, 'users', requesterUid));
                if (userSnap.exists()) {
                    const user = userSnap.data();
                    html += `
                        <div class="alert alert-info p-2 mb-2 d-flex justify-content-between align-items-center">
                            <span>${user.displayName || user.username || user.email}</span>
                            <button class="btn btn-sm btn-success accept-request" data-friendship="${docSnap.id}">–ü—Ä–∏–Ω—è—Ç—å</button>
                        </div>
                    `;
                }
            });
            friendRequestsDiv.innerHTML = html;
            document.querySelectorAll('.accept-request').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const friendshipId = e.target.dataset.friendship;
                    acceptFriendRequest(friendshipId);
                });
            });
        }

        // ---------- –ü–†–ò–ù–Ø–¢–¨ –ó–ê–ü–†–û–° ----------
        async function acceptFriendRequest(friendshipId) {
            await updateDoc(doc(db, 'friendships', friendshipId), { status: 'accepted' });
        }

        // ---------- –î–û–ë–ê–í–ò–¢–¨ –î–†–£–ì–ê –ü–û USERNAME ----------
        addFriendBtn.addEventListener('click', async () => {
            const username = friendUsernameInput.value.trim();
            if (!username) return;

            // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const usersRef = collection(db, 'users');
            const q = query(usersRef, where('username', '==', username));
            const snap = await getDocs(q);
            if (snap.empty) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            const friendUser = snap.docs[0].data();
            const friendUid = snap.docs[0].id;

            if (friendUid === currentUser.uid) {
                alert('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥—Ä—É–∑—å—è –ª–∏ —É–∂–µ
            const participants = [currentUser.uid, friendUid].sort();
            const friendshipId = participants.join('_');
            const friendshipRef = doc(db, 'friendships', friendshipId);
            const friendshipSnap = await getDoc(friendshipRef);
            if (friendshipSnap.exists()) {
                alert('–ó–∞–ø—Ä–æ—Å —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–ª–∏ –≤—ã —É–∂–µ –¥—Ä—É–∑—å—è');
                return;
            }

            // –°–æ–∑–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å
            await setDoc(friendshipRef, {
                participants,
                status: 'pending',
                requester: currentUser.uid,
                createdAt: serverTimestamp()
            });

            friendUsernameInput.value = '';
            alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        });

        // ---------- –í–´–ë–û–† –î–†–£–ì–ê –î–õ–Ø –ß–ê–¢–ê ----------
        async function selectFriend(friendId, friendName) {
            currentFriendId = friendId;
            chatHeader.innerHTML = `<strong>–ß–∞—Ç —Å ${friendName}</strong>`;
            messageForm.style.display = 'block';

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º friendshipId
            const participants = [currentUser.uid, friendId].sort();
            currentFriendshipId = participants.join('_');

            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (unsubscribeMessages) unsubscribeMessages();

            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            const messagesRef = collection(db, 'friendships', currentFriendshipId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                messagesDiv.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    displayMessage(msg);
                });
                // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // ---------- –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ----------
        function displayMessage(msg) {
            const isSent = msg.senderId === currentUser.uid;
            const div = document.createElement('div');
            div.className = `message ${isSent ? 'sent' : ''}`;
            let content = '';
            if (msg.text) {
                content = `<div class="bubble">${msg.text}</div>`;
            } else if (msg.imageUrl) {
                content = `<div class="bubble"><img src="${msg.imageUrl}" alt="image"></div>`;
            } else if (msg.sticker) {
                content = `<div class="bubble sticker">${msg.sticker}</div>`;
            }
            div.innerHTML = content;
            messagesDiv.appendChild(div);
        }

        // ---------- –û–¢–ü–†–ê–í–ö–ê –¢–ï–ö–°–¢–û–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø ----------
        sendMessageBtn.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text || !currentFriendshipId) return;
            await addDoc(collection(db, 'friendships', currentFriendshipId, 'messages'), {
                senderId: currentUser.uid,
                text,
                timestamp: serverTimestamp()
            });
            messageInput.value = '';
        });

        // ---------- –û–¢–ü–†–ê–í–ö–ê –°–¢–ò–ö–ï–†–ê ----------
        stickerPanel.addEventListener('click', async (e) => {
            if (e.target.classList.contains('sticker')) {
                const sticker = e.target.dataset.sticker;
                if (!currentFriendshipId) return;
                await addDoc(collection(db, 'friendships', currentFriendshipId, 'messages'), {
                    senderId: currentUser.uid,
                    sticker,
                    timestamp: serverTimestamp()
                });
            }
        });

        // ---------- –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ----------
        uploadImageBtn.addEventListener('click', () => imageUpload.click());
        imageUpload.addEventListener('change', async () => {
            const file = imageUpload.files[0];
            if (!file || !currentFriendshipId) return;

            const storageRef = ref(storage, `chat_images/${currentFriendshipId}/${Date.now()}_${file.name}`);
            await uploadBytes(storageRef, file);
            const imageUrl = await getDownloadURL(storageRef);

            await addDoc(collection(db, 'friendships', currentFriendshipId, 'messages'), {
                senderId: currentUser.uid,
                imageUrl,
                timestamp: serverTimestamp()
            });

            imageUpload.value = '';
        });

        // ---------- –û–¢–ü–†–ê–í–ö–ê –ü–û ENTER ----------
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessageBtn.click();
        });

    </script>

    <!-- ========== –ü–†–ê–í–ò–õ–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò FIRESTORE ========== 
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: —á—Ç–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º, –∑–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É
        match /users/{userId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && request.auth.uid == userId;
        }
        // –î—Ä—É–∂–±—ã: –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        match /friendships/{friendship} {
          allow read, write: if request.auth != null && 
            request.auth.uid in resource.data.participants;
          // –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ - —Ç–µ–∫—É—â–∏–π –∏ –¥—Ä—É–≥–æ–π
          allow create: if request.auth != null && 
            request.resource.data.participants.size() == 2 &&
            request.auth.uid in request.resource.data.participants;
        }
        // –°–æ–æ–±—â–µ–Ω–∏—è –≤ –¥—Ä—É–∂–±–µ
        match /friendships/{friendship}/messages/{message} {
          allow read, write: if request.auth != null && 
            exists(/databases/$(database)/documents/friendships/$(friendship)) &&
            request.auth.uid in get(/databases/$(database)/documents/friendships/$(friendship)).data.participants;
        }
      }
    }
    ========== –ü–†–ê–í–ò–õ–ê STORAGE ==========
    rules_version = '2';
    service firebase.storage {
      match /b/{bucket}/o {
        match /chat_images/{friendshipId}/{fileName} {
          allow read: if request.auth != null;
          allow write: if request.auth != null && 
            friendshipId.split('_').hasAny([request.auth.uid]);
        }
      }
    }
    -->
</body>
</html>
