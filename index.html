<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nova Prospect ‚Äî Chat (Telegram style, purple dark)</title>

<style>
  :root{
    --bg-main: #0f0c16;
    --bg-sidebar: #141018;
    --bg-chat: #121018;
    --accent: #7c4dff;
    --accent-2: #5e35b1;
    --muted: #9aa0c3;
    --text: #e9e6f7;
    --bubble-me: #f3e8ff;
    --bubble-other: #1f1a2b;
    --bubble-other-text: #ffffff;
    --max-width:1200px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg-main);font-family:Inter,Segoe UI,Arial,sans-serif;color:var(--text)}
  .app{max-width:var(--max-width);margin:8px auto;height:calc(100vh - 16px);display:flex;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,var(--bg-main),#0b0910);box-shadow:0 8px 40px rgba(0,0,0,0.6)}
  /* Sidebar */
  .sidebar{width:96px;background:var(--bg-sidebar);display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,0.03)}
  .sidebar-top{padding:8px;display:flex;flex-direction:column;align-items:center;gap:8px}
  .logo-circle{width:52px;height:52;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:white}
  .sidebar-search{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02); width:100%}
  .search-compact{width:100%;padding:8px;border-radius:10px;border:0;background:#1a1624;color:var(--text);outline:none;font-size:13px}
  .avatars-col{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:12px;align-items:center}
  .avatar-btn{width:56px;height:56;border-radius:50%;background:#241f2b;border:2px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
  .avatar-img{width:100%;height:100%;border-radius:50%;object-fit:cover}
  .avatar-badge{position:absolute;right:-2px;bottom:-2px;background:#ff3b30;color:white;font-size:12px;padding:3px 6px;border-radius:14px;border:2px solid var(--bg-sidebar)}
  .sidebar-footer{padding:10px;display:flex;flex-direction:column;gap:8px;align-items:center;border-top:1px solid rgba(255,255,255,0.02)}
  .small{font-size:13px;color:var(--muted)}
  .ghost-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text);padding:8px;border-radius:10px;cursor:pointer}

  /* Main left panel (expanded) */
  .left-panel{width:320px;background:var(--bg-chat);display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,0.02)}
  .left-top{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .left-logo{width:44px;height:44;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  .left-search{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .search-input{width:100%;padding:10px;border-radius:12px;border:0;background:#141018;color:var(--text);outline:none}
  .chat-list{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
  .chat-row{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;cursor:pointer}
  .chat-row:hover{background:rgba(124,77,255,0.06)}
  .chat-row.active{background:linear-gradient(90deg, rgba(124,77,255,0.09), rgba(94,53,177,0.04))}
  .chat-name{font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chat-sub{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .unread-pill{background:#ff3b30;color:white;padding:4px 8px;border-radius:12px;font-size:12px}

  /* Main chat area */
  .main{flex:1;display:flex;flex-direction:column;background:linear-gradient(180deg,#0b0910,#0f0c16)}
  .main-header{display:flex;align-items:center;gap:12px;padding:14px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .main-avatar{width:48px;height:48;border-radius:12px;object-fit:cover;border:2px solid rgba(255,255,255,0.02)}
  .main-title{font-weight:800;color:var(--text)}
  .main-sub{font-size:13px;color:var(--muted)}
  .messages{flex:1;padding:20px;overflow:auto}
  .message-row{display:flex;margin-bottom:12px;align-items:flex-end}
  .message-row.me{justify-content:flex-end}
  .bubble{max-width:70%;padding:10px 14px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
  .bubble.me{background:linear-gradient(180deg,var(--bubble-me),#f4e9ff);color:#0b0b0b;border-bottom-right-radius:6px}
  .bubble.other{background:var(--bubble-other);color:var(--bubble-other-text);border-bottom-left-radius:6px}
  .msg-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .msg-img{max-width:320px;border-radius:10px;display:block}
  .msg-audio{display:block;width:240px}
  .composer{padding:12px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,#0f0c16,#0b0910)}
  .composer .actions{display:flex;gap:8px;align-items:center}
  .composer textarea{flex:1;min-height:46px;max-height:160px;padding:12px;border-radius:12px;border:0;background:#0b0810;color:var(--text);outline:none;resize:none}
  .icon-btn{width:44px;height:44;border-radius:10px;border:0;background:#111014;color:var(--text);display:flex;align-items:center;justify-content:center;cursor:pointer}
  .send-btn{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:white;border-radius:12px;padding:10px 14px;border:0;cursor:pointer;font-weight:700}

  /* Notifications permission UI */
  .notify-perm{padding:8px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:700;border:0;cursor:pointer}

  /* Responsive: on small screens show left-panel collapsed like WhatsApp */
  @media (max-width:900px){
    .app{flex-direction:column;height:100vh;margin:0;border-radius:0}
    .sidebar{display:flex;flex-direction:row;height:64px;width:100%}
    .left-panel{width:100%;height:calc(100vh - 64px);order:1}
    .main{height:100%;order:2}
    .avatars-col{flex-direction:row;overflow:auto;padding:8px}
    .sidebar-footer{display:none}
    .sidebar-top{display:flex;flex-direction:row;align-items:center}
  }
  @media (max-width:480px){
    .left-panel{width:100%}
    .chat-row{padding:8px}
    .bubble{max-width:82%}
  }
</style>
</head>
<body>

<div class="app">
  <!-- narrow left icon column (desktop) -->
  <div class="sidebar" id="sidebarIcons">
    <div class="sidebar-top">
      <div class="logo-circle">NP</div>
    </div>

    <div class="avatars-col" id="avatarsCol">
      <!-- avatars stack -->
      <!-- populated by JS (recent threads owners) -->
    </div>

    <div class="sidebar-footer">
      <button id="openLeftPanelBtn" class="ghost-btn" title="–û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤">‚â°</button>
    </div>
  </div>

  <!-- expanded left panel (like Telegram list) -->
  <div class="left-panel" id="leftPanel">
    <div class="left-top">
      <div class="left-logo">NP</div>
      <div style="flex:1">
        <div style="font-weight:800;color:var(--text)">Nova Prospect</div>
        <div class="small">–ë—ã—Å—Ç—Ä—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div>
      </div>
      <button id="notifToggle" class="ghost-btn" title="–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">üîî</button>
    </div>

    <div class="left-search">
      <input id="globalSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ username...">
    </div>

    <div class="chat-list" id="chatsList">
      <!-- chat rows -->
    </div>

    <div style="padding:12px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center;">
      <div id="authBlock" style="flex:1"></div>
      <button id="newChatBtn" class="ghost-btn">–ù–æ–≤—ã–π</button>
    </div>
  </div>

  <!-- main chat area -->
  <div class="main">
    <div class="main-header" id="mainHeader">
      <img id="peerAvatar" class="main-avatar" src="https://via.placeholder.com/48?text=?" alt="avatar">
      <div style="flex:1">
        <div id="peerName" class="main-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
        <div id="peerSub" class="main-sub">@username</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="searchInChat" class="icon-btn" title="–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ">üîé</button>
        <button id="moreBtn" class="icon-btn" title="–ï—â—ë">‚ãØ</button>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <div class="actions">
        <input id="imageInput" type="file" accept="image/*" style="display:none">
        <button id="imageBtn" class="icon-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
        <button id="recordBtn" class="icon-btn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å">üéôÔ∏è</button>
      </div>

      <textarea id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)"></textarea>

      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="sendBtn" class="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase v12 modules -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc, getDocs, runTransaction, where, limit
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

  // --- Firebase config (—Ç–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è) ---
  const firebaseConfig = {
    apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
    authDomain: "nova-prospect-chat.firebaseapp.com",
    projectId: "nova-prospect-chat",
    storageBucket: "nova-prospect-chat.firebasestorage.app",
    messagingSenderId: "256806164650",
    appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
    measurementId: "G-9V0Q2E2FNB"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // --- UI refs ---
  const avatarsCol = document.getElementById('avatarsCol');
  const leftPanel = document.getElementById('leftPanel');
  const openLeftPanelBtn = document.getElementById('openLeftPanelBtn');
  const chatsList = document.getElementById('chatsList');
  const globalSearch = document.getElementById('globalSearch');
  const authBlock = document.getElementById('authBlock');
  const newChatBtn = document.getElementById('newChatBtn');
  const notifToggle = document.getElementById('notifToggle');

  const peerAvatar = document.getElementById('peerAvatar');
  const peerName = document.getElementById('peerName');
  const peerSub = document.getElementById('peerSub');

  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  const imageBtn = document.getElementById('imageBtn');
  const imageInput = document.getElementById('imageInput');
  const recordBtn = document.getElementById('recordBtn');

  // --- small utilities for unread & notifications ---
  const threadMsgUnsubs = {}; // threadId -> unsubscribe function for last-message listener
  const unreadCounts = {}; // threadId -> number
  const lastSeenLocalKey = 'np_lastseen_v1'; // store map threadId->timestamp
  function getLastSeenMap(){ try { return JSON.parse(localStorage.getItem(lastSeenLocalKey)||'{}'); } catch(e){ return {}; } }
  function setLastSeen(threadId, ts){ const m=getLastSeenMap(); m[threadId]=ts; localStorage.setItem(lastSeenLocalKey, JSON.stringify(m)); unreadCounts[threadId]=0; renderThreadBadge(threadId); }

  // play short beep using WebAudio
  function playNotificationSound(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type='sine';
      o.frequency.value=880;
      g.gain.value=0.08;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
    }catch(e){ /* ignore */ }
  }

  // request and show desktop notification
  async function showDesktopNotification(title, body, icon){
    if (("Notification" in window) && Notification.permission === "granted") {
      try {
        const n = new Notification(title, { body, icon });
        n.onclick = () => window.focus();
      } catch(e){ console.warn(e); }
    }
  }

  // toggle left panel visibility on narrow screens
  openLeftPanelBtn.onclick = () => {
    leftPanel.style.display = leftPanel.style.display === 'none' ? 'flex' : 'none';
  };

  // Request notification permission when clicking notifToggle
  notifToggle.onclick = async () => {
    if (!("Notification" in window)) return alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
    if (Notification.permission === 'default') {
      const p = await Notification.requestPermission();
      if (p === 'granted') alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã ‚Äî –Ω–µ –∑–∞–±—É–¥—å —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ');
      else alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã');
    } else if (Notification.permission === 'granted') {
      alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã');
    } else {
      alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞.');
    }
  };

  // --- auth UI (simple) - preserve original logic but render in authBlock ---
  function renderAuthUI(user) {
    authBlock.innerHTML = '';
    if (!user) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <input id="email" placeholder="Email" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#0b0810;color:var(--text)">
        <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#0b0810;color:var(--text)">
        <input id="signupUsername" placeholder="username (–ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#0b0810;color:var(--text)">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="googleSignIn" class="ghost-btn">Google</button>
          <button id="emailSignUp" class="ghost-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
      `;
      authBlock.appendChild(wrapper);
      document.getElementById('googleSignIn').onclick = async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch(e){ alert(e.message); }
      };
      document.getElementById('emailSignUp').onclick = async () => {
        const email = wrapper.querySelector('#email').value.trim();
        const pass = wrapper.querySelector('#password').value;
        const desired = wrapper.querySelector('#signupUsername').value.trim().toLowerCase();
        if (!email || !pass) return alert('Email –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
        try {
          const uc = await createUserWithEmailAndPassword(auth, email, pass);
          if (desired) {
            try { await createUsernameForUid(desired, uc.user.uid, email.split('@')[0]); }
            catch(err){ console.warn(err); alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: username –Ω–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω ('+err+')'); }
          }
          alert('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
        } catch(e){ alert(e.message); }
      };
    } else {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center">
          <img src="${user.photoURL||'https://via.placeholder.com/48?text=?'}" style="width:48px;height:48px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.03)">
          <div style="min-width:0">
            <div style="font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${user.displayName||'(–±–µ–∑ –∏–º–µ–Ω–∏)'}</div>
            <div class="small">${user.email||''}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="signOut" class="ghost-btn">–í—ã–π—Ç–∏</button>
        </div>
      `;
      authBlock.appendChild(wrapper);
      document.getElementById('signOut').onclick = async () => {
        if (unsubscribeThreadsAll) unsubscribeThreadsAll();
        if (unsubscribeThreads) unsubscribeThreads();
        await signOut(auth);
      };
    }
  }

  // --- username helpers (preserve original) ---
  import { runTransaction as rT } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  async function createUsernameForUid(usernameRaw, uid, displayName = null) {
    const username = sanitizeUsername(usernameRaw);
    if (!username) throw '–ù–µ–≤–µ—Ä–Ω—ã–π username';
    const unameRef = doc(db, 'usernames', username);
    const profileRef = doc(db, 'profiles', uid);
    try {
      await runTransaction(db, async (tx) => {
        const unameSnap = await tx.get(unameRef);
        if (unameSnap.exists()) throw new Error('USERNAME_TAKEN');
        tx.set(unameRef, { owner: uid, createdAt: serverTimestamp() });
        tx.set(profileRef, { username, displayName: displayName || null, updatedAt: serverTimestamp() }, { merge: true });
      });
      return true;
    } catch (e) {
      if (String(e).includes('USERNAME_TAKEN')) throw '–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç';
      throw e.message || e;
    }
  }
  function sanitizeUsername(s) { if (!s) return null; const low = s.toLowerCase(); if (!/^[a-z0-9_]{3,32}$/.test(low)) return null; return low; }

  // --- threads list (recent chats) with avatar column and unread handling ---
  let unsubscribeThreads = null;
  let unsubscribeThreadsAll = null; // to unsubscribe per-thread listeners for notifications
  async function subscribeMyThreads(uid) {
    // cleanup previous listeners
    if (unsubscribeThreads) unsubscribeThreads();
    // also cleanup per-thread listeners
    if (unsubscribeThreadsAll) unsubscribeThreadsAll();

    const q = query(collection(db, 'dmThreads'), where('participants', 'array-contains', uid), orderBy('createdAt', 'desc'));
    unsubscribeThreads = onSnapshot(q, async (snap) => {
      chatsList.innerHTML = '';
      avatarsCol.innerHTML = '';
      if (snap.empty) {
        chatsList.innerHTML = '<div class="small" style="padding:12px;color:var(--muted)">–ù–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–π–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—á–Ω–∏ –¥–∏–∞–ª–æ–≥.</div>';
        return;
      }

      // maintain per-thread last-message listeners for notifications
      const perThreadUnsubs = [];
      for (const docSnap of snap.docs) {
        const data = docSnap.data();
        const threadId = docSnap.id;
        const otherUid = data.participants.find(x => x !== uid);
        const profileSnap = await getDoc(doc(db, 'profiles', otherUid));
        const profile = profileSnap.exists() ? profileSnap.data() : {};
        const lastText = data.lastMessageText || '';

        // render list row
        const el = document.createElement('div');
        el.className = 'chat-row';
        el.id = 'chatrow_' + threadId;
        el.innerHTML = `
          <img src="${profile.photoURL||'https://via.placeholder.com/48?text=?'}" class="avatar" style="width:56px;height:56;border-radius:12px">
          <div style="flex:1;min-width:0">
            <div class="chat-name">${profile.username||profile.displayName||otherUid}</div>
            <div class="chat-sub">${lastText || '–ù–æ–≤—ã–π —á–∞—Ç'}</div>
          </div>
          <div id="badge_${threadId}"></div>
        `;
        el.onclick = () => {
          openDirectChat({ uid: otherUid, username: profile.username, displayName: profile.displayName, photoURL: profile.photoURL });
          // mark as read locally
          setLastSeen(threadId, Date.now());
        };
        chatsList.appendChild(el);

        // add avatar button in narrow icons column
        const a = document.createElement('div');
        a.className = 'avatar-btn';
        a.innerHTML = `<img src="${profile.photoURL||'https://via.placeholder.com/48?text=?'}" class="avatar-img">`;
        a.onclick = () => { el.click(); };
        const badgeWrap = document.createElement('div'); badgeWrap.id = 'avatar_badge_' + threadId;
        a.appendChild(badgeWrap);
        avatarsCol.appendChild(a);

        // subscribe to last message of this thread to detect incoming messages -> notification
        const msgsCol = collection(db, 'dmThreads', threadId, 'messages');
        const qLast = query(msgsCol, orderBy('createdAt', 'desc'), limit(1));
        const unsub = onSnapshot(qLast, (msnap) => {
          msnap.forEach(mdoc => {
            const m = mdoc.data();
            // if message from other user and newer than lastSeen -> unread & notify
            if (m.senderId !== uid) {
              const lastSeenMap = getLastSeenMap();
              const lastSeen = lastSeenMap[threadId] || 0;
              const createdTs = m.createdAt && m.createdAt.toMillis ? m.createdAt.toMillis() : Date.now();
              if (createdTs > lastSeen) {
                unreadCounts[threadId] = (unreadCounts[threadId] || 0) + 1;
                renderThreadBadge(threadId);
                // desktop notification + sound
                const title = (m.displayName || '–°–æ–æ–±—â–µ–Ω–∏–µ');
                const body = m.type === 'text' ? m.text : (m.type === 'image' ? '–§–æ—Ç–æ' : '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                playNotificationSound();
                showDesktopNotification(title, body, profile.photoURL || undefined);
              }
            }
          });
        }, (err) => console.warn('last message sub err', err));
        perThreadUnsubs.push(unsub);
      }

      // store ability to unsubscribe all per-thread listeners
      unsubscribeThreadsAll = () => perThreadUnsubs.forEach(u => u && u());
    }, (err) => {
      console.warn('threads sub err', err);
    });
  }

  function renderThreadBadge(threadId){
    const badge = document.getElementById('badge_' + threadId);
    const avBadge = document.getElementById('avatar_badge_' + threadId);
    const count = unreadCounts[threadId] || 0;
    if (badge) badge.innerHTML = count ? `<div class="unread-pill">${count}</div>` : '';
    if (avBadge) avBadge.innerHTML = count ? `<div class="avatar-badge">${count}</div>` : '';
  }

  // --- search by username (globalSearch) ---
  globalSearch.oninput = debounce(async (e) => {
    const q = e.target.value.trim().toLowerCase();
    chatsList.innerHTML = '<div class="small" style="padding:12px;color:var(--muted)">–ü–æ–∏—Å–∫...</div>';
    if (!q) {
      const user = auth.currentUser;
      if (user) subscribeMyThreads(user.uid);
      return;
    }
    try {
      const unameSnap = await getDoc(doc(db, 'usernames', q));
      chatsList.innerHTML = '';
      if (unameSnap.exists()) {
        const owner = unameSnap.data().owner;
        const prof = (await getDoc(doc(db, 'profiles', owner))).data() || {};
        const el = document.createElement('div');
        el.className = 'chat-row';
        el.innerHTML = `
          <img src="${prof.photoURL||'https://via.placeholder.com/48?text=?'}" class="avatar" style="width:56px;height:56;border-radius:12px">
          <div style="flex:1;min-width:0">
            <div class="chat-name">${prof.displayName||q}</div>
            <div class="chat-sub small">@${q}</div>
          </div>
          <div></div>
        `;
        el.onclick = () => openDirectChat({ uid: owner, username: q, displayName: prof.displayName, photoURL: prof.photoURL });
        chatsList.appendChild(el);
      } else {
        chatsList.innerHTML = '<div class="small" style="padding:12px;color:var(--muted)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      }
    } catch (err) {
      console.warn(err); chatsList.innerHTML = '<div class="small" style="padding:12px;color:var(--muted)">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
    }
  }, 350);

  // --- DM thread helpers (preserve original) ---
  function threadIdFor(u1, u2){ const ids=[u1,u2].sort(); return ids[0] + '_' + ids[1]; }
  let unsubscribeMessages = null;
  let currentPeer = null;
  let currentThreadId = null;

  async function ensureThreadExistsAndSubscribe(peer) {
    const user = auth.currentUser; if (!user) throw new Error('–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    const tId = threadIdFor(user.uid, peer.uid);
    const threadRef = doc(db, 'dmThreads', tId);
    await runTransaction(db, async (tx) => {
      const tSnap = await tx.get(threadRef);
      if (!tSnap.exists()) tx.set(threadRef, { participants: [user.uid, peer.uid], createdAt: serverTimestamp() });
      // optionally update lastSeen/time
    });
    subscribeToMessages(tId);
    return tId;
  }

  function subscribeToMessages(tId) {
    if (unsubscribeMessages) unsubscribeMessages();
    const msgsCol = collection(db, 'dmThreads', tId, 'messages');
    const q = query(msgsCol, orderBy('createdAt', 'asc'));
    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      messagesEl.innerHTML = '';
      snapshot.forEach(docSnap => {
        const m = docSnap.data();
        renderMessage(m);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
      // clear unread for this thread on open
      unreadCounts[tId] = 0;
      renderThreadBadge(tId);
      // set last seen timestamp
      setLastSeen(tId, Date.now());
    }, (err) => {
      console.warn('msgs sub err', err);
    });
    currentThreadId = tId;
  }

  function renderMessage(m) {
    const user = auth.currentUser;
    const row = document.createElement('div');
    row.className = 'message-row ' + (m.senderId === (user && user.uid) ? 'me' : 'other');
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (m.senderId === (user && user.uid) ? 'me' : 'other');
    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.textContent = (m.displayName || m.senderId) + ' ¬∑ ' + (m.createdAt ? new Date(m.createdAt.toMillis()).toLocaleTimeString() : '');
    bubble.appendChild(meta);
    if (m.type === 'image' && m.url) {
      const img = document.createElement('img'); img.src = m.url; img.className = 'msg-img';
      bubble.appendChild(img);
      if (m.text) { const t = document.createElement('div'); t.textContent = m.text; bubble.appendChild(t); }
    } else if (m.type === 'audio' && m.url) {
      const audio = document.createElement('audio'); audio.controls = true; audio.src = m.url; audio.className = 'msg-audio';
      bubble.appendChild(audio);
      if (m.text) { const t = document.createElement('div'); t.textContent = m.text; bubble.appendChild(t); }
    } else {
      const txt = document.createElement('div'); txt.textContent = m.text || ''; bubble.appendChild(txt);
    }
    row.appendChild(bubble);
    messagesEl.appendChild(row);
  }

  // --- open chat with peer ---
  async function openDirectChat(peer) {
    currentPeer = peer;
    peerName.textContent = peer.displayName || peer.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    peerAvatar.src = peer.photoURL || 'https://via.placeholder.com/48?text=?';
    peerSub.textContent = '@' + (peer.username || '');
    try {
      const tId = await ensureThreadExistsAndSubscribe(peer);
      currentThreadId = tId;
      // clear unread after opening
      unreadCounts[tId] = 0;
      renderThreadBadge(tId);
      setLastSeen(tId, Date.now());
    } catch (e) {
      console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç: ' + (e.message || e));
    }
  }

  // --- send message, image upload, audio upload (preserve original) ---
  async function sendTextMessage(text) {
    if (!text) return;
    const user = auth.currentUser; if (!user) return alert('–í–æ–π–¥–∏—Ç–µ');
    if (!currentPeer) return alert('–û—Ç–∫—Ä–æ–π —á–∞—Ç');
    try {
      const tId = await ensureThreadExistsAndSubscribe(currentPeer);
      const msgsCol = collection(db, 'dmThreads', tId, 'messages');
      await addDoc(msgsCol, { senderId: user.uid, displayName: user.displayName || user.email.split('@')[0], text, type: 'text', createdAt: serverTimestamp() });
      // optionally update lastMessageText in thread doc for UI convenience
      await setDoc(doc(db, 'dmThreads', tId), { lastMessageText: text, updatedAt: serverTimestamp() }, { merge: true });
    } catch (e) { console.error(e); alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message); }
  }

  imageBtn.onclick = () => imageInput.click();
  imageInput.onchange = async (ev) => {
    const file = ev.target.files[0];
    if (!file) return;
    if (!currentPeer) return alert('–û—Ç–∫—Ä–æ–π —á–∞—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ç–æ');
    const user = auth.currentUser; if (!user) return alert('–í–æ–π–¥–∏—Ç–µ');
    try {
      const tId = await ensureThreadExistsAndSubscribe(currentPeer);
      const path = `dmThreads/${tId}/media/${Date.now()}_${file.name}`;
      const sRef = storageRef(storage, path);
      const snap = await uploadBytes(sRef, file);
      const url = await getDownloadURL(sRef);
      // send message with image type
      const msgsCol = collection(db, 'dmThreads', tId, 'messages');
      await addDoc(msgsCol, { senderId: user.uid, displayName: user.displayName || user.email.split('@')[0], text: '', url, type: 'image', createdAt: serverTimestamp() });
      // update lastMessageText
      await setDoc(doc(db, 'dmThreads', tId), { lastMessageText: '[–§–æ—Ç–æ]', updatedAt: serverTimestamp() }, { merge: true });
      imageInput.value = '';
    } catch (e) { console.error(e); alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + (e.message || e)); }
  };

  // --- audio recording ---
  let mediaRecorder = null;
  let audioChunks = [];
  recordBtn.onclick = async () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      recordBtn.textContent = 'üéôÔ∏è';
      recordBtn.style.background = '';
    } else {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          await uploadAudioBlob(blob);
        };
        mediaRecorder.start();
        recordBtn.textContent = '‚ñ†';
        recordBtn.style.background = '#ffdddd';
      } catch (e) {
        console.error(e); alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + (e.message || e));
      }
    }
  };

  async function uploadAudioBlob(blob) {
    if (!currentPeer) return alert('–û—Ç–∫—Ä–æ–π —á–∞—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ');
    const user = auth.currentUser; if (!user) return alert('–í–æ–π–¥–∏—Ç–µ');
    try {
      const tId = await ensureThreadExistsAndSubscribe(currentPeer);
      const path = `dmThreads/${tId}/media/${Date.now()}_voice.webm`;
      const sRef = storageRef(storage, path);
      await uploadBytes(sRef, blob);
      const url = await getDownloadURL(sRef);
      const msgsCol = collection(db, 'dmThreads', tId, 'messages');
      await addDoc(msgsCol, { senderId: user.uid, displayName: user.displayName || user.email.split('@')[0], text: '', url, type: 'audio', createdAt: serverTimestamp() });
      await setDoc(doc(db, 'dmThreads', tId), { lastMessageText: '[–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]', updatedAt: serverTimestamp() }, { merge: true });
    } catch (e) { console.error(e); alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–∞: ' + (e.message || e)); }
  }

  // --- send on Enter (Shift+Enter newline) ---
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });
  sendBtn.onclick = () => {
    const text = messageInput.value.trim();
    if (!text) return;
    sendTextMessage(text);
    messageInput.value = '';
  };

  // --- auth state handling ---
  onAuthStateChanged(auth, async (user) => {
    renderAuthUI(user);
    if (user) {
      // subscribe to my threads
      subscribeMyThreads(user.uid);
      // request notifications permission prompt softly when logged in
      if ("Notification" in window && Notification.permission === "default") {
        try { await Notification.requestPermission(); } catch(e){ /* ignore */ }
      }
    } else {
      if (unsubscribeThreads) unsubscribeThreads();
      if (unsubscribeThreadsAll) unsubscribeThreadsAll();
    }
  });

  newChatBtn.onclick = () => {
    const username = prompt('–í–≤–µ–¥–∏—Ç–µ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ @):');
    if (!username) return;
    (async () => {
      try {
        const unameSnap = await getDoc(doc(db, 'usernames', username.trim().toLowerCase()));
        if (!unameSnap.exists()) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        const owner = unameSnap.data().owner;
        const prof = (await getDoc(doc(db, 'profiles', owner))).data() || {};
        openDirectChat({ uid: owner, username: username.trim().toLowerCase(), displayName: prof.displayName, photoURL: prof.photoURL });
      } catch (e) { console.error(e); alert('–û—à–∏–±–∫–∞: ' + e.message); }
    })();
  };

  // --- utilities ---
  function debounce(fn, ms) { let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; }
  function escapeHtml(s) { if (!s) return ''; return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

  // expose setLastSeen so user can click to mark read (optional)
  window.setLastSeen = setLastSeen;

  // end of module
</script>
</body>
</html>
