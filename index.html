–¥–∞–Ω—è –∫–∞—à–∏–Ω
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NovaNet ‚Äî —É–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (Twitter-like) ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π</title>
<style>
/* =====================================================================
   NovaNet - –£–ª—É—á—à–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –≤ —Å—Ç–∏–ª–µ Twitter / —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–æ—Ü—Å–µ—Ç—å
   –í–µ—Å—å CSS –≤—Å—Ç—Ä–æ–µ–Ω. –ê–¥–∞–ø—Ç–∏–≤–µ–Ω, —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –û–¥–∏–Ω —Ñ–∞–π–ª.
   ===================================================================== */

/* -------------------------
   –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã
   ------------------------- */
:root{
  --bg: #0f1724;
  --panel: linear-gradient(180deg,#0b1220, #0f172a);
  --muted: #9aa6b2;
  --text: #e6eef6;
  --accent: #1d9bf0;
  --accent-2: #60a5fa;
  --danger: #ff5a5f;
  --glass: rgba(255,255,255,0.03);
  --soft-shadow: 0 6px 18px rgba(2,6,23,0.6);
  --card-radius: 14px;
  --border: rgba(255,255,255,0.04);
  --max-width: 1100px;
  --transition: 220ms cubic-bezier(.2,.9,.3,1);
  --glass-2: rgba(255,255,255,0.02);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* Light theme */
body.light{
  --bg: #f6f8fb;
  --panel: linear-gradient(180deg,#ffffff,#f8fafc);
  --muted: #5b6b76;
  --text: #07122a;
  --accent: #0d6efd;
  --accent-2: #60a5fa;
  --danger: #d9534f;
  --glass: rgba(0,0,0,0.03);
  --soft-shadow: 0 6px 18px rgba(2,6,23,0.08);
  --border: rgba(0,0,0,0.06);
  --glass-2: rgba(0,0,0,0.02);
}

/* -------------------------
   Reset / base
   ------------------------- */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  transition: background var(--transition), color var(--transition);
}

/* Center wrapper */
.app-wrap{
  display:flex;
  justify-content:center;
  padding:18px;
}

/* Main app frame */
.app{
  display:grid;
  grid-template-columns: 260px 1fr 320px;
  gap:18px;
  width:100%;
  max-width:var(--max-width);
  align-items:start;
}

/* Mobile adjustments */
@media (max-width:1000px){
  .app{grid-template-columns: 1fr; padding:12px}
  .right-col{display:none}
  .left-col{position:sticky; top:0; z-index:20}
}

/* -------------------------
   Left column (nav)
   ------------------------- */
.left-col{
  background:var(--panel);
  border-radius:16px;
  padding:18px;
  min-height:80vh;
  box-shadow:var(--soft-shadow);
  border:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* Logo */
.brand{
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:6px;
}
.brand .logo{
  width:46px;height:46px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:white;font-size:20px;box-shadow:0 8px 24px rgba(29,155,240,0.18);
}
.brand .title{
  font-weight:700;font-size:18px;color:var(--text)
}
.brand .tag{font-size:12px;color:var(--muted)}

/* Navigation buttons */
.nav{
  display:flex;flex-direction:column;gap:8px;margin-top:6px;
}
.nav button{
  display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;background:transparent;
  color:var(--text);font-weight:600;border:1px solid transparent;transition:all var(--transition);
}
.nav button .ico{width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:18px}
.nav button:hover{background:var(--glass);transform:translateY(-2px)}
.nav button.active{background:linear-gradient(90deg, rgba(29,155,240,0.12), rgba(96,165,250,0.06)); border:1px solid rgba(29,155,240,0.12)}

/* Compose button */
.compose{
  margin-top:auto;
}
.btn-primary{
  width:100%;
  padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:white;font-weight:700;box-shadow:0 10px 30px rgba(29,155,240,0.14);transition:transform var(--transition);
}
.btn-primary:hover{transform:translateY(-3px)}
.small{font-size:13px;padding:8px}

/* -------------------------
   Center column (feed)
   ------------------------- */
.center-col{
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* New post composer (card) */
.composer{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  padding:14px;border-radius:14px;border:1px solid var(--border);box-shadow:var(--soft-shadow);
}
.composer-top{display:flex;gap:12px;align-items:flex-start}
.avatar-sm{width:48px;height:48px;border-radius:50%;background:var(--glass);display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:var(--text);font-size:16px}
.composer textarea{
  flex:1;min-height:72px;background:transparent;border:none;color:var(--text);
  resize:none;font-size:15px;padding:6px;outline:none;
}
.composer-actions{display:flex;justify-content:space-between;align-items:center;padding-top:8px}
.file-input{display:flex;gap:8px;align-items:center}
.icon-btn{padding:8px;border-radius:10px;background:transparent;border:1px dashed rgba(255,255,255,0.03);cursor:pointer}
.counter{color:var(--muted);font-size:13px;margin-right:12px}

/* Post card */
.post-card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  padding:14px;border-radius:14px;border:1px solid var(--border);box-shadow:var(--soft-shadow);
  display:flex;gap:12px;align-items:flex-start;
}
.post-main{flex:1}
.post-meta{display:flex;gap:10px;align-items:center;font-size:13px;color:var(--muted)}
.post-text{margin-top:8px;font-size:15px;line-height:1.45;color:var(--text)}
.post-media{margin-top:10px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
.post-media img{width:100%;height:auto;display:block}

/* Actions row */
.actions-row{display:flex;gap:18px;margin-top:12px;align-items:center}
.action{
  display:flex;gap:8px;align-items:center;color:var(--muted);cursor:pointer;padding:8px;border-radius:10px;transition:all var(--transition)
}
.action:hover{background:var(--glass);color:var(--accent);transform:translateY(-3px)}

/* Highlight liked */
.action.liked{color: #ff7aa2; background: rgba(255,122,162,0.06)}

/* -------------------------
   Right column (trends, suggestions)
   ------------------------- */
.right-col{
  background:var(--panel);border-radius:16px;padding:14px;border:1px solid var(--border);box-shadow:var(--soft-shadow);min-height:80vh;
}
.section-title{font-weight:700;margin-bottom:8px;color:var(--text)}
.trend, .who{
  padding:10px;border-radius:12px;background:transparent;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:var(--muted);
}
.trend:hover, .who:hover{background:var(--glass);transform:translateY(-3px);color:var(--text)}
.trend small{display:block;font-size:12px;color:var(--muted)}

/* -------------------------
   Profile compact
   ------------------------- */
.profile-compact{display:flex;gap:12px;align-items:center;padding:10px;border-radius:12px;background:var(--glass)}
.profile-compact .info{flex:1}
.profile-compact .name{font-weight:700}
.profile-compact .sub{font-size:13px;color:var(--muted)}

/* -------------------------
   Auth modal / page
   ------------------------- */
.auth-wrap{
  max-width:900px;margin:60px auto;padding:18px;display:grid;grid-template-columns:1fr 420px;gap:20px;
}
.auth-left{display:flex;flex-direction:column;gap:12px;justify-content:center}
.auth-card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  padding:18px;border-radius:14px;border:1px solid var(--border);box-shadow:var(--soft-shadow);
}
.input{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.input input{padding:12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}

/* -------------------------
   Small utilities
   ------------------------- */
.flex{display:flex;align-items:center;gap:8px}
.center{text-align:center}
.pink{color:#ff7aa2}
.muted{color:var(--muted)}
.sep{height:1px;background:var(--border);margin:12px 0;border-radius:2px}

/* -------------------------
   Notifications toast
   ------------------------- */
.toast{
  position:fixed;right:22px;bottom:22px;padding:12px 14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid var(--border);box-shadow:0 12px 40px rgba(2,6,23,0.45);color:var(--text);
  animation:toastin 280ms ease both;
}
@keyframes toastin{from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:translateY(0)}}

/* -------------------------
   Responsive tweaks
   ------------------------- */
@media (max-width:700px){
  .nav button span.text{display:none}
  .left-col{padding:10px}
  .compose{display:none}
  .composer textarea{min-height:56px}
}
</style>
</head>
<body>

<div id="root">

  <!-- AUTH / MAIN SWITCH -->
  <div id="authPage" class="auth-wrap" style="display:none">
    <div class="auth-left">
      <div style="font-weight:800;font-size:28px;color:var(--text)">NovaNet</div>
      <div style="font-size:15px;color:var(--muted)">–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ—Ç—å ‚Äî —Ç–µ–ø–µ—Ä—å —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º UI –≤ —Å—Ç–∏–ª–µ Twitter.</div>

      <div class="auth-card">
        <div style="font-weight:700;margin-bottom:8px">–í—Ö–æ–¥</div>
        <div class="input"><label class="muted">Email –∏–ª–∏ –ª–æ–≥–∏–Ω</label><input id="in_user" placeholder="email –∏–ª–∏ –ª–æ–≥–∏–Ω"></div>
        <div class="input"><label class="muted">–ü–∞—Ä–æ–ª—å</label><input id="in_pass" type="password" placeholder="–ø–∞—Ä–æ–ª—å"></div>
        <div style="display:flex;gap:8px">
          <button class="btn-primary small" onclick="actionLogin()">–í–æ–π—Ç–∏</button>
          <button class="small" onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
      </div>

      <div class="sep"></div>

      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800">NN</div>
        <div>
          <div style="font-weight:700">NovaNet</div>
          <div class="muted" style="font-size:13px">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π MVP ‚Äî –º–∞–∫—Å–∏–º—É–º –∑–∞–±–æ—Ç—ã –æ –¥–∏–∑–∞–π–Ω–µ</div>
        </div>
      </div>

    </div>

    <div>
      <div class="auth-card">
        <div style="font-weight:700;margin-bottom:8px">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>
        <div class="input"><label class="muted">Email (–≤–≤–µ–¥–∏—Ç–µ email —á—Ç–æ–±—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ Firebase)</label><input id="up_user" placeholder="email"></div>
        <div class="input"><label class="muted">–ü–∞—Ä–æ–ª—å</label><input id="up_pass" type="password" placeholder="–ø–∞—Ä–æ–ª—å"></div>
        <div class="input"><label class="muted">–ò–º—è (–ø—É–±–ª–∏—á–Ω–æ–µ)</label><input id="up_name" placeholder="–∏–º—è"></div>
        <div style="display:flex;gap:8px">
          <button class="btn-primary small" onclick="actionRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
          <button class="small" onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="auth-card">
        <div style="font-weight:700">–ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä</div>
        <ul style="margin-top:8px;color:var(--muted);line-height:1.6;padding-left:18px">
          <li>–ü—É–±–ª–∏–∫–∞—Ü–∏–∏, –ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</li>
          <li>–ß–∞—Ç—ã –≤ —Å—Ç–∏–ª–µ Telegram</li>
          <li>–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ–¥–ø–∏—Å–∫–∏</li>
        </ul>
      </div>

    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" style="display:none" class="app-wrap">
    <div class="app">

      <!-- LEFT NAV -->
      <div class="left-col" id="leftCol">
        <div class="brand">
          <div class="logo">NN</div>
          <div>
            <div class="title">NovaNet</div>
            <div class="tag">–°–æ—Ü—Å–µ—Ç—å MVP</div>
          </div>
        </div>

        <div class="nav" role="navigation" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
          <button id="btnFeed" class="active" onclick="showFeed()"><span class="ico">üè†</span><span class="text">–ì–ª–∞–≤–Ω–∞—è</span></button>
          <button id="btnExplore" onclick="showExplore()"><span class="ico">üîç</span><span class="text">–û–±–∑–æ—Ä</span></button>
          <button id="btnMessages" onclick="showChats()"><span class="ico">üí¨</span><span class="text">–ß–∞—Ç—ã</span></button>
          <button id="btnProfile" onclick="showProfile()"><span class="ico">üë§</span><span class="text">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
          <button id="btnDrafts" onclick="showDrafts()"><span class="ico">üìù</span><span class="text">–ß–µ—Ä–Ω–æ–≤–∏–∫–∏</span></button>
          <button onclick="toggleTheme()"><span class="ico">üåó</span><span class="text">–¢–µ–º–∞</span></button>
        </div>

        <div class="compose">
          <button class="btn-primary" onclick="openComposer()">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</button>
        </div>

        <div style="margin-top:10px">
          <div class="profile-compact">
            <div class="avatar-sm" id="sideAvatar">U</div>
            <div class="info">
              <div class="name" id="sideName">–ì–æ—Å—Ç—å</div>
              <div class="sub" id="sideHandle">@guest</div>
            </div>
          </div>
        </div>

        <div style="margin-top:8px">
          <button class="small" onclick="resetLocalCurrent()" title="–°–±—Ä–æ—Å–∏—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">–°–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
          <div style="height:6px"></div>
          <button class="small" onclick="clearAllLocal()" title="–û—á–∏—Å—Ç–∏—Ç—å localStorage (–≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ)">–û—á–∏—Å—Ç–∏—Ç—å localStorage</button>
        </div>

      </div>

      <!-- CENTER FEED -->
      <main class="center-col" id="centerCol">

        <!-- Composer (in feed) ‚Äî —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–ø–µ—Ä—å –ü–ï–†–ú–ê–ù–ï–ù–¢–ï–ù –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è -->
        <div id="composerCard" class="composer" style="display:none">
          <div class="composer-top">
            <div class="avatar-sm" id="composerAvatar">U</div>
            <textarea id="composerText" maxlength="280" placeholder="–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?"></textarea>
          </div>

          <div class="composer-actions">
            <div class="file-input">
              <label class="icon-btn" title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">
                <input type="file" id="composerFile" style="display:none" accept="image/*" onchange="previewComposerMedia(event)">
                üñº
              </label>
              <div id="composerPreview" style="min-width:0"></div>
            </div>
            <div style="display:flex;align-items:center">
              <div class="counter" id="charsLeft">280</div>
              <button class="btn-primary small" onclick="publishPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
          </div>
        </div>

        <!-- Page content (–≤—Å—ë, —á—Ç–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è: –ª–µ–Ω—Ç–∞, —á–∞—Ç—ã, –ø—Ä–æ—Ñ–∏–ª—å) -->
        <div id="pageContent">
          <!-- –≤–Ω—É—Ç—Ä–∏ –±—É–¥–µ—Ç feedList / chat area / profile –∏ —Ç.–¥. -->
          <div id="feedList"></div>
        </div>

      </main>

      <!-- RIGHT TRENDS / SUGGESTIONS -->
      <aside class="right-col">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="section-title">–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç</div>
            <div class="muted" style="font-size:13px">–¢—Ä–µ–Ω–¥—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</div>
          </div>
          <div style="font-size:12px;color:var(--muted)">–û–±–Ω–æ–≤–ª–µ–Ω–æ</div>
        </div>

        <div style="margin-top:12px" id="trends"></div>

        <div class="sep"></div>

        <div>
          <div class="section-title">–ö–æ–≥–æ —á–∏—Ç–∞—Ç—å</div>
          <div id="whoToFollow"></div>
        </div>

      </aside>

    </div>
  </div>

</div>

<!-- Toast container -->
<div id="toastContainer" style="position:fixed;right:18px;bottom:18px;z-index:9999"></div>

<script>
/* =====================================================================
   NovaNet ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π JS (–≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π STATE)
   - STATE –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ window.STATE –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª–µ–º Firebase
   - –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—á–∏—Å—Ç–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö users
   ===================================================================== */

/* -------------------------
   STATE (–≥–ª–æ–±–∞–ª—å–Ω–æ)
   ------------------------- */
window.STATE = {
  users: JSON.parse(localStorage.getItem('nn_users') || '[]'),
  posts: JSON.parse(localStorage.getItem('nn_posts') || '[]'),
  chats: JSON.parse(localStorage.getItem('nn_chats') || '{}'),
  current: JSON.parse(localStorage.getItem('nn_current') || 'null'),
  drafts: JSON.parse(localStorage.getItem('nn_drafts') || '[]'),
  theme: localStorage.getItem('nn_theme') || 'dark'
};
const STATE = window.STATE;

/* -------------------------
   Helpers
   ------------------------- */
function saveAll(){
  localStorage.setItem('nn_users', JSON.stringify(STATE.users));
  localStorage.setItem('nn_posts', JSON.stringify(STATE.posts));
  localStorage.setItem('nn_chats', JSON.stringify(STATE.chats));
  localStorage.setItem('nn_drafts', JSON.stringify(STATE.drafts));
  localStorage.setItem('nn_current', JSON.stringify(STATE.current));
}
function toast(msg, time=2500){
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(()=>{ try{ el.style.opacity=0; el.remove(); }catch(e){} }, time);
}
function uid(){ return Date.now() + Math.floor(Math.random()*999) }

/* -------------------------
   Quick debug / local cleanup actions
   ------------------------- */
function resetLocalCurrent(){
  // –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage (–Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç posts)
  STATE.current = null;
  localStorage.setItem('nn_current', null);
  saveAll();
  toast('–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–±—Ä–æ—à–µ–Ω');
  showAuth();
}
function clearAllLocal(){
  // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ localStorage (–≤–∫–ª—é—á–∞—è seeded). –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å.
  if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å—Ç—ã –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.')) return;
  localStorage.clear();
  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º STATE –≤ –ø–∞–º—è—Ç–∏ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
  window.STATE = {
    users: [], posts: [], chats: {}, current: null, drafts: [], theme: 'dark'
  };
  saveAll();
  toast('LocalStorage –æ—á–∏—â–µ–Ω ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞');
  location.reload();
}

/* -------------------------
   Theme management
   ------------------------- */
function applyTheme(){
  if(STATE.theme === 'light') document.body.classList.add('light');
  else document.body.classList.remove('light');
  localStorage.setItem('nn_theme', STATE.theme);
}
function toggleTheme(){
  STATE.theme = STATE.theme === 'light' ? 'dark' : 'light';
  applyTheme();
}

/* -------------------------
   FIX: –µ—Å–ª–∏ current —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º users,
   —Å–±—Ä–∞—Å—ã–≤–∞–µ–º current (–Ω–µ —Ç—Ä–æ–≥–∞—è posts).
   ------------------------- */
(function validateLocalCurrent(){
  try {
    if(STATE.current){
      const exists = (STATE.users || []).find(u => u.username === STATE.current.username || u.id === STATE.current.id || u.uid === STATE.current.uid);
      if(!exists){
        // Current user –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º users -> —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π current
        STATE.current = null;
        localStorage.setItem('nn_current', null);
        saveAll();
        // –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤—è–∑—á–∏–≤—ã—Ö –æ–∫–æ–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º toast, –µ—Å–ª–∏ UI –≥–æ—Ç–æ–≤
        setTimeout(()=>{ try{ toast('–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥'); }catch(e){} }, 200);
      }
    }
  } catch(e){
    console.warn('validateLocalCurrent error', e);
  }
})();

/* -------------------------
   Auth (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è; –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ Firebase-–º–æ–¥—É–ª–µ–º)
   ------------------------- */
function showAuth(){
  const authPage = document.getElementById('authPage');
  const app = document.getElementById('app');
  if(authPage) authPage.style.display = 'grid';
  if(app) app.style.display = 'none';
}
function showApp(){
  const authPage = document.getElementById('authPage');
  const app = document.getElementById('app');
  if(authPage) authPage.style.display = 'none';
  if(app) app.style.display = 'block';
  refreshUI();
  showFeed();
}

/* –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è */
function actionRegister(){
  const username = (document.getElementById('up_user')?.value || '').trim();
  const pass = (document.getElementById('up_pass')?.value || '').trim();
  const name = (document.getElementById('up_name')?.value || '').trim() || username;
  if(!username || !pass){ toast('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'); return }
  if((STATE.users||[]).find(u=>u.username===username)){ toast('–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –µ—Å—Ç—å'); return }
  const user = {
    id: uid(),
    username,
    password: pass,
    displayName: name,
    bio: '',
    avatar: '',
    followers: [],
    following: []
  };
  STATE.users.push(user);
  STATE.current = user;
  saveAll();
  toast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω –∏ –≤—ã –≤–æ—à–ª–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)');
  showApp();
}

/* –ª–æ–∫–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥ */
function actionLogin(){
  const username = (document.getElementById('in_user')?.value || '').trim();
  const pass = (document.getElementById('in_pass')?.value || '').trim();
  const user = (STATE.users||[]).find(u=> (u.username===username || u.email===username) && u.password===pass);
  if(!user){ toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); return }
  STATE.current = user;
  saveAll();
  toast('–õ–æ–∫–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
  showApp();
}

function logout(){
  STATE.current = null;
  saveAll();
  if(window.firebaseSignOut) {
    try { window.firebaseSignOut(); } catch(e){ console.warn(e); }
  }
  location.reload();
}

/* -------------------------
   Composer actions + preview
   ------------------------- */
function openComposer(){
  const el = document.getElementById('composerCard');
  if(!el) return;
  el.style.display = 'block';
  const ta = document.getElementById('composerText');
  if(ta) ta.focus();
}
function showComposerInline(show){
  const el = document.getElementById('composerCard');
  if(!el) return;
  el.style.display = show ? 'block' : 'none';
}
function attachComposerCounter(){
  const txt = document.getElementById('composerText');
  if(txt){
    txt.addEventListener('input', ()=> {
      const left = 280 - txt.value.length;
      const counter = document.getElementById('charsLeft');
      if(counter) counter.textContent = left;
    });
  }
}
function previewComposerMedia(e){
  const file = e.target.files[0];
  const preview = document.getElementById('composerPreview');
  if(!preview) return;
  preview.innerHTML = '';
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    const img = document.createElement('img');
    img.src = reader.result;
    img.style.maxWidth='160px'; img.style.maxHeight='90px'; img.style.borderRadius='8px';
    preview.appendChild(img);
    preview.dataset.img = reader.result;
  };
  reader.readAsDataURL(file);
}

/* -------------------------
   Local publishPost (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω Firebase)
   ------------------------- */
function publishPost(){
  if(!STATE.current){ toast('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç'); return }
  const txt = document.getElementById('composerText');
  const preview = document.getElementById('composerPreview');
  if(!txt || !preview){ toast('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞'); return }
  const content = (txt.value || '').trim();
  if(!content && !preview.dataset.img){ toast('–ü—É—Å—Ç–æ–π –ø–æ—Å—Ç'); return }
  const post = {
    id: uid(),
    author: STATE.current.username,
    authorName: STATE.current.displayName || STATE.current.username,
    avatar: STATE.current.avatar || '',
    text: content,
    media: preview.dataset.img || '',
    likes: [],
    comments: [],
    reposts: 0,
    createdAt: new Date().toISOString()
  };
  STATE.posts.unshift(post);
  saveAll();
  txt.value=''; preview.innerHTML=''; delete preview.dataset.img;
  const counter = document.getElementById('charsLeft'); if(counter) counter.textContent = 280;
  toast('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)');
  renderFeed();
}

/* -------------------------
   Render feed
   ------------------------- */
function renderFeed(){
  const pageContent = document.getElementById('pageContent'); if(!pageContent) return;
  let c = document.getElementById('feedList');
  if(!c){
    c = document.createElement('div'); c.id = 'feedList';
    pageContent.innerHTML = ''; // clear page content (keep composer)
    pageContent.appendChild(c);
  } else {
    // ensure composer remains at top of pageContent
    pageContent.innerHTML = '';
    pageContent.appendChild(document.getElementById('composerCard'));
    pageContent.appendChild(c);
  }
  c.innerHTML = '';
  if(!STATE.posts || STATE.posts.length===0){
    c.innerHTML = `<div class="post-card" style="justify-content:center"><div class="muted center">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤ ‚Äî –±—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º</div></div>`;
    return;
  }
  STATE.posts.forEach(post=>{
    const card = document.createElement('div'); card.className='post-card';
    const left = document.createElement('div'); left.style.minWidth='56px';
    left.innerHTML = `<div class="avatar-sm">${(post.author||'U')[0].toUpperCase()}</div>`;
    const main = document.createElement('div'); main.className='post-main';
    const meta = document.createElement('div'); meta.className='post-meta';
    const date = new Date(post.createdAt);
    meta.innerHTML = `<strong style="color:var(--text)">${escapeHtml(post.authorName)}</strong>
                      <span class="muted">@${escapeHtml(post.author)}</span>
                      <span class="muted">¬∑ ${timeAgo(date)}</span>`;
    const text = document.createElement('div'); text.className='post-text';
    text.innerHTML = linkify(escapeHtml(post.text));
    main.appendChild(meta); main.appendChild(text);
    if(post.media){
      const mediaWrap = document.createElement('div'); mediaWrap.className='post-media';
      mediaWrap.innerHTML = `<img src="${post.media}" alt="media">`; main.appendChild(mediaWrap);
    }
    const actions = document.createElement('div'); actions.className='actions-row';
    const like = document.createElement('div'); like.className='action';
    if(post.likes && post.likes.includes(STATE.current?.username)) like.classList.add('liked');
    like.innerHTML = `‚ù§Ô∏è <span>${(post.likes||[]).length}</span>`;
    like.onclick = ()=>{ toggleLike(post.id); };
    const comm = document.createElement('div'); comm.className='action'; comm.innerHTML = `üí¨ <span>${(post.comments||[]).length}</span>`; comm.onclick = ()=> openComments(post.id);
    const rep = document.createElement('div'); rep.className='action'; rep.innerHTML = `üîÅ <span>${post.reposts||0}</span>`; rep.onclick = ()=> { repost(post.id); };
    const del = document.createElement('div'); del.className='action'; del.innerHTML = `üóë`;
    if(STATE.current && STATE.current.username === post.author){ del.onclick = ()=>{ deletePost(post.id); }; } else { del.style.opacity = 0.3; del.style.pointerEvents='none'; }
    actions.appendChild(like); actions.appendChild(comm); actions.appendChild(rep); actions.appendChild(del);
    main.appendChild(actions);
    card.appendChild(left); card.appendChild(main);
    c.appendChild(card);
  });
}

/* -------------------------
   Utilities: like/comment/repost/delete (local)
   ------------------------- */
function toggleLike(postId){
  if(!STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return }
  const post = STATE.posts.find(p=>p.id===postId);
  if(!post) return;
  const u = STATE.current.username;
  if(post.likes.includes(u)) post.likes = post.likes.filter(x=>x!==u);
  else post.likes.push(u);
  saveAll();
  renderFeed();
}
function openComments(postId){
  const post = STATE.posts.find(p=>p.id===postId);
  if(!post) return;
  const text = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:');
  if(text && text.trim()){
    post.comments.push({id:uid(), user: STATE.current?.username || 'guest', text:text.trim(), createdAt:new Date().toISOString()});
    saveAll();
    toast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω');
    renderFeed();
  }
}
function repost(postId){
  const post = STATE.posts.find(p=>p.id===postId);
  if(!post) return;
  post.reposts = (post.reposts || 0) + 1;
  saveAll();
  toast('–†–µ–ø–æ—Å—Ç ‚Äî —É—Å–ø–µ—à–Ω–æ');
  renderFeed();
}
function deletePost(postId){
  const idx = STATE.posts.findIndex(p=>p.id===postId);
  if(idx>-1){
    const ok = confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?');
    if(!ok) return;
    STATE.posts.splice(idx,1);
    saveAll();
    renderFeed();
  }
}

/* -------------------------
   Profile / edit
   ------------------------- */
function renderProfile(){
  const pageContent = document.getElementById('pageContent'); if(!pageContent) return;
  pageContent.innerHTML = '';
  const user = STATE.current;
  if(!user){ pageContent.innerHTML = '<div class="auth-card">–í–æ–π–¥–∏—Ç–µ</div>'; return; }
  const card = document.createElement('div'); card.className='auth-card'; card.style.padding='16px';
  card.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:84px;height:84px;border-radius:14px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:800">${user.displayName?.[0] || user.username[0] || 'U'}</div>
      <div style="flex:1">
        <div style="font-weight:800">${escapeHtml(user.displayName || user.username)}</div>
        <div class="muted">@${escapeHtml(user.username)}</div>
      </div>
      <div>
        <button class="btn-primary small" onclick="editProfile()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
    <div style="margin-top:12px;color:var(--muted)">${escapeHtml(user.bio || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}</div>
    <div class="sep"></div>
    <div style="display:flex;gap:12px">
      <div><strong>${user.followers?.length||0}</strong><div class="muted">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div></div>
      <div><strong>${user.following?.length||0}</strong><div class="muted">–ü–æ–¥–ø–∏—Å–∫–∏</div></div>
    </div>
    <div style="margin-top:10px">
      <button class="small" onclick="promptExportLocal()">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å—Ç—ã</button>
      <button class="small" id="deleteCloudBtn" onclick="deleteMyAccountCloud()" style="margin-left:8px">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –∏ –¥–∞–Ω–Ω—ã–µ (–æ–±–ª–∞–∫–æ)</button>
    </div>
  `;
  pageContent.appendChild(card);

  const postsTitle = document.createElement('div'); postsTitle.className='section-title'; postsTitle.style.marginTop='12px'; postsTitle.textContent='–ú–æ–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏';
  pageContent.appendChild(postsTitle);
  const list = document.createElement('div');
  (STATE.posts||[]).filter(p=>p.author===user.username).forEach(p=>{
    const row = document.createElement('div'); row.className='post-card';
    row.innerHTML = `<div style="min-width:54px"><div class="avatar-sm">${p.author[0].toUpperCase()}</div></div>
      <div class="post-main">
       <div class="post-meta"><strong style="color:var(--text)">${escapeHtml(p.authorName)}</strong><span class="muted">@${escapeHtml(p.author)}</span><span class="muted">¬∑ ${timeAgo(new Date(p.createdAt))}</span></div>
       <div class="post-text">${escapeHtml(p.text)}</div>
      </div>`;
    list.appendChild(row);
  });
  pageContent.appendChild(list);
}

function editProfile(){
  if(!STATE.current) return;
  const name = prompt('–ò–º—è (–ø—É–±–ª–∏—á–Ω–æ–µ):', STATE.current.displayName || STATE.current.username);
  if(name!==null) STATE.current.displayName = name.trim() || STATE.current.username;
  const bio = prompt('–û–ø–∏—Å–∞–Ω–∏–µ:', STATE.current.bio || '');
  if(bio!==null) STATE.current.bio = bio.trim();
  const avatar = prompt('–í—Å—Ç–∞–≤—å—Ç–µ dataURL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ (–∏–ª–∏ –æ—Ç–º–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞):', STATE.current.avatar || '');
  if(avatar!==null && avatar.trim()){
    STATE.current.avatar = avatar.trim();
  }
  const idx = (STATE.users||[]).findIndex(u=>u.username===STATE.current.username);
  if(idx>-1) STATE.users[idx]=STATE.current;
  saveAll();
  toast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
  renderProfile();
  refreshUI();
}

/* —ç–∫—Å–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ (–ø—Ä–æ—Å—Ç–æ —Å–∫–∞—á–∞–µ—Ç JSON) */
function promptExportLocal(){
  const data = JSON.stringify(STATE.posts || [], null, 2);
  const blob = new Blob([data], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'nova_posts_export.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  toast('–≠–∫—Å–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –Ω–∞—á–∞—Ç');
}

/* -------------------------
   Explore / right column
   ------------------------- */
function renderExplore(){
  const pageContent = document.getElementById('pageContent');
  if(!pageContent) return;
  pageContent.innerHTML = '';
  const card = document.createElement('div'); card.className='auth-card';
  card.innerHTML = `<div style="font-weight:800">–û–±–∑–æ—Ä</div><div class="muted" style="margin-top:8px">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ—Å—Ç—ã</div>`;
  pageContent.appendChild(card);
  const top = [...(STATE.posts||[])].sort((a,b)=> (b.likes?.length||0) - (a.likes?.length||0)).slice(0,10);
  const list = document.createElement('div'); list.style.marginTop='12px';
  top.forEach(p=>{
    const c = document.createElement('div'); c.className='post-card';
    c.innerHTML = `<div style="min-width:54px"><div class="avatar-sm">${(p.author||'U')[0].toUpperCase()}</div></div>
      <div class="post-main"><div class="post-meta"><strong>${escapeHtml(p.authorName)}</strong><span class="muted">@${escapeHtml(p.author)}</span></div>
      <div class="post-text">${escapeHtml(p.text)}</div></div>`;
    list.appendChild(c);
  });
  pageContent.appendChild(list);
}

function refreshRight(){
  const trends = document.getElementById('trends'); if(!trends) return;
  trends.innerHTML = '';
  const hashtags = {};
  (STATE.posts||[]).forEach(p=>{
    const matches = (p.text || '').match(/#\w+/g);
    if(matches) matches.forEach(h=>hashtags[h] = (hashtags[h]||0)+1);
  });
  const sorted = Object.entries(hashtags).sort((a,b)=>b[1]-a[1]).slice(0,6);
  if(sorted.length===0){
    const fallback = ['#–¥–∏–∑–∞–π–Ω','#–º—É–∑—ã–∫–∞','#–Ω–æ–≤–æ—Å—Ç–∏','#—á–∞—Ç','#—Å—Ç–∞—Ä—Ç–∞–ø'];
    fallback.forEach((t,i)=> {
      const el = document.createElement('div'); el.className='trend';
      el.innerHTML = `<div><small class="muted">–¢—Ä–µ–Ω–¥ ‚Ä¢ ${i+1}</small><div>${t}</div></div><div class="muted">‚ñ≤ ${Math.floor(Math.random()*900)+100}</div>`;
      trends.appendChild(el);
    });
  } else {
    sorted.forEach(([tag,count],i=>{
      const el = document.createElement('div'); el.className='trend';
      el.innerHTML = `<div><small class="muted">–¢—Ä–µ–Ω–¥ ‚Ä¢ ${i+1}</small><div>${escapeHtml(tag)}</div></div><div class="muted">‚ñ≤ ${count*10}</div>`;
      trends.appendChild(el);
    }));
  }

  const w = document.getElementById('whoToFollow'); if(!w) return;
  w.innerHTML = '';
  const candidates = (STATE.users||[]).filter(u=>u.username !== STATE.current?.username).slice(0,5);
  if(candidates.length===0){ w.innerHTML = `<div class="muted">–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</div>`; return; }
  candidates.forEach(u=>{
    const el = document.createElement('div'); el.className='who';
    el.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div style="width:44px;height:44px;background:var(--glass);display:flex;align-items:center;justify-content:center;border-radius:10px">${u.displayName?.[0]||u.username[0]}</div>
      <div style="min-width:0"><div style="font-weight:700">${escapeHtml(u.displayName||u.username)}</div><div class="muted" style="font-size:13px">@${escapeHtml(u.username)}</div></div></div>
      <div><button class="small" onclick="follow('${u.username}', this)">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button></div>`;
    w.appendChild(el);
  });
}

/* -------------------------
   Follow (–ª–æ–∫–∞–ª—å–Ω—ã–π)
   ------------------------- */
function follow(username, btn){
  if(!STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return }
  if(STATE.current.username === username){ toast('–ù–µ–ª—å–∑—è –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ–±—è'); return }
  const target = (STATE.users||[]).find(u=>u.username===username);
  if(!target) { toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  const me = (STATE.users||[]).find(u=>u.username===STATE.current.username);
  if(me.following.includes(username)){ me.following = me.following.filter(x=>x!==username); target.followers = target.followers.filter(x=>x!==me.username); if(btn) btn.textContent='–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'; }
  else { me.following.push(username); target.followers.push(me.username); if(btn) btn.textContent='–û—Ç–ø–∏—Å–∞—Ç—å—Å—è'; }
  STATE.current = me;
  saveAll();
  refreshUI();
  refreshRight();
}

/* -------------------------
   Chats (–ª–æ–∫–∞–ª—å–Ω—ã–µ)
   ------------------------- */
function renderChats(){
  const pageContent = document.getElementById('pageContent'); if(!pageContent) return;
  pageContent.innerHTML = '';
  const card = document.createElement('div'); card.className='auth-card'; card.innerHTML = `<div style="font-weight:800">–ß–∞—Ç—ã</div><div class="muted" style="margin-top:8px">–ü—Ä–æ—Å—Ç–æ–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä ‚Äî —Å–ø–∏—Å–∫–∏ —Å–ª–µ–≤–∞, –ø–µ—Ä–µ–ø–∏—Å–∫–∞ —Å–ø—Ä–∞–≤–∞</div>`;
  pageContent.appendChild(card);

  const layout = document.createElement('div'); layout.style.display='flex'; layout.style.gap='12px'; layout.style.marginTop='12px';
  const left = document.createElement('div'); left.style.width='220px'; left.className='auth-card'; left.style.padding='10px';
  (STATE.users||[]).forEach(u=>{
    if(!STATE.current || u.username === STATE.current.username) return;
    const item = document.createElement('div'); item.style.padding='8px'; item.style.cursor='pointer';
    item.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:36px;height:36px;border-radius:8px;background:var(--glass);display:flex;align-items:center;justify-content:center">${u.username[0]}</div><div><div style="font-weight:700">${escapeHtml(u.displayName||u.username)}</div><div class="muted" style="font-size:13px">@${escapeHtml(u.username)}</div></div></div>`;
    item.onclick = () => openChatWith(u.username);
    left.appendChild(item);
  });
  const right = document.createElement('div'); right.style.flex=1; right.className='auth-card'; right.id='chatArea'; right.style.minHeight='240px'; right.innerHTML = `<div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç —Å–ª–µ–≤–∞</div>`;
  layout.appendChild(left); layout.appendChild(right);
  pageContent.appendChild(layout);
}

function openChatWith(username){
  const area = document.getElementById('chatArea'); if(!area) return;
  area.innerHTML = '';
  const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center'; header.innerHTML = `<div style="font-weight:800">${username}</div><div class="muted">@${username}</div>`;
  area.appendChild(header);
  const convo = document.createElement('div'); convo.style.minHeight='220px'; convo.style.maxHeight='400px'; convo.style.overflowY='auto'; convo.style.marginTop='12px';
  const key = chatKey(STATE.current.username, username);
  const messages = STATE.chats[key] || [];
  messages.forEach(m=>{
    const bubble = document.createElement('div');
    bubble.style.maxWidth='70%'; bubble.style.padding='10px'; bubble.style.borderRadius='12px'; bubble.style.marginBottom='8px';
    if(m.sender === STATE.current.username){ bubble.style.background = 'linear-gradient(90deg,var(--accent),var(--accent-2))'; bubble.style.color='white'; bubble.style.marginLeft='auto'; }
    else { bubble.style.background = 'var(--glass)'; bubble.style.color='var(--text)'; }
    bubble.textContent = m.text; convo.appendChild(bubble);
  });
  area.appendChild(convo);
  const inputRow = document.createElement('div'); inputRow.style.display='flex'; inputRow.style.gap='8px'; inputRow.style.marginTop='12px';
  inputRow.innerHTML = `<input id="chatInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)"><button class="btn-primary small">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>`;
  area.appendChild(inputRow);
  inputRow.querySelector('button').onclick = () => {
    const text = document.getElementById('chatInput').value.trim(); if(!text) return;
    STATE.chats[key] = STATE.chats[key] || [];
    STATE.chats[key].push({sender: STATE.current.username, text, ts: new Date().toISOString()});
    saveAll();
    openChatWith(username);
  };
}
function chatKey(a,b){ return [a,b].sort().join('__'); }

/* -------------------------
   UI refresh
   ------------------------- */
function refreshUI(){
  const sideAvatar = document.getElementById('sideAvatar');
  const sideName = document.getElementById('sideName');
  const sideHandle = document.getElementById('sideHandle');
  if(STATE.current){
    if(sideAvatar) sideAvatar.textContent = (STATE.current.displayName || STATE.current.username)[0].toUpperCase();
    if(sideName) sideName.textContent = STATE.current.displayName || STATE.current.username;
    if(sideHandle) sideHandle.textContent = `@${STATE.current.username}`;
    const cAv = document.getElementById('composerAvatar');
    if(cAv) cAv.textContent = (STATE.current.displayName || STATE.current.username)[0].toUpperCase();
  } else {
    if(sideAvatar) sideAvatar.textContent = 'G';
    if(sideName) sideName.textContent = '–ì–æ—Å—Ç—å';
    if(sideHandle) sideHandle.textContent = '@guest';
    const cAv = document.getElementById('composerAvatar');
    if(cAv) cAv.textContent = 'U';
  }
  refreshRight();
}

/* -------------------------
   Misc pages
   ------------------------- */
function showFeed(){ activateNav('btnFeed'); showComposerInline(true); renderFeed(); }
function showExplore(){ activateNav('btnExplore'); showComposerInline(false); renderExplore(); }
function showChats(){ activateNav('btnMessages'); showComposerInline(false); renderChats(); }
function showProfile(){ activateNav('btnProfile'); showComposerInline(false); renderProfile(); }
function showDrafts(){ activateNav('btnDrafts'); showComposerInline(false); showAlert('–ß–µ—Ä–Ω–æ–≤–∏–∫–∏: –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞'); }
function activateNav(id){ document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active')); const el = document.getElementById(id); if(el) el.classList.add('active'); }
function showAlert(msg){ alert(msg); }

/* -------------------------
   Helpers
   ------------------------- */
function timeAgo(d){
  if(typeof d === 'string') d = new Date(d);
  const s = Math.floor((Date.now() - d.getTime())/1000);
  if(s < 60) return `${s}s`;
  if(s < 3600) return `${Math.floor(s/60)}m`;
  if(s < 86400) return `${Math.floor(s/3600)}h`;
  return `${Math.floor(s/86400)}d`;
}
function escapeHtml(str){
  if(!str) return '';
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function linkify(text){
  if(!text) return '';
  return text
    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:var(--accent)">$1</a>')
    .replace(/#(\w+)/g, '<span style="color:var(--accent)">#$1</span>')
    .replace(/@(\w+)/g, '<span style="color:var(--muted)">@\$1</span>');
}

/* -------------------------
   Seed demo if first run
   ------------------------- */
(function seedDemo(){
  try{
    if(localStorage.getItem('nn_seeded')) return;
    const demoUsers = [
      { id:uid(), username:'alice', password:'123', displayName:'–ê–ª–∏—Å–∞', bio:'–õ—é–±–ª—é –º—É–∑—ã–∫—É –∏ –∫–æ—Ñ–µ', avatar:'', followers:[], following:[] },
      { id:uid(), username:'bob', password:'123', displayName:'–ë–æ–±', bio:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', avatar:'', followers:[], following:[] },
      { id:uid(), username:'carla', password:'123', displayName:'–ö–∞—Ä–ª–∞', bio:'–§–æ—Ç–æ–≥—Ä–∞—Ñ', avatar:'', followers:[], following:[] }
    ];
    STATE.users = demoUsers;
    STATE.posts = [
      { id:uid(), author:'alice', authorName:'–ê–ª–∏—Å–∞', avatar:'', text:'–ü–µ—Ä–≤—ã–π –ø–æ—Å—Ç –≤ NovaNet! #–¥–∏–∑–∞–π–Ω', media:'', likes:[], comments:[], reposts:0, createdAt:new Date(Date.now()-3600*1000).toISOString() },
      { id:uid(), author:'bob', authorName:'–ë–æ–±', avatar:'', text:'–°–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç: https://example.com', media:'', likes:[], comments:[], reposts:0, createdAt:new Date(Date.now()-7200*1000).toISOString() },
      { id:uid(), author:'carla', authorName:'–ö–∞—Ä–ª–∞', avatar:'', text:'–§–æ—Ç–æ —Å –ø—Ä–æ–≥—É–ª–∫–∏', media:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect width="100%" height="100%" fill="%230b1220"/><text x="50%" y="50%" fill="%23ffffff" font-size="30" font-family="Arial" text-anchor="middle">–ü—Ä–∏–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</text></svg>', likes:[], comments:[], reposts:0, createdAt:new Date(Date.now()-1000*60*60*24).toISOString() }
    ];
    localStorage.setItem('nn_seeded','1');
    saveAll();
  }catch(e){ console.warn('seed error', e); }
})();

/* -------------------------
   Boot wiring
   ------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  applyTheme();
  attachComposerCounter();
  refreshUI();
  renderFeed();
  refreshRight();
  // if current exists and Firebase later initializes, onAuthStateChanged will handle.
});

/* paste image convenience */
document.addEventListener('paste', (e)=>{
  if(!e.clipboardData) return;
  const items = e.clipboardData.items; if(!items) return;
  for(let i=0;i<items.length;i++){
    const it = items[i];
    if(it.kind === 'file'){
      const blob = it.getAsFile();
      if(blob && blob.type.startsWith('image/')){
        const reader = new FileReader();
        reader.onload = ()=>{
          const preview = document.getElementById('composerPreview');
          if(preview){
            preview.innerHTML = `<img src="${reader.result}" style="max-width:160px;border-radius:8px">`;
            preview.dataset.img = reader.result;
            toast('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ (–≤—Å—Ç–∞–≤–∫–∞)');
          }
        };
        reader.readAsDataURL(blob);
      }
    }
  }
});
</script>

<!-- ===============================
     Firebase integration (–º–æ–¥—É–ª—å)
     - —Ä–∞—Å—à–∏—Ä—è–µ—Ç –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Firebase
================================= -->
<script type="module">
/*
  –ú–æ–¥—É–ª—å Firebase:
  - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Firebase SDK (v9 –º–æ–¥—É–ª—å–Ω–∞—è)
  - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç posts –∏ users –≤ window.STATE
  - –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏, —á—Ç–æ —Ç–µ–∫—É—â–∏–π user –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –æ–±–ª–∞–∫–µ, –¥–µ–ª–∞–µ—Ç signOut –∏ –æ—á–∏—â–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π current
  - –¥–æ–±–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞/–¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±–ª–∞–∫–∞ (deleteMyAccountCloud)
*/

/* --------- –ò–º–ø–æ—Ä—Ç—ã SDK (–º–æ–¥—É–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, updateDoc, arrayUnion, arrayRemove, where, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

/* --------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase: –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
  authDomain: "nova-prospect-chat.firebaseapp.com",
  projectId: "nova-prospect-chat",
  storageBucket: "nova-prospect-chat.firebasestorage.app",
  messagingSenderId: "256806164650",
  appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
  measurementId: "G-9V0Q2E2FNB"
};

/* --------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–±–µ–∑ —Ñ–∞—Ç–∞–ª–∞) ---------- */
let firebaseApp, auth, db, storage;
try {
  firebaseApp = initializeApp(firebaseConfig);
  auth = getAuth(firebaseApp);
  db = getFirestore(firebaseApp);
  storage = getStorage(firebaseApp);
  console.log("Firebase initialized");
} catch (err) {
  console.warn("Firebase init failed:", err);
}

/* --------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥—É–ª—è ---------- */
function emailLike(input) { return typeof input === 'string' && input.includes('@'); }
function usernameFromEmail(email) { if(!email) return null; return email.split('@')[0]; }

/* --------- –ï—Å–ª–∏ Firebase –¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞—Å—à–∏—Ä—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ ---------- */
if (typeof auth !== 'undefined' && auth && typeof db !== 'undefined' && db) {

  // expose signOut wrapper for global logout
  window.firebaseSignOut = async function() { try { await signOut(auth); } catch(e){ console.warn("firebase signOut failed", e); } };

  // helper: find local user in window.STATE.users by uid or username
  function localFindUserMatch(ud) {
    if(!ud) return null;
    const arr = window.STATE.users || [];
    return arr.find(u=> (u.uid && ud.uid && (u.uid===ud.uid)) || (u.username && ud.username && (u.username===ud.username)) || (u.username && ud.email && u.username===usernameFromEmail(ud.email)));
  }

  // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º window.STATE.current
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      try {
        // Ensure user doc exists
        const udocRef = doc(db, "users", user.uid);
        const snap = await getDoc(udocRef);
        if (!snap.exists()) {
          const username = user.displayName ? user.displayName.replace(/\s+/g, '') : usernameFromEmail(user.email) || ("u"+Date.now());
          await setDoc(udocRef, {
            uid: user.uid,
            email: user.email || null,
            username: username,
            displayName: user.displayName || username,
            bio: "",
            followers: [],
            following: []
          });
        }
        const userDoc = await getDoc(udocRef);
        const ud = userDoc.data();
        window.STATE.current = {
          id: ud.uid, uid: ud.uid, username: ud.username, displayName: ud.displayName || ud.username,
          bio: ud.bio || "", avatar: ud.avatar || "", followers: ud.followers || [], following: ud.following || []
        };
        localStorage.setItem('nn_current', JSON.stringify(window.STATE.current));
        // load users and posts
        await loadUsersFromFirestore();
        toast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω (Firebase)');
        try{ refreshUI(); showApp(); }catch(e){ console.warn(e); }
      } catch(e){ console.error('onAuthStateChanged handling error', e); }
    } else {
      console.log('User signed out (firebase)');
      // –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ current —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –≤ –æ–±–ª–∞–∫–µ ‚Äî —Å–±—Ä–æ—Å–∏–º
      // –ù–û –Ω–µ —É–±–∏—Ä–∞–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ posts, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ
    }
  });

  /* --------- –°–ª—É—à–∞–µ–º posts –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ---------- */
  try {
    const postsColl = collection(db, "posts");
    const q = query(postsColl, orderBy("createdAt", "desc"));
    onSnapshot(q, (snap) => {
      const arr = [];
      snap.forEach(docSnap => {
        const data = docSnap.data();
        arr.push({
          id: docSnap.id,
          author: data.author || (data.authorName || "unknown"),
          authorName: data.authorName || data.author,
          authorUid: data.authorUid || null,
          text: data.text || "",
          media: data.media || "",
          likes: data.likes || [],
          comments: data.comments || [],
          reposts: data.reposts || 0,
          createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().toISOString() : data.createdAt) : new Date().toISOString()
        });
      });
      window.STATE.posts = arr;
      saveAll();
      try{ renderFeed(); }catch(e){ console.warn(e); }
    }, err => { console.warn("onSnapshot posts error:", err); });
  } catch(e){ console.warn('listen posts failed', e); }

  /* --------- Load users from Firestore ---------- */
  async function loadUsersFromFirestore(){
    try {
      const usersSnapshot = await getDocs(collection(db, "users"));
      const arr = [];
      usersSnapshot.forEach(s => {
        const d = s.data();
        arr.push({
          id: d.uid || s.id,
          uid: d.uid || s.id,
          username: d.username || (d.email ? usernameFromEmail(d.email) : s.id),
          displayName: d.displayName || d.username || (d.email?usernameFromEmail(d.email):s.id),
          bio: d.bio || "",
          avatar: d.avatar || "",
          followers: d.followers || [],
          following: d.following || []
        });
      });
      window.STATE.users = arr;
      saveAll();
      refreshUI();
      refreshRight();

      // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π current –µ—Å—Ç—å, –Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ–±–ª–∞–∫–µ -> signOut & clear current
      if(window.STATE.current && window.STATE.current.uid){
        const found = arr.find(u=>u.uid === window.STATE.current.uid || u.username === window.STATE.current.username);
        if(!found){
          // —É–¥–∞–ª–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–±–ª–∞–∫–µ ‚Äî –≤—ã–π–¥–µ–º –∏ —Å–±—Ä–æ—Å–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π current
          try {
            await signOut(auth);
          } catch(e){ console.warn('signOut after missing user failed', e); }
          window.STATE.current = null;
          localStorage.setItem('nn_current', null);
          saveAll();
          toast('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω –≤ –æ–±–ª–∞–∫–µ ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∑–∞–Ω–æ–≤–æ');
          showAuth();
        }
      }
    } catch (err) {
      console.warn("loadUsersFromFirestore error", err);
    }
  }

  /* --------- Override local actionRegister to use Firebase when email provided ---------- */
  window.actionRegister = async function(){
    const up_user = (document.getElementById('up_user')?.value || '').trim();
    const up_pass = (document.getElementById('up_pass')?.value || '').trim();
    const up_name = (document.getElementById('up_name')?.value || '').trim() || up_user;
    if(!up_user || !up_pass){ toast('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω (email) –∏ –ø–∞—Ä–æ–ª—å'); return; }
    if(emailLike(up_user)){
      try {
        const cred = await createUserWithEmailAndPassword(auth, up_user, up_pass);
        // create user doc
        const username = (up_name.replace(/\s+/g,'') || usernameFromEmail(up_user));
        await setDoc(doc(db, "users", cred.user.uid), {
          uid: cred.user.uid,
          email: up_user,
          username: username,
          displayName: up_name,
          bio: "",
          followers: [],
          following: []
        });
        try { await sendEmailVerification(cred.user); toast('–ü–∏—Å—å–º–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); } catch(e){ /* ignore */ }
        toast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ (Firebase)');
        // onAuthStateChanged –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É current
      } catch (err) {
        console.error(err);
        toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (err.message || err.code));
      }
    } else {
      // fallback to local
      return window.__original_actionRegister ? window.__original_actionRegister() : null;
    }
  };

  /* --------- Override local actionLogin to use Firebase when email provided ---------- */
  window.actionLogin = async function(){
    const in_user = (document.getElementById('in_user')?.value || '').trim();
    const in_pass = (document.getElementById('in_pass')?.value || '').trim();
    if(!in_user || !in_pass){ toast('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω (email) –∏ –ø–∞—Ä–æ–ª—å'); return; }
    if(emailLike(in_user)){
      try {
        await signInWithEmailAndPassword(auth, in_user, in_pass);
        toast('–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Firebase –≤—ã–ø–æ–ª–Ω–µ–Ω');
        // onAuthStateChanged –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–µ
      } catch (err) {
        console.error(err);
        toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (err.message || err.code));
      }
    } else {
      return window.__original_actionLogin ? window.__original_actionLogin() : null;
    }
  };

  /* --------- Override publishPost to push to Firestore ---------- */
  window.publishPost = async function(){
    if(!window.STATE.current){ toast('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç'); return; }
    const txt = document.getElementById('composerText'); const preview = document.getElementById('composerPreview');
    if(!txt || !preview){ toast('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞'); return; }
    const content = (txt.value || '').trim();
    if(!content && !preview.dataset.img){ toast('–ü—É—Å—Ç–æ–π –ø–æ—Å—Ç'); return; }
    try {
      let mediaUrl = "";
      if(preview.dataset.img){
        const filename = "posts/" + Date.now() + "_" + Math.random().toString(36).slice(2,10);
        const ref = storageRef(storage, filename);
        await uploadString(ref, preview.dataset.img, 'data_url');
        mediaUrl = await getDownloadURL(ref);
      }
      const p = {
        author: window.STATE.current.username,
        authorName: window.STATE.current.displayName || window.STATE.current.username,
        authorUid: window.STATE.current.uid || window.STATE.current.id || null,
        text: content,
        media: mediaUrl,
        likes: [],
        comments: [],
        reposts: 0,
        createdAt: serverTimestamp()
      };
      await addDoc(collection(db, "posts"), p);
      txt.value = ''; preview.innerHTML = ''; delete preview.dataset.img;
      const counter = document.getElementById('charsLeft'); if(counter) counter.textContent = 280;
      toast('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω (–æ–±–ª–∞–∫–æ)');
    } catch (err) {
      console.error('publishPost error', err);
      toast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + (err.message || err.code));
    }
  };

  /* --------- Override toggleLike to update Firestore (arrayUnion/arrayRemove) ---------- */
  window.toggleLike = async function(postId){
    if(!window.STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return; }
    try {
      const postDoc = doc(db, "posts", postId);
      const post = (window.STATE.posts || []).find(p=>p.id===postId);
      const username = window.STATE.current.username;
      if(post && post.likes && post.likes.includes(username)) { await updateDoc(postDoc, { likes: arrayRemove(username) }); }
      else { await updateDoc(postDoc, { likes: arrayUnion(username) }); }
    } catch (err) { console.error('toggleLike error', err); toast('–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞'); }
  };

  /* --------- Override openComments to push comments to Firestore ---------- */
  window.openComments = async function(postId){
    if(!window.STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return; }
    const text = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:');
    if(!text || !text.trim()) return;
    try {
      const postDoc = doc(db, "posts", postId);
      const commentObj = { id: "c"+Date.now(), user: window.STATE.current.username, text: text.trim(), createdAt: new Date().toISOString() };
      await updateDoc(postDoc, { comments: arrayUnion(commentObj) });
      toast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
    } catch (err) { console.error('openComments error', err); toast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'); }
  };

  /* --------- Override follow to modify users documents in Firestore ---------- */
  window.follow = async function(username, btn){
    if(!window.STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return; }
    if(window.STATE.current.username === username){ toast('–ù–µ–ª—å–∑—è –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ–±—è'); return; }
    try {
      const usersSnap = await getDocs(collection(db,"users"));
      let targetDoc = null, myDoc = null;
      usersSnap.forEach(snap=>{
        const d = snap.data();
        if(d.username === username) targetDoc = { ref: doc(db, "users", snap.id), data: d };
        if(d.username === window.STATE.current.username) myDoc = { ref: doc(db, "users", snap.id), data: d };
      });
      if(!targetDoc || !myDoc){ toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ–±–ª–∞–∫–µ'); return; }
      const meUsername = window.STATE.current.username;
      const already = (targetDoc.data.followers || []).includes(meUsername);
      if(already){
        await updateDoc(targetDoc.ref, { followers: arrayRemove(meUsername) });
        await updateDoc(myDoc.ref, { following: arrayRemove(username) });
        if(btn) btn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
      } else {
        await updateDoc(targetDoc.ref, { followers: arrayUnion(meUsername) });
        await updateDoc(myDoc.ref, { following: arrayUnion(username) });
        if(btn) btn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è';
      }
      await loadUsersFromFirestore();
      toast('–ü–æ–¥–ø–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–æ–±–ª–∞–∫–æ)');
    } catch (err) { console.error('follow error', err); toast('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏'); }
  };

  /* --------- Delete my account & cloud data (attempt) ---------- */
  window.deleteMyAccountCloud = async function(){
    if(!window.STATE.current){ toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥'); return; }
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∏ –≤—Å–µ –≤–∞—à–∏ –ø–æ—Å—Ç—ã –≤ –æ–±–ª–∞–∫–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
    try {
      const uid = window.STATE.current.uid || window.STATE.current.id;
      if(!uid){ toast('UID –Ω–µ –∏–∑–≤–µ—Å—Ç–µ–Ω ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ –ª–æ–∫–∞–ª—å–Ω–∞—è —É—á—ë—Ç–∫–∞.'); return; }
      // 1) —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const postsSnap = await getDocs(collection(db, "posts"));
      const deletes = [];
      postsSnap.forEach(snap=>{
        const d = snap.data();
        // —É–¥–∞–ª—è–µ–º –ø–æ—Å—Ç, –µ—Å–ª–∏ authorUid === uid OR author === username
        if(d.authorUid === uid || d.author === window.STATE.current.username){
          deletes.push(deleteDoc(doc(db, "posts", snap.id)));
        }
      });
      await Promise.allSettled(deletes);
      // 2) —É–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await deleteDoc(doc(db, "users", uid));
      // 3) —É–¥–∞–ª–∏—Ç—å auth –∞–∫–∫–∞—É–Ω—Ç (–ø–æ–ø—ã—Ç–∫–∞)
      try {
        const user = auth.currentUser;
        if(user && user.uid === uid){
          await user.delete();
        } else {
          // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç uid ‚Äî –ø–æ—Ç—Ä–µ–±—É–π –≤—Ö–æ–¥
          toast('–£–¥–∞–ª–µ–Ω–∏–µ auth-–∞–∫–∫–∞—É–Ω—Ç–∞: –Ω—É–∂–µ–Ω –Ω–µ–¥–∞–≤–Ω–∏–π –≤—Ö–æ–¥. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.');
        }
      } catch(e){
        console.warn('delete auth user failed', e);
        toast('–£–¥–∞–ª–µ–Ω–æ –≤ Firestore (–ø–æ—Å—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç). –£–¥–∞–ª–µ–Ω–∏–µ auth-–∞–∫–∫–∞—É–Ω—Ç–∞ –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.');
      }
      // –ª–æ–∫–∞–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º current
      window.STATE.current = null; localStorage.setItem('nn_current', null); saveAll();
      toast('–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞ (–ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏).');
      showAuth();
    } catch(err){
      console.error('deleteMyAccountCloud error', err);
      toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –∏–∑ –æ–±–ª–∞–∫–∞');
    }
  };

  // –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤–∏—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É users
  loadUsersFromFirestore().catch(e=>console.warn('initial load users failed', e));
} else {
  console.warn("Firebase not initialized ‚Äî cloud features unavailable");
}

/* –∫–æ–Ω–µ—Ü –º–æ–¥—É–ª—è Firebase */
</script>

</body>
</html>

