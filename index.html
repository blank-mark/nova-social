<!--
UPDATED FULL VERSION
- Messages: mine right, others left
- Time HH:MM
- Persistent conversations collection
- Real conversation metadata (participants, lastMessage)
- Notifications (browser)
- Image upload fixed via getDownloadURL
- Stickers rendered as emoji pack
- Favorites system
-->

<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nova Prospect Chat</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
  authDomain: "nova-prospect-chat.firebaseapp.com",
  projectId: "nova-prospect-chat",
  storageBucket: "nova-prospect-chat.appspot.com",
  messagingSenderId: "256806164650",
  appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
  measurementId: "G-9V0Q2E2FNB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

let currentUser;
let currentConversation;

const loginBtn = document.getElementById("login");
const chat = document.getElementById("chat");
const messagesDiv = document.getElementById("messages");

loginBtn.onclick = () => signInWithPopup(auth, provider);

onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  currentUser = user;
  loginBtn.style.display = "none";
  chat.style.display = "flex";
  await setDoc(doc(db, "users", user.uid), {
    name: user.displayName,
    photo: user.photoURL
  }, { merge: true });
});

function formatTime(ts){
  if(!ts) return "";
  const d = ts.toDate();
  return d.getHours().toString().padStart(2,'0')+":"+
         d.getMinutes().toString().padStart(2,'0');
}

async function openConversation(otherUid){
  const convoId = [currentUser.uid, otherUid].sort().join("_");
  currentConversation = convoId;

  await setDoc(doc(db, "conversations", convoId), {
    participants: [currentUser.uid, otherUid],
    updated: serverTimestamp()
  }, { merge:true });

  const q = query(collection(db, "conversations", convoId, "messages"), orderBy("timestamp"));
  onSnapshot(q, snap => {
    messagesDiv.innerHTML = "";
    snap.forEach(docu => {
      const m = docu.data();
      const div = document.createElement("div");
      div.className = m.sender === currentUser.uid ? "mine" : "theirs";

      let content = "";
      if(m.type === "text") content = m.text;
      if(m.type === "image") content = `<img src="${m.url}" width="200">`;
      if(m.type === "sticker") content = `<span style='font-size:40px'>${m.sticker}</span>`;

      div.innerHTML = `
        <div>${content}</div>
        <div class='time'>${formatTime(m.timestamp)}</div>
      `;

      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  });
}

window.sendText = async () => {
  const input = document.getElementById("msg");
  if(!input.value) return;
  await addDoc(collection(db, "conversations", currentConversation, "messages"), {
    sender: currentUser.uid,
    type: "text",
    text: input.value,
    timestamp: serverTimestamp()
  });
  input.value = "";
};

window.sendImage = async (file) => {
  const imageRef = ref(storage, `images/${currentUser.uid}/${Date.now()}_${file.name}`);
  await uploadBytes(imageRef, file);
  const url = await getDownloadURL(imageRef);

  await addDoc(collection(db, "conversations", currentConversation, "messages"), {
    sender: currentUser.uid,
    type: "image",
    url,
    timestamp: serverTimestamp()
  });
};

window.sendSticker = async (emoji) => {
  await addDoc(collection(db, "conversations", currentConversation, "messages"), {
    sender: currentUser.uid,
    type: "sticker",
    sticker: emoji,
    timestamp: serverTimestamp()
  });
};

if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

</script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white}
#chat{display:none;flex-direction:column;height:100vh}
#messages{flex:1;overflow:auto;padding:10px}
.mine{background:#6366f1;margin:5px 0 5px auto;padding:10px;border-radius:15px;max-width:60%;text-align:right}
.theirs{background:#1e293b;margin:5px auto 5px 0;padding:10px;border-radius:15px;max-width:60%}
.time{font-size:11px;opacity:0.7;margin-top:4px}
.bottom{display:flex;padding:10px;background:#111827}
input{flex:1;padding:10px;border:none;border-radius:10px}
button{margin-left:5px;padding:10px;border:none;border-radius:10px;background:#6366f1;color:white}
</style>
</head>

<body>
<button id="login">Ð’Ð¾Ð¹Ñ‚Ð¸ Ñ‡ÐµÑ€ÐµÐ· Google</button>

<div id="chat">
  <div id="messages"></div>
  <div class="bottom">
    <input id="msg" placeholder="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ">
    <button onclick="sendText()">âž¤</button>
    <input type="file" onchange="sendImage(this.files[0])">
    <button onclick="sendSticker('ðŸ”¥')">ðŸ”¥</button>
    <button onclick="sendSticker('ðŸ˜‚')">ðŸ˜‚</button>
  </div>
</div>

</body>
</html>
