<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nova Prospect ‚Äî Chat (Telegram style)</title>

<!-- Basic styling: telegram-like, responsive -->
<style>
  :root{
    --bg:#f6f7fb;
    --sidebar:#ffffff;
    --accent:#2b9df4;
    --muted:#9aa4b2;
    --bubble-me:#d2f1ff;
    --bubble-other:#ffffff;
    --max-width:1100px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:#111}
  .app{max-width:var(--max-width);margin:12px auto;height:calc(100vh - 24px);display:flex;border-radius:10px;overflow:hidden;box-shadow:0 6px 30px rgba(16,24,40,0.08)}
  /* Sidebar */
  .sidebar{width:340px;background:var(--sidebar);display:flex;flex-direction:column;border-right:1px solid rgba(16,24,40,0.06)}
  .sb-header{padding:16px;border-bottom:1px solid rgba(16,24,40,0.04);display:flex;align-items:center;gap:12px}
  .sb-logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6fb9ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  .sb-title{font-size:16px;font-weight:600}
  .sb-search{padding:12px;border-bottom:1px solid rgba(16,24,40,0.04)}
  .search-input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(16,24,40,0.06);background:#f2f5fb}
  .chats{flex:1;overflow:auto;padding:8px}
  .chat-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;cursor:pointer}
  .chat-item:hover{background:rgba(43,157,244,0.06)}
  .avatar{width:48px;height:48px;border-radius:12px;background:#ddd;flex-shrink:0;object-fit:cover}
  .chat-main{flex:1;min-width:0}
  .chat-name{font-weight:600}
  .chat-last{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sb-footer{padding:10px;border-top:1px solid rgba(16,24,40,0.04);display:flex;flex-direction:column;gap:8px}
  .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(16,24,40,0.06);color:#111}
  /* Main */
  .main{flex:1;display:flex;flex-direction:column;background:linear-gradient(180deg,#fff,#fbfdff)}
  .main-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(16,24,40,0.04)}
  .main-avatar{width:44px;height:44px;border-radius:10px;object-fit:cover}
  .main-title{font-weight:700}
  .messages{flex:1;padding:18px;overflow:auto;background:linear-gradient(180deg, #f7fbff00, #f6f7fb)}
  .message-row{display:flex;margin-bottom:10px;align-items:flex-end}
  .message-row.me{justify-content:flex-end}
  .bubble{max-width:66%;padding:10px 12px;border-radius:14px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
  .bubble.me{background:var(--bubble-me);border-bottom-right-radius:6px}
  .bubble.other{background:var(--bubble-other);border-bottom-left-radius:6px}
  .msg-meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .msg-img{max-width:280px;border-radius:8px;display:block}
  .msg-audio{display:block;width:240px}
  .composer{padding:12px;border-top:1px solid rgba(16,24,40,0.04);display:flex;gap:8px;align-items:center}
  .composer textarea{flex:1;min-height:44px;max-height:160px;padding:10px;border-radius:10px;border:1px solid rgba(16,24,40,0.06);resize:none}
  .compose-actions{display:flex;gap:8px;align-items:center}
  .icon-btn{width:40px;height:40px;border-radius:10px;border:1px solid rgba(16,24,40,0.06);display:flex;align-items:center;justify-content:center;cursor:pointer;background:white}
  .small{font-size:13px;color:var(--muted)}
  /* Responsive */
  @media (max-width:900px){
    .sidebar{width:100%;height:42%;order:1}
    .main{height:58%}
    .app{flex-direction:column;height:calc(100vh - 24px)}
  }
  @media (max-width:480px){
    .sidebar{height:44%}
    .main{height:56%}
    .avatar{width:40px;height:40px}
    .chat-item{padding:8px}
    .messages{padding:12px}
    .bubble{max-width:78%}
  }
</style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sb-header">
      <div class="sb-logo">NP</div>
      <div>
        <div class="sb-title">Nova Prospect</div>
        <div class="small">–ë—ã—Å—Ç—Ä—ã–π —á–∞—Ç</div>
      </div>
    </div>

    <div class="sb-search">
      <input id="globalSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ username –∏–ª–∏ –∏–º—è...">
    </div>

    <div class="chats" id="chatsList">
      <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (dmThreads) —Å—é–¥–∞ -->
    </div>

    <div class="sb-footer">
      <div id="authBlock">
        <!-- auth UI inserted by JS -->
      </div>
      <button id="newChatBtn" class="btn ghost">–ù–æ–≤—ã–π —á–∞—Ç (–ø–æ username)</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="main-header" id="mainHeader">
      <img id="peerAvatar" class="main-avatar" src="https://via.placeholder.com/44?text=?" alt="avatar">
      <div>
        <div id="peerName" class="main-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
        <div id="peerSub" class="small">–û–Ω–ª–∞–π–Ω</div>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <div class="compose-actions">
        <input id="imageInput" type="file" accept="image/*" style="display:none">
        <button id="imageBtn" class="icon-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>

        <button id="recordBtn" class="icon-btn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å">üéôÔ∏è</button>
      </div>

      <textarea id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)"></textarea>

      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase v12 modules -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc, getDocs, runTransaction, where, limit
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

  // --- Firebase config (—Ç–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è) ---
  const firebaseConfig = {
    apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
    authDomain: "nova-prospect-chat.firebaseapp.com",
    projectId: "nova-prospect-chat",
    storageBucket: "nova-prospect-chat.firebasestorage.app",
    messagingSenderId: "256806164650",
    appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
    measurementId: "G-9V0Q2E2FNB"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // --- UI refs ---
  const chatsList = document.getElementById('chatsList');
  const globalSearch = document.getElementById('globalSearch');
  const authBlock = document.getElementById('authBlock');
  const newChatBtn = document.getElementById('newChatBtn');

  const peerAvatar = document.getElementById('peerAvatar');
  const peerName = document.getElementById('peerName');
  const peerSub = document.getElementById('peerSub');

  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  const imageBtn = document.getElementById('imageBtn');
  const imageInput = document.getElementById('imageInput');
  const recordBtn = document.getElementById('recordBtn');

  // --- auth UI (simple) ---
  function renderAuthUI(user) {
    authBlock.innerHTML = '';
    if (!user) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <input id="email" placeholder="Email" style="padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.06)">
        <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.06)">
        <input id="signupUsername" placeholder="username (–ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)" style="padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.06)">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="googleSignIn" class="btn">Google</button>
          <button id="emailSignUp" class="btn ghost">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
      `;
      authBlock.appendChild(wrapper);
      document.getElementById('googleSignIn').onclick = async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch(e){ alert(e.message); }
      };
      document.getElementById('emailSignUp').onclick = async () => {
        const email = wrapper.querySelector('#email').value.trim();
        const pass = wrapper.querySelector('#password').value;
        const desired = wrapper.querySelector('#signupUsername').value.trim().toLowerCase();
        if (!email || !pass) return alert('Email –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
        try {
          const uc = await createUserWithEmailAndPassword(auth, email, pass);
          if (desired) {
            try { await createUsernameForUid(desired, uc.user.uid, email.split('@')[0]); }
            catch(err){ console.warn(err); alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: username –Ω–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω ('+err+')'); }
          }
          alert('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
        } catch(e){ alert(e.message); }
      };
    } else {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center">
          <img src="${user.photoURL||'https://via.placeholder.com/48?text=?'}" style="width:48px;height:48px;border-radius:10px;object-fit:cover">
          <div>
            <div style="font-weight:700">${user.displayName||'(–±–µ–∑ –∏–º–µ–Ω–∏)'}</div>
            <div class="small">${user.email||''}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="signOut" class="btn ghost">–í—ã–π—Ç–∏</button>
        </div>
      `;
      authBlock.appendChild(wrapper);
      document.getElementById('signOut').onclick = async () => {
        if (unsubscribeThreads) unsubscribeThreads();
        await signOut(auth);
      };
    }
  }

  // --- username helpers (same as —Ä–∞–Ω—å—à–µ) ---
  import { runTransaction as rT } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js"; // alias for clarity
  async function createUsernameForUid(usernameRaw, uid, displayName = null) {
    const username = sanitizeUsername(usernameRaw);
    if (!username) throw '–ù–µ–≤–µ—Ä–Ω—ã–π username';
    const unameRef = doc(db, 'usernames', username);
    const profileRef = doc(db, 'profiles', uid);
    try {
      await runTransaction(db, async (tx) => {
        const unameSnap = await tx.get(unameRef);
        if (unameSnap.exists()) throw new Error('USERNAME_TAKEN');
        tx.set(unameRef, { owner: uid, createdAt: serverTimestamp() });
        tx.set(profileRef, { username, displayName: displayName || null, updatedAt: serverTimestamp() }, { merge: true });
      });
      return true;
    } catch (e) {
      if (String(e).includes('USERNAME_TAKEN')) throw '–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç';
      throw e.message || e;
    }
  }
  function sanitizeUsername(s) { if (!s) return null; const low = s.toLowerCase(); if (!/^[a-z0-9_]{3,32}$/.test(low)) return null; return low; }

  // --- threads list (recent chats) ---
  let unsubscribeThreads = null;
  async function subscribeMyThreads(uid) {
    if (unsubscribeThreads) unsubscribeThreads();
    const q = query(collection(db, 'dmThreads'), where('participants', 'array-contains', uid), orderBy('createdAt', 'desc'));
    unsubscribeThreads = onSnapshot(q, async (snap) => {
      chatsList.innerHTML = '';
      if (snap.empty) {
        chatsList.innerHTML = '<div class="small" style="padding:12px">–ù–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–π–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—á–Ω–∏ –¥–∏–∞–ª–æ–≥.</div>';
        return;
      }
      for (const docSnap of snap.docs) {
        const data = docSnap.data();
        const otherUid = data.participants.find(x => x !== uid);
        const profile = (await getDoc(doc(db, 'profiles', otherUid))).data() || {};
        const el = document.createElement('div');
        el.className = 'chat-item';
        el.innerHTML = `
          <img src="${profile.photoURL||'https://via.placeholder.com/48?text=?'}" class="avatar">
          <div class="chat-main">
            <div class="chat-name">${profile.username||profile.displayName||otherUid}</div>
            <div class="chat-last small">${data.lastMessageText?data.lastMessageText.slice(0,60):'–ù–æ–≤—ã–π —á–∞—Ç'}</div>
          </div>
        `;
        el.onclick = () => openDirectChat({ uid: otherUid, username: profile.username, displayName: profile.displayName });
        chatsList.appendChild(el);
      }
    }, (err) => {
      console.warn('threads sub err', err);
    });
  }

  // --- search by username (globalSearch) ---
  globalSearch.oninput = debounce(async (e) => {
    const q = e.target.value.trim().toLowerCase();
    chatsList.innerHTML = '<div class="small" style="padding:12px">–ü–æ–∏—Å–∫...</div>';
    if (!q) { // re-subscribe my threads if logged in
      const user = auth.currentUser;
      if (user) subscribeMyThreads(user.uid);
      return;
    }
    try {
      const unameSnap = await getDoc(doc(db, 'usernames', q));
      chatsList.innerHTML = '';
      if (unameSnap.exists()) {
        const owner = unameSnap.data().owner;
        const prof = (await getDoc(doc(db, 'profiles', owner))).data() || {};
        const el = document.createElement('div');
        el.className = 'chat-item';
        el.innerHTML = `
          <img src="${prof.photoURL||'https://via.placeholder.com/48?text=?'}" class="avatar">
          <div class="chat-main">
            <div class="chat-name">${prof.displayName||q}</div>
            <div class="chat-last small">@${q}</div>
          </div>
        `;
        el.onclick = () => openDirectChat({ uid: owner, username: q, displayName: prof.displayName });
        chatsList.appendChild(el);
      } else {
        chatsList.innerHTML = '<div class="small" style="padding:12px">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
      }
    } catch (err) {
      console.warn(err); chatsList.innerHTML = '<div class="small" style="padding:12px">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
    }
  }, 350);

  // --- DM thread helpers ---
  function threadIdFor(u1, u2){ const ids=[u1,u2].sort(); return ids[0] + '_' + ids[1]; }
  let unsubscribeMessages = null;
  let currentPeer = null;
  let currentThreadId = null;

  async function ensureThreadExistsAndSubscribe(peer) {
    const user = auth.currentUser; if (!user) throw new Error('–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    const tId = threadIdFor(user.uid, peer.uid);
    const threadRef = doc(db, 'dmThreads', tId);
    await runTransaction(db, async (tx) => {
      const tSnap = await tx.get(threadRef);
      if (!tSnap.exists()) tx.set(threadRef, { participants: [user.uid, peer.uid], createdAt: serverTimestamp() });
      // –æ–±–Ω–æ–≤–∏–º lastOpened? –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ
    });
    subscribeToMessages(tId);
    return tId;
  }

  function subscribeToMessages(tId) {
    if (unsubscribeMessages) unsubscribeMessages();
    const msgsCol = collection(db, 'dmThreads', tId, 'messages');
    const q = query(msgsCol, orderBy('createdAt', 'asc'));
    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      messagesEl.innerHTML = '';
      snapshot.forEach(docSnap => {
        const m = docSnap.data();
        renderMessage(m);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }, (err) => {
      console.warn('msgs sub err', err);
    });
    currentThreadId = tId;
  }

  function renderMessage(m) {
    const user = auth.currentUser;
    const row = document.createElement('div');
    row.className = 'message-row ' + (m.senderId === (user && user.uid) ? 'me' : 'other');
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (m.senderId === (user && user.uid) ? 'me' : 'other');
    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.textContent = (m.displayName || m.senderId) + ' ¬∑ ' + (m.createdAt ? new Date(m.createdAt.toMillis()).toLocaleTimeString() : '');
    bubble.appendChild(meta);
    if (m.type === 'image' && m.url) {
      const img = document.createElement('img'); img.src = m.url; img.className = 'msg-img';
      bubble.appendChild(img);
      if (m.text) { const t = document.createElement('div'); t.textContent = m.text; bubble.appendChild(t); }
    } else if (m.type === 'audio' && m.url) {
      const audio = document.createElement('audio'); audio.controls = true; audio.src = m.url; audio.className = 'msg-audio';
      bubble.appendChild(audio);
      if (m.text) { const t = document.createElement('div'); t.textContent = m.text; bubble.appendChild(t); }
    } else {
      const txt = document.createElement('div'); txt.textContent = m.text || ''; bubble.appendChild(txt);
    }
    row.appendChild(bubble);
    messagesEl.appendChild(row);
  }

  // --- open chat with peer ---
  async function openDirectChat(peer) {
    currentPeer = peer;
    peerName.textContent = peer.displayName || peer.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    peerAvatar.src = peer.photoURL || 'https://via.placeholder.com/44?text=?';
    peerSub.textContent = '@' + (peer.username || '');
    try {
      const tId = await ensureThreadExistsAndSubscribe(peer);
      currentThreadId = tId;
    } catch (e) {
      console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç: ' + (e.message || e));
    }
  }

  // --- send message, image upload, audio upload ---
  async function sendTextMessage(text) {
    if (!text) return;
    const user = auth.currentUser; if (!user) return alert('–í–æ–π–¥–∏—Ç–µ');
    if (!currentPeer) return alert('–û—Ç–∫—Ä–æ–π —á–∞—Ç');
    try {
      const tId = await ensureThreadExistsAndSubscribe(currentPeer);
      const msgsCol = collection(db, 'dmThreads', tId, 'messages');
      await addDoc(msgsCol, { senderId: user.uid, displayName: user.displayName || user.email.split('@')[0], text, type: 'text', createdAt: serverTimestamp() });
    } catch (e) { console.error(e); alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message); }
  }

  imageBtn.onclick = () => imageInput.click();
  imageInput.onchange = async (ev) => {
    const file = ev.target.files[0];
    if (!file) return;
    if (!currentPeer) return alert('–û—Ç–∫—Ä–æ–π —á–∞—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ç–æ');
    const user = auth.currentUser; if (!user) return alert('–í–æ–π–¥–∏—Ç–µ');
    try {
      const tId = await ensureThreadExistsAndSubscribe(currentPeer);
      const path = `dmThreads/${tId}/media/${Date.now()}_${file.name}`;
      const sRef = storageRef(storage, path);
      const snap = await uploadBytes(sRef, file);
      const url = await getDownloadURL(sRef);
      // send message with image type
      const msgsCol = collection(db, 'dmThreads', tId, 'messages');
      await addDoc(msgsCol, { senderId: user.uid, displayName: user.displayName || user.email.split('@')[0], text: '', url, type: 'image', createdAt: serverTimestamp() });
      imageInput.value = '';
    } catch (e) { console.error(e); alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + (e.message || e)); }
  };

  // --- audio recording ---
  let mediaRecorder = null;
  let audioChunks = [];
  recordBtn.onclick = async () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      // stop
      mediaRecorder.stop();
      recordBtn.textContent = 'üéôÔ∏è';
      recordBtn.style.background = '';
    } else {
      // start
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          await uploadAudioBlob(blob);
        };
        mediaRecorder.start();
        recordBtn.textContent = '‚ñ†';
        recordBtn.style.background = '#ffdddd';
      } catch (e) {
        console.error(e); alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + (e.message || e));
      }
    }
  };

  async function uploadAudioBlob(blob) {
    if (!currentPeer) return alert('–û—Ç–∫—Ä–æ–π —á–∞—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ');
    const user = auth.currentUser; if (!user) return alert('–í–æ–π–¥–∏—Ç–µ');
    try {
      const tId = await ensureThreadExistsAndSubscribe(currentPeer);
      const path = `dmThreads/${tId}/media/${Date.now()}_voice.webm`;
      const sRef = storageRef(storage, path);
      await uploadBytes(sRef, blob);
      const url = await getDownloadURL(sRef);
      const msgsCol = collection(db, 'dmThreads', tId, 'messages');
      await addDoc(msgsCol, { senderId: user.uid, displayName: user.displayName || user.email.split('@')[0], text: '', url, type: 'audio', createdAt: serverTimestamp() });
    } catch (e) { console.error(e); alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–∞: ' + (e.message || e)); }
  }

  // --- send on Enter (Shift+Enter newline) ---
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });
  sendBtn.onclick = () => {
    const text = messageInput.value.trim();
    if (!text) return;
    sendTextMessage(text);
    messageInput.value = '';
  };

  // --- auth state handling ---
  onAuthStateChanged(auth, async (user) => {
    renderAuthUI(user);
    if (user) {
      // subscribe to my threads
      subscribeMyThreads(user.uid);
    } else {
      if (unsubscribeThreads) unsubscribeThreads();
    }
  });

  newChatBtn.onclick = () => {
    const username = prompt('–í–≤–µ–¥–∏—Ç–µ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ @):');
    if (!username) return;
    (async () => {
      try {
        const unameSnap = await getDoc(doc(db, 'usernames', username.trim().toLowerCase()));
        if (!unameSnap.exists()) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        const owner = unameSnap.data().owner;
        const prof = (await getDoc(doc(db, 'profiles', owner))).data() || {};
        openDirectChat({ uid: owner, username: username.trim().toLowerCase(), displayName: prof.displayName, photoURL: prof.photoURL });
      } catch (e) { console.error(e); alert('–û—à–∏–±–∫–∞: ' + e.message); }
    })();
  };

  // --- utilities ---
  function debounce(fn, ms) { let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; }
  function escapeHtml(s) { if (!s) return ''; return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

  // remove analytics cookie warnings? not needed ‚Äî ignore

</script>
</body>
</html>
