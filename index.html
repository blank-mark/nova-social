<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova Prospect Chat</title>
<style>
  body { margin:0; font-family: Arial,sans-serif; display:flex; height:100vh; }
  #sidebar { width:300px; border-right:1px solid #ccc; padding:10px; box-sizing:border-box; overflow:auto; }
  #main { flex:1; display:flex; flex-direction:column; }
  input, button, textarea { width:100%; padding:8px; margin:4px 0; box-sizing:border-box; }
  #messages { flex:1; padding:10px; overflow:auto; background:#f9f9f9; }
  .msg { background:#fff; padding:6px 10px; margin-bottom:8px; border-radius:6px; box-shadow:0 1px 0 #ddd; }
  .meta { font-size:12px; color:#666; margin-bottom:4px; }
  .room-item { padding:6px; margin-bottom:6px; cursor:pointer; border-radius:6px; background:#eee; }
  .room-item.active { background:#cce0ff; }
  .hidden { display:none; }
  #profilePic { width:48px; height:48px; border-radius:50%; object-fit:cover; }
</style>
</head>
<body>

<div id="sidebar">
  <h3>Аккаунт</h3>
  <div id="signed-out">
    <button id="googleSignInBtn">Войти через Google</button>
    <hr>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Пароль">
    <button id="emailSignUpBtn">Зарегистрироваться</button>
    <button id="emailSignInBtn">Войти</button>
  </div>

  <div id="signed-in" class="hidden">
    <img id="profilePic" src="" alt="avatar"><br>
    <strong id="profileName"></strong><br>
    <small id="profileEmail"></small><br>
    <button id="signOutBtn">Выйти</button>
    <hr>
    <h4>Профиль</h4>
    <input id="displayNameInput" placeholder="Имя">
    <input id="photoURLInput" placeholder="Ссылка на аватар">
    <button id="saveProfileBtn">Сохранить</button>
  </div>

  <hr>
  <h3>Комнаты</h3>
  <div id="roomsList"></div>
  <input id="newRoomName" placeholder="Новая комната">
  <button id="createRoomBtn">Создать комнату</button>
</div>

<div id="main">
  <div style="padding:10px; border-bottom:1px solid #ccc;">
    <strong id="currentRoomTitle">Выберите комнату</strong>
  </div>
  <div id="messages"></div>
  <div style="padding:10px; border-top:1px solid #ccc;">
    <textarea id="messageInput" rows="2" placeholder="Напишите сообщение..."></textarea>
    <button id="sendBtn">Отправить</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
    authDomain: "nova-prospect-chat.firebaseapp.com",
    projectId: "nova-prospect-chat",
    storageBucket: "nova-prospect-chat.firebasestorage.app",
    messagingSenderId: "256806164650",
    appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
    measurementId: "G-9V0Q2E2FNB"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- UI ---
  const googleSignInBtn = document.getElementById('googleSignInBtn');
  const emailSignUpBtn = document.getElementById('emailSignUpBtn');
  const emailSignInBtn = document.getElementById('emailSignInBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const signedInDiv = document.getElementById('signed-in');
  const signedOutDiv = document.getElementById('signed-out');
  const profileName = document.getElementById('profileName');
  const profileEmail = document.getElementById('profileEmail');
  const profilePic = document.getElementById('profilePic');
  const displayNameInput = document.getElementById('displayNameInput');
  const photoURLInput = document.getElementById('photoURLInput');
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const roomsList = document.getElementById('roomsList');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const newRoomName = document.getElementById('newRoomName');
  const currentRoomTitle = document.getElementById('currentRoomTitle');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentRoomId = null;
  let unsubscribeMessages = null;

  // --- Auth ---
  googleSignInBtn.onclick = async ()=>{ try { await signInWithPopup(auth,new GoogleAuthProvider()); } catch(e){alert(e.message);} };
  emailSignUpBtn.onclick = async ()=>{ 
    const email=document.getElementById('email').value;
    const pw=document.getElementById('password').value;
    try{
      const userCred = await createUserWithEmailAndPassword(auth,email,pw);
      await setDoc(doc(db,'profiles',userCred.user.uid),{displayName:userCred.user.email.split('@')[0],photoURL:null,createdAt:serverTimestamp()});
    } catch(e){alert(e.message);}
  };
  emailSignInBtn.onclick = async ()=>{ 
    const email=document.getElementById('email').value;
    const pw=document.getElementById('password').value;
    try{ await signInWithEmailAndPassword(auth,email,pw); } catch(e){alert(e.message);}
  };
  signOutBtn.onclick = async ()=>{ await signOut(auth); };

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      signedInDiv.classList.remove('hidden'); signedOutDiv.classList.add('hidden');
      profileName.textContent = user.displayName||'Без имени';
      profileEmail.textContent = user.email||'';
      profilePic.src = user.photoURL || 'https://via.placeholder.com/48?text=?';
      displayNameInput.value = user.displayName||'';
      photoURLInput.value = user.photoURL||'';
      loadRooms();
    }else{
      signedInDiv.classList.add('hidden'); signedOutDiv.classList.remove('hidden');
      profileName.textContent = ''; profileEmail.textContent = ''; profilePic.src='';
      roomsList.innerHTML=''; messagesDiv.innerHTML=''; currentRoomTitle.textContent='Выберите комнату';
    }
  });

  saveProfileBtn.onclick = async ()=>{
    const user=auth.currentUser;
    if(!user) return alert('Неавторизован');
    const newName=displayNameInput.value.trim(); const newPhoto=photoURLInput.value.trim()||null;
    await updateProfile(user,{displayName:newName,photoURL:newPhoto});
    await setDoc(doc(db,'profiles',user.uid),{displayName:newName,photoURL:newPhoto,updatedAt:serverTimestamp()},{merge:true});
    profileName.textContent=newName; profilePic.src=newPhoto||'https://via.placeholder.com/48?text=?'; alert('Профиль сохранён');
  };

  // --- Rooms ---
  async function loadRooms(){
    roomsList.innerHTML='';
    const q = query(collection(db,'rooms'),orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    snap.forEach(docSnap=>{
      const data=docSnap.data();
      const el=document.createElement('div'); el.className='room-item'; el.textContent=data.name||'Безымянная';
      el.onclick=()=>{ openRoom(docSnap.id,data.name); setActiveRoomElement(el); };
      roomsList.appendChild(el);
    });
  }

  createRoomBtn.onclick=async ()=>{
    const name=newRoomName.value.trim(); if(!name) return alert('Введите имя комнаты');
    const user=auth.currentUser; if(!user) return alert('Войдите');
    const roomRef = await addDoc(collection(db,'rooms'),{name,owner:user.uid,createdAt:serverTimestamp()});
    newRoomName.value=''; loadRooms(); openRoom(roomRef.id,name);
  };

  function setActiveRoomElement(el){
    document.querySelectorAll('.room-item').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
  }

  function openRoom(roomId,roomName){
    if(unsubscribeMessages) unsubscribeMessages();
    currentRoomId=roomId;
    currentRoomTitle.textContent=roomName||'Комната';
    messagesDiv.innerHTML='';
    const msgsCol=collection(db,'rooms',roomId,'messages');
    const q=query(msgsCol,orderBy('createdAt','asc'));
    unsubscribeMessages=onSnapshot(q,snapshot=>{
      messagesDiv.innerHTML='';
      snapshot.forEach(docSnap=>{
        const m=docSnap.data();
        const el=document.createElement('div'); el.className='msg';
        el.innerHTML=`<div class="meta"><strong>${escapeHtml(m.displayName||m.senderId)}</strong> · ${new Date(m.createdAt?.toMillis?m.createdAt.toMillis():Date.now()).toLocaleString()}</div><div>${escapeHtml(m.text)}</div>`;
        messagesDiv.appendChild(el);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  sendBtn.onclick=async ()=>{
    const text=messageInput.value.trim(); if(!text) return; if(!currentRoomId) return alert('Выберите комнату');
    const user=auth.currentUser; if(!user) return alert('Войдите');
    const msgsCol=collection(db,'rooms',currentRoomId,'messages');
    await addDoc(msgsCol,{senderId:user.uid,displayName:user.displayName||user.email.split('@')[0],text,createdAt:serverTimestamp()});
    messageInput.value='';
  };

  function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

</script>
</body>
</html>
