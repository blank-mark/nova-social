<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NovaTalk — простой мессенджер на Firebase</title>
<style>
  /* Минималистичный, адаптивный стиль — подойдет для начала */
  :root{--bg:#0f1724;--panel:#0b1220;--muted:#9aa6b2;--text:#e6eef6;--accent:#1d9bf0}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .app{display:grid;grid-template-columns:320px 1fr;gap:12px;max-width:1100px;margin:18px auto;padding:12px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
  .sidebar .profile{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .avatar{width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:700}
  .btn{background:linear-gradient(90deg,var(--accent),#60a5fa);border:none;color:white;padding:8px 10px;border-radius:8px;cursor:pointer}
  .small{padding:6px 8px;font-size:13px}
  .muted{color:var(--muted)}
  .chats{height:72vh;overflow:auto;margin-top:8px}
  .chat-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
  .chat-item:hover{background:rgba(255,255,255,0.02)}
  .chat-item .meta{flex:1;min-width:0}
  .chat-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chat-last{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .messages{height:72vh;display:flex;flex-direction:column;gap:8px;padding:12px;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:10px}
  .msg{max-width:70%;padding:8px;border-radius:10px}
  .msg.me{margin-left:auto;background:linear-gradient(90deg,var(--accent),#60a5fa);color:white}
  .msg.them{background:rgba(255,255,255,0.03)}
  .composer{display:flex;gap:8px;margin-top:8px}
  input,textarea{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:8px;color:var(--text);width:100%}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
  .center-empty{display:flex;align-items:center;justify-content:center;height:72vh;color:var(--muted)}
  /* responsive */
  @media (max-width:900px){ .app{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }
</style>
</head>
<body>

<div id="root">
  <!-- AUTH SCREEN -->
  <div id="authScreen" style="max-width:900px;margin:40px auto">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0">NovaTalk — Вход / Регистрация</h2>
          <div class="muted">Email + пароль. После регистрации профиль создаётся в Firestore.</div>
        </div>
        <div><small class="muted">Firebase + Firestore</small></div>
      </div>
      <hr style="opacity:.06;margin:12px 0">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <input id="email" placeholder="Email" style="width:320px">
        <input id="password" placeholder="Пароль" type="password" style="width:220px">
        <input id="displayName" placeholder="Отображаемое имя (опционально)" style="width:260px">
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" onclick="registerUser()">Создать аккаунт</button>
        <button class="btn small" onclick="loginUser()">Войти</button>
        <button class="small" onclick="showGuest()">Войти как гость</button>
        <div style="margin-left:auto" id="authNotice" class="muted"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appScreen" style="display:none" class="app">
    <!-- LEFT: sidebar -->
    <div class="sidebar card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">NovaTalk</div>
        <div class="muted">Мессенджер</div>
      </div>

      <div class="profile" style="margin-top:10px">
        <div class="avatar" id="myAvatar">U</div>
        <div style="min-width:0">
          <div id="myName" style="font-weight:800">Гость</div>
          <div id="myEmail" class="muted" style="font-size:13px">@guest</div>
        </div>
      </div>

      <div style="display:flex;gap:8px">
        <button class="btn small" onclick="openNewChatPrompt()">Новый чат</button>
        <button class="small" onclick="logout()">Выйти</button>
      </div>

      <div style="margin-top:10px">
        <div class="muted">Чаты</div>
        <div id="chatsList" class="chats"></div>
      </div>

    </div>

    <!-- RIGHT: messages -->
    <div class="main">
      <div class="card" style="display:flex;flex-direction:column;height:100%">
        <div class="topbar">
          <div>
            <div id="chatHeader" style="font-weight:800">Выберите чат</div>
            <div id="chatSub" class="muted" style="font-size:13px"></div>
          </div>
          <div>
            <button class="small" id="btnDeleteChat" style="display:none" onclick="deleteCurrentChat()">Удалить чат</button>
          </div>
        </div>

        <div id="messagesArea" class="messages">
          <div class="center-empty">Нет выбранного чата — создайте новый или выберите существующий.</div>
        </div>

        <div id="composerRow" style="display:none">
          <div class="composer">
            <textarea id="msgText" rows="2" placeholder="Введите сообщение..."></textarea>
            <button class="btn small" onclick="sendMessage()">Отправить</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- toast -->
<div id="toast" style="position:fixed;right:18px;bottom:18px;display:none;background:rgba(0,0,0,0.6);color:white;padding:8px 10px;border-radius:8px"></div>

<script type="module">
/* ------------- КОНФИГ FIREBASE -------------
   Если это тот же проект, что у тебя в Nova, можно оставить.
   При необходимости замени поля на свои из Firebase Console. */
const firebaseConfig = {
  apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
  authDomain: "nova-prospect-chat.firebaseapp.com",
  projectId: "nova-prospect-chat",
  storageBucket: "nova-prospect-chat.firebasestorage.app",
  messagingSenderId: "256806164650",
  appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
  measurementId: "G-9V0Q2E2FNB"
};

/* ---------- Импорты Firebase (v9 modular) --------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, updateDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- Простая утилита для тостов ---------- */
function showToast(msg, t=2200){ const el = document.getElementById('toast'); el.textContent = msg; el.style.display='block'; setTimeout(()=>el.style.display='none', t); }

/* ---------- Глобальные переменные UI/состояние ---------- */
let me = null;              // { uid, email, username, displayName }
let chatsUnsub = null;      // отписка на изменение списка чатов
let messagesUnsub = null;   // отписка на поток сообщений текущего чата
let currentChat = null;     // { id, participants, lastMessage, lastUpdated }

/* ---------- DOM узлы ---------- */
const authScreen = document.getElementById('authScreen');
const appScreen = document.getElementById('appScreen');
const myAvatar = document.getElementById('myAvatar');
const myName = document.getElementById('myName');
const myEmail = document.getElementById('myEmail');
const chatsList = document.getElementById('chatsList');
const messagesArea = document.getElementById('messagesArea');
const chatHeader = document.getElementById('chatHeader');
const chatSub = document.getElementById('chatSub');
const composerRow = document.getElementById('composerRow');
const msgText = document.getElementById('msgText');
const btnDeleteChat = document.getElementById('btnDeleteChat');

/* ---------- Автологика: следим за стейтом аутентификации ---------- */
onAuthStateChanged(auth, async (user) => {
  if(user){
    // Гарантируем наличие документа пользователя
    await ensureUserDoc(user);
    // Загружаем профиль текущего пользователя (из коллекции users)
    const ud = await getDoc(doc(db, 'users', user.uid));
    me = { uid: user.uid, ...(ud.exists()? ud.data() : { email: user.email, displayName: user.displayName || user.email.split('@')[0] }) };
    openApp();
  } else {
    // нет пользователя — показываем экран входа
    me = null;
    openAuth();
  }
});

/* ---------- UI: показать экран аутентификации ---------- */
function openAuth(){
  authScreen.style.display = 'block';
  appScreen.style.display = 'none';
  // заполнить поля по умолчанию (для удобства)
  document.getElementById('email').value = '';
  document.getElementById('password').value = '';
  document.getElementById('displayName').value = '';
  showToast('Пожалуйста, войдите или зарегистрируйтесь');
}

/* ---------- UI: показать приложение (чаты) ---------- */
function openApp(){
  authScreen.style.display = 'none';
  appScreen.style.display = 'grid';
  myAvatar.textContent = (me.displayName || me.username || 'U')[0].toUpperCase();
  myName.textContent = me.displayName || me.username || me.email;
  myEmail.textContent = me.email || '';
  attachChatsListener();
}

/* ---------- Регистрация и вход ---------- */
async function registerUser(){
  const email = document.getElementById('email').value.trim();
  const pass  = document.getElementById('password').value.trim();
  const name  = document.getElementById('displayName').value.trim() || null;
  if(!email || !pass){ showToast('Заполни email и пароль'); return; }
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    // создаём doc пользователя
    const uid = cred.user.uid;
    const username = email.split('@')[0];
    await setDoc(doc(db,'users',uid), {
      uid, email, username, displayName: name || username, createdAt: serverTimestamp()
    });
    showToast('Регистрация успешна — вы вошли');
  } catch (err) {
    console.error(err);
    showToast('Ошибка регистрации: ' + (err.message||err.code));
  }
}

async function loginUser(){
  const email = document.getElementById('email').value.trim();
  const pass  = document.getElementById('password').value.trim();
  if(!email || !pass){ showToast('Заполни email и пароль'); return; }
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    showToast('Вход прошёл успешно');
  } catch (err) {
    console.error(err);
    showToast('Ошибка входа: ' + (err.message||err.code));
  }
}

/* Гость (локальный без Firebase) — полезно тестировать, но не для продакшна */
function showGuest(){
  // локальный «гость» — не использует Firebase auth
  me = { uid: 'guest_'+Date.now(), email:'guest', username:'guest', displayName:'Гость' };
  openApp();
  showToast('Работа в режиме гостя (не сохраняется в облаке)');
}

/* ---------- Убедиться, что документ пользователя существует в Firestore ---------- */
async function ensureUserDoc(user){
  try {
    const ref = doc(db, 'users', user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      const username = (user.email || '').split('@')[0] || ('u'+Date.now());
      await setDoc(ref, { uid: user.uid, email: user.email || null, username, displayName: user.displayName || username, createdAt: serverTimestamp() });
    }
  } catch(e){ console.warn('ensureUserDoc error', e); }
}

/* ---------- Слушаем чаты (где наш uid в participants) ---------- */
function attachChatsListener(){
  if(!me || !me.uid) return;
  // отписываем предыдущий listener
  if(chatsUnsub) chatsUnsub();

  // запрашиваем чаты, где участвует текущий пользователь, сортировка по lastUpdated
  const chatsRef = collection(db, 'chats');
  const q = query(chatsRef, where('participants', 'array-contains', me.uid), orderBy('lastUpdated', 'desc'));
  chatsUnsub = onSnapshot(q, snapshot => {
    // перерисовка списка чатов
    chatsList.innerHTML = '';
    snapshot.forEach(docSnap => {
      const c = { id: docSnap.id, ...docSnap.data() };
      renderChatListItem(c);
    });
    // если нет чатов — подсказка
    if(snapshot.empty) chatsList.innerHTML = '<div class="muted">Чатов пока нет — создайте новый</div>';
  }, err => { console.warn('chats listener err', err); showToast('Ошибка получения чатов'); });
}

/* ---------- Отрисовать элемент списка чатов ---------- */
function renderChatListItem(chatObj){
  // создаём DOM
  const el = document.createElement('div');
  el.className = 'chat-item';
  el.dataset.chatId = chatObj.id;
  const otherUid = chatObj.participants.find(p => p !== me.uid) || null;

  // заголовок — если chatObj.title есть, берем его, иначе подгружаем имя участника
  const titleDiv = document.createElement('div');
  titleDiv.className = 'meta';
  const title = document.createElement('div');
  title.className = 'chat-title';
  title.textContent = chatObj.title || (chatObj.name || 'Чат');
  const last = document.createElement('div');
  last.className = 'chat-last';
  last.textContent = chatObj.lastMessage && chatObj.lastMessage.text ? chatObj.lastMessage.text : (chatObj.lastMessage ? '[медиа]' : 'Пусто');

  titleDiv.appendChild(title); titleDiv.appendChild(last);

  el.appendChild(titleDiv);

  el.onclick = () => openChat(chatObj.id, chatObj);

  // вставляем в список — если уже есть такой элемент, заменяем
  const existing = chatsList.querySelector(`[data-chat-id="${chatObj.id}"]`);
  if(existing) existing.replaceWith(el);
  else chatsList.appendChild(el);
}

/* ---------- Создать новый чат (по email другого пользователя) ---------- */
async function openNewChatPrompt(){
  const target = prompt('Введи email польз-ля, с которым хочешь начать чат (или его username):');
  if(!target || !target.trim()) return;
  const queryText = target.trim();

  try {
    // ищем пользователя по email или username
    const usersRef = collection(db, 'users');
    let found = null;

    // сначала по email
    const q1 = query(usersRef, where('email', '==', queryText));
    const snap1 = await getDocs(q1);
    if(!snap1.empty){ found = snap1.docs[0].data(); found._id = snap1.docs[0].id; }

    // если не нашли — по username
    if(!found){
      const q2 = query(usersRef, where('username', '==', queryText));
      const snap2 = await getDocs(q2);
      if(!snap2.empty){ found = snap2.docs[0].data(); found._id = snap2.docs[0].id; }
    }

    if(!found){ showToast('Пользователь не найден'); return; }

    // проверяем — есть ли уже чат между нами и ним
    const chatsRef = collection(db, 'chats');
    const myChatsQ = query(chatsRef, where('participants', 'array-contains', me.uid));
    const myChatsSnap = await getDocs(myChatsQ);
    for(const d of myChatsSnap.docs){
      const data = d.data();
      if(Array.isArray(data.participants) && data.participants.includes(found.uid) && data.participants.includes(me.uid)) {
        // такой чат есть — откроем
        openChat(d.id, { id: d.id, ...data });
        showToast('Чат уже существует — открываю');
        return;
      }
    }

    // иначе создаём новый чат
    const newChat = {
      participants: [me.uid, found.uid],
      title: found.displayName || found.username || found.email,
      lastMessage: null,
      lastUpdated: serverTimestamp(),
      createdAt: serverTimestamp()
    };
    const chatRef = await addDoc(collection(db, 'chats'), newChat);
    showToast('Чат создан');
    // openChat будет автоматически вызван после onSnapshot списка чатов обновит список
  } catch(err){
    console.error('openNewChatPrompt', err);
    showToast('Ошибка при создании чата');
  }
}

/* ---------- Открыть чат и подписаться на сообщения ---------- */
async function openChat(chatId, chatObj){
  // отписаться от предыдущих сообщений
  if(messagesUnsub) messagesUnsub();

  // получаем мета если не передано
  let chatMeta = chatObj;
  if(!chatMeta) {
    const d = await getDoc(doc(db,'chats',chatId));
    if(!d.exists()) { showToast('Чат не найден'); return; }
    chatMeta = { id: d.id, ...d.data() };
  }

  currentChat = chatMeta;
  chatHeader.textContent = chatMeta.title || 'Чат';
  chatSub.textContent = (chatMeta.participants || []).filter(p=>p!==me.uid).join(', ');

  // показать delete если я — создатель (или просто показать всегда)
  btnDeleteChat.style.display = 'inline-block';

  // слушаем сообщения subcollection
  const msgsRef = collection(db, 'chats', chatMeta.id, 'messages');
  const q = query(msgsRef, orderBy('ts', 'asc'));
  messagesArea.innerHTML = ''; // очистка
  messagesUnsub = onSnapshot(q, snapshot => {
    messagesArea.innerHTML = '';
    if(snapshot.empty){
      messagesArea.innerHTML = '<div class="muted">Пока нет сообщений. Напиши первым!</div>';
    } else {
      snapshot.forEach(docSnap => {
        const m = docSnap.data();
        const node = document.createElement('div');
        node.className = 'msg ' + (m.senderUid === me.uid ? 'me' : 'them');
        node.innerHTML = `<div style="font-size:13px;margin-bottom:6px">${m.senderName || m.senderUid}</div><div>${escapeHtml(m.text)}</div><div style="font-size:12px;margin-top:6px;color:var(--muted)">${formatTime(m.ts?.toDate ? m.ts.toDate() : new Date(m.ts || Date.now()))}</div>`;
        messagesArea.appendChild(node);
      });
      // автопрокрутка вниз
      messagesArea.scrollTop = messagesArea.scrollHeight;
    }
    // показываем composer
    composerRow.style.display = 'block';
  }, err => { console.warn('messages listener err', err); showToast('Ошибка получения сообщений'); });
}

/* ---------- Отправка сообщения ---------- */
async function sendMessage(){
  if(!currentChat || !currentChat.id){ showToast('Выберите чат'); return; }
  const text = (msgText.value || '').trim();
  if(!text) return;
  try {
    const msgsRef = collection(db, 'chats', currentChat.id, 'messages');
    const msgObj = {
      text,
      senderUid: me.uid,
      senderName: me.displayName || me.username || me.email,
      ts: serverTimestamp()
    };
    await addDoc(msgsRef, msgObj);
    // обновляем lastMessage и lastUpdated в chat doc
    const chatRef = doc(db, 'chats', currentChat.id);
    await updateDoc(chatRef, { lastMessage: { text, senderUid: me.uid, senderName: me.displayName || me.username }, lastUpdated: serverTimestamp() });
    msgText.value = '';
  } catch(err){
    console.error('sendMessage err', err);
    showToast('Ошибка отправки сообщения');
  }
}

/* ---------- Удалить текущий чат (удалит doc + messages subcollection не удаляются автоматически) ---------- */
async function deleteCurrentChat(){
  if(!currentChat || !currentChat.id) return;
  const ok = confirm('Удалить чат? Это удалит только мета чат (сообщения останутся в Firestore subcollection). Если хочешь полностью удалить все документы, лучше делать это через Firebase Console.');
  if(!ok) return;
  try {
    await deleteDoc(doc(db,'chats', currentChat.id));
    showToast('Чат удалён (мета). Подмассивы сообщений остаются в базе — можно удалить вручную через консоль)');
    // очищаем UI
    messagesArea.innerHTML = '<div class="center-empty">Выберите другой чат</div>';
    composerRow.style.display = 'none';
    chatHeader.textContent = 'Выберите чат';
    chatSub.textContent = '';
    currentChat = null;
  } catch(err){
    console.error(err);
    showToast('Ошибка удаления чата');
  }
}

/* ---------- Выйти ---------- */
async function logout(){
  try {
    if(auth && auth.currentUser) await signOut(auth);
  } catch(e){ console.warn('signout', e); }
  // очистим локально
  me = null;
  if(chatsUnsub) chatsUnsub();
  if(messagesUnsub) messagesUnsub();
  openAuth();
}

/* ---------- Вспомогательные функции ---------- */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function formatTime(d){
  if(!d) return '';
  const hh = String(d.getHours()).padStart(2,'0'), mm = String(d.getMinutes()).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0'), mon = String(d.getMonth()+1).padStart(2,'0');
  return `${day}.${mon} ${hh}:${mm}`;
}

/* ---------- Показать окно при загрузке (если уже вошли) ---------- */
if(auth.currentUser){ /* onAuthStateChanged обработает */ } else { openAuth(); }
  document.querySelector('#btnRegister').addEventListener('click', registerUser);
document.querySelector('#btnLogin').addEventListener('click', loginUser);
document.querySelector('#btnGuest').addEventListener('click', showGuest);


</script>

</body>
</html>

