<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nova Prospect Chat</title>

<style>
body, html { margin:0; padding:0; font-family:sans-serif; height:100%; }
#app { display:flex; height:100vh; width:100vw; }
#sidebar { width:250px; background:#1e1e1e; color:white; display:flex; flex-direction:column; }
#friendsList { flex:1; overflow:auto; }
#chat { flex:1; display:flex; flex-direction:column; }
#chatHeader { height:50px; background:#2a2a2a; color:white; display:flex; align-items:center; padding:0 10px; }
#messages { flex:1; overflow:auto; padding:10px; background:#111; color:white; }
#inputArea { display:flex; padding:5px; background:#222; }
#inputArea input { flex:1; padding:5px; margin-right:5px; }
#inputArea button { padding:5px; }
.friend { cursor:pointer; padding:5px; display:flex; align-items:center; }
.friend img { width:30px; height:30px; border-radius:50%; margin-right:5px; }
.toast { position:fixed; bottom:10px; right:10px; background:#333; color:white; padding:5px 10px; border-radius:5px; opacity:0.9; }
.light-theme { --bg-main: #f5f5f5; --bg-chat: #fff; --color-text: #000; }
.light-theme #sidebar { background:#ddd; color:#000; }
.light-theme #chatHeader { background:#ccc; color:#000; }
.light-theme #messages { background:#eee; color:#000; }
.light-theme #inputArea { background:#ddd; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

</head>
<body>
<div id="app" class="">
  <div id="sidebar" style="display:none;">
    <div style="padding:10px;">
      <div id="meInfo"></div>
      <input type="text" id="usernameInput" placeholder="–ù–∞–π—Ç–∏ username">
      <button id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="themeBtn">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
    </div>
    <div id="friendsList"></div>
  </div>
  <div id="chat" style="display:none;">
    <div id="chatHeader"></div>
    <div id="messages"></div>
    <div id="inputArea">
      <input type="text" id="msgInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>
<div id="loginArea" style="padding:20px;">
  <button id="loginBtn">–í–æ–π—Ç–∏ —Å Google</button>
</div>
<div id="toast" class="toast" style="display:none;"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
  authDomain: "nova-prospect-chat.firebaseapp.com",
  projectId: "nova-prospect-chat",
  storageBucket: "nova-prospect-chat.firebasestorage.app",
  messagingSenderId: "256806164650",
  appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
  measurementId: "G-9V0Q2E2FNB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let me = null;
let myDoc = null;
let currentChat = null;
let messagesListener = null;

// üçû –¢–æ—Å—Ç
function toast(text){
  const t = document.getElementById('toast');
  t.innerText = text; t.style.display='block';
  setTimeout(()=>{t.style.display='none';},2000);
}

// üåà –¢–µ–º–∞
const themeBtn = document.getElementById('themeBtn');
themeBtn.onclick = ()=>{document.body.classList.toggle('light-theme');};
if(window.innerWidth<768){ document.body.classList.add('light-theme'); } // –º–æ–±–∏–ª–∫–∞ –±–µ–ª–∞—è –ø–æ –¥–µ—Ñ–æ–ª—Ç—É

// üõ†Ô∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π
function updateFriends(){
  const list = document.getElementById('friendsList');
  list.innerHTML='';
  const seen = new Set(); // —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏—Å—å
  (myDoc.friends||[]).forEach(async uid=>{
    if(seen.has(uid)) return;
    seen.add(uid);
    const fdoc = await db.collection('users').doc(uid).get();
    const f = fdoc.data();
    const div = document.createElement('div');
    div.className='friend';
    div.innerHTML=`<img src="${f.photoURL}"><span>${f.username}</span>`;
    div.onclick = ()=>openChat(f);
    list.appendChild(div);
  });
}

// üì® –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
function openChat(friend){
  currentChat=friend;
  document.getElementById('chatHeader').innerText=friend.username;
  const msgsDiv=document.getElementById('messages');
  msgsDiv.innerHTML='';
  if(messagesListener) messagesListener(); // –æ—Ç–ø–∏—Å–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ
  messagesListener=db.collection('messages')
    .where('participants','array-contains',me.uid)
    .orderBy('timestamp')
    .onSnapshot(snap=>{
      msgsDiv.innerHTML='';
      snap.docs.forEach(doc=>{
        const m = doc.data();
        if(!m.participants.includes(friend.uid)) return;
        const d = document.createElement('div');
        d.innerText=(m.senderId===me.uid?'–Ø: ':'')+m.text;
        msgsDiv.appendChild(d);
        msgsDiv.scrollTop=msgsDiv.scrollHeight;
      });
    });
}

// ‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∫–∞
document.getElementById('sendBtn').onclick=async ()=>{
  const text=document.getElementById('msgInput').value;
  if(!text||!currentChat) return;
  await db.collection('messages').add({
    text,
    senderId:me.uid,
    participants:[me.uid,currentChat.uid],
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('msgInput').value='';
};

// ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞
document.getElementById('addBtn').onclick=async ()=>{
  const username=document.getElementById('usernameInput').value.trim();
  if(!username) return;
  const q=await db.collection('users').where('username','==',username).get();
  if(q.empty){ toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  const target=q.docs[0].data();
  if(target.uid===me.uid){ toast('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è'); return; }
  if((myDoc.friends||[]).includes(target.uid)){ toast('–£–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö'); return; }
  await db.collection('users').doc(me.uid).update({ friends: firebase.firestore.FieldValue.arrayUnion(target.uid) });
  myDoc=(await db.collection('users').doc(me.uid).get()).data();
  updateFriends();
  document.getElementById('usernameInput').value='';
};

// üîë –í—Ö–æ–¥
document.getElementById('loginBtn').onclick=async ()=>{
  const provider=new firebase.auth.GoogleAuthProvider();
  try{
    const res=await auth.signInWithPopup(provider);
    me=res.user;
    let doc=await db.collection('users').doc(me.uid).get();
    if(!doc.exists){
      let username='';
      while(!username){
        username=prompt('–ü—Ä–∏–¥—É–º–∞–π—Ç–µ username (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)');
        if(!username) continue;
        const uq=await db.collection('users').where('username','==',username).get();
        if(!uq.empty){ toast('Username –∑–∞–Ω—è—Ç'); username=''; }
      }
      await db.collection('users').doc(me.uid).set({
        uid:me.uid,
        username,
        email:me.email,
        photoURL:me.photoURL,
        friends:[]
      });
      doc=await db.collection('users').doc(me.uid).get();
    }
    myDoc=doc.data();
    document.getElementById('loginArea').style.display='none';
    document.getElementById('sidebar').style.display='flex';
    document.getElementById('chat').style.display='flex';
    document.getElementById('meInfo').innerHTML=`<img src="${me.photoURL}" width="30" style="border-radius:50%"> ${myDoc.username}`;
    updateFriends();
  }catch(e){console.log(e); toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'); }
};

// üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
auth.onAuthStateChanged(async u=>{
  if(u){ document.getElementById('loginBtn').click(); }
});
</script>

<!-- 
üî• FIRESTORE SECURITY RULES üî•

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    match /messages/{msgId} {
      allow read, write: if request.auth != null 
        && request.auth.uid in resource.data.participants;
    }
  }
}

storage.rules:

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      allow read, write: if request.auth != null;
    }
  }
}
-->

</body>
</html>
