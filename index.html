<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nova Prospect ‚Äî Messenger (Telegram/Discord style)</title>

<!-- Minimal styling, desktop-style layout (dark theme, simple) -->
<style>
  :root{
    --bg:#0f1720; --panel:#11151a; --muted:#9aa5b1; --accent:#2b8cff; --bubble:#172027;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, Roboto, Arial, sans-serif;background:var(--bg);color:#e6eef6}
  .app{display:grid;grid-template-columns:280px 1fr 320px;grid-template-rows:64px 1fr;height:100vh;gap:8px;padding:8px;}
  .header{grid-column:1/-1;height:64px;background:var(--panel);display:flex;align-items:center;padding:12px;border-radius:8px}
  .brand{font-weight:700;margin-right:12px}
  .header .actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  img.avatar{width:40px;height:40px;border-radius:8px;object-fit:cover}

  .sidebar{background:var(--panel);border-radius:8px;padding:12px;overflow:auto}
  .contacts{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .contact{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
  .contact:hover{background:var(--glass)}
  .contact .name{font-weight:600}
  .searchRow{display:flex;gap:8px}

  .chatPanel{background:linear-gradient(180deg,#071018 0%, #08121a 100%);border-radius:8px;display:flex;flex-direction:column;overflow:hidden}
  .chatHeader{height:64px;display:flex;align-items:center;padding:12px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .chatBody{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  .msgRow{max-width:70%;display:flex;flex-direction:column;gap:6px}
  .msgRow.me{align-self:flex-end;text-align:right}
  .bubble{padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,#0f2a3a,#0b2430);border:1px solid rgba(255,255,255,0.03)}
  .bubble.img{padding:6px}
  .time{font-size:11px;color:var(--muted)}
  .composer{height:72px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center;padding:10px}
  .input{flex:1;padding:10px;border-radius:10px;background:var(--panel);border:1px solid rgba(255,255,255,0.03);color:#e6eef6}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:#fff}
  .rightPanel{background:var(--panel);border-radius:8px;padding:12px;overflow:auto}
  .small{font-size:13px;color:var(--muted)}
  .stickerBtn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px;border-radius:8px;cursor:pointer}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#222;padding:10px 14px;border-radius:8px;color:#fff;border:1px solid rgba(255,255,255,0.04)}
  @media (max-width:1000px){
    .app{grid-template-columns:1fr;grid-template-rows:64px auto 1fr;gap:8px}
    .rightPanel{display:none}
  }
</style>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="app" id="app">
    <div class="header">
      <div class="brand">Nova Prospect</div>
      <div class="small">Single-file messenger ‚Äî desktop style</div>

      <div class="actions" id="authArea">
        <button id="loginBtn" class="btn">–í–æ–π—Ç–∏ —Å Google</button>
      </div>

      <div class="actions" id="userArea" style="display:none">
        <img id="meAvatar" class="avatar" src="" alt="me"/>
        <div style="display:flex;flex-direction:column;align-items:flex-end;margin-left:8px;">
          <div id="meName" style="font-weight:600"></div>
          <div class="small" id="meEmail"></div>
        </div>
        <button id="logoutBtn" class="btn" style="margin-left:8px">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- Left: contacts/search -->
    <div class="sidebar">
      <div class="searchRow">
        <input id="usernameSearch" class="input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ username" />
        <button id="addBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div style="font-weight:700">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
        <div class="small">–æ–Ω–ª–∞–π–Ω</div>
      </div>

      <div class="contacts" id="contactsList">
        <!-- contacts inserted here -->
      </div>

      <div style="margin-top:12px">
        <div class="small">–°—Ç–∏–∫–µ—Ä—ã</div>
        <div style="display:flex;gap:6px;margin-top:8px" id="stickersRow"></div>
      </div>
    </div>

    <!-- Center: chat -->
    <div class="chatPanel" id="chatPanel">
      <div class="chatHeader" id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç</div>
      <div class="chatBody" id="chatBody"></div>

      <div class="composer">
        <input id="msgInput" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <input id="fileInput" type="file" accept="image/*" style="display:none"/>
        <button id="attachBtn" class="btn">üìé</button>
        <button id="sendBtn" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- Right: info -->
    <div class="rightPanel" id="rightPanel">
      <div id="rightContent"><div class="small">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ</div></div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
/* ==========================
   Config (provided)
   ========================== */
const firebaseConfig = {
  apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
  authDomain: "nova-prospect-chat.firebaseapp.com",
  projectId: "nova-prospect-chat",
  storageBucket: "nova-prospect-chat.firebasestorage.app",
  messagingSenderId: "256806164650",
  appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
  measurementId: "G-9V0Q2E2FNB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ==========================
   DOM
   ========================== */
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authArea = document.getElementById('authArea');
const userArea = document.getElementById('userArea');
const meAvatar = document.getElementById('meAvatar');
const meName = document.getElementById('meName');
const meEmail = document.getElementById('meEmail');

const usernameSearch = document.getElementById('usernameSearch');
const addBtn = document.getElementById('addBtn');
const contactsList = document.getElementById('contactsList');

const chatHeader = document.getElementById('chatHeader');
const chatBody = document.getElementById('chatBody');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const attachBtn = document.getElementById('attachBtn');
const fileInput = document.getElementById('fileInput');
const rightContent = document.getElementById('rightContent');

const toastEl = document.getElementById('toast');
const stickersRow = document.getElementById('stickersRow');

/* ==========================
   State
   ========================== */
let me = null; // firebase user
let myDoc = null; // users/{uid} doc
let userUnsub = null;
let messagesUnsub = null;
let selected = null; // selected friend doc object

const STICKERS = ['üòä','üëç','üî•','üéâ','üòÖ','ü§ò'];
STICKERS.forEach(s=>{
  const b = document.createElement('button'); b.className='stickerBtn'; b.textContent=s;
  b.onclick = ()=>sendSticker(s);
  stickersRow.appendChild(b);
});

/* ==========================
   Helpers
   ========================== */
function toast(msg, ms=4000){
  toastEl.textContent = msg; toastEl.style.display='block';
  clearTimeout(toastEl._t); toastEl._t = setTimeout(()=> toastEl.style.display='none', ms);
}
function safeLog(){ console.log.apply(console, arguments); }

/* ==========================
   Auth
   ========================== */
loginBtn.onclick = async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithPopup(provider);
  } catch(err){
    // popup closed by user or other auth error
    toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (err.message||err.code));
    console.error('auth err', err);
  }
};
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  location.reload();
};

auth.onAuthStateChanged(async user=>{
  if(user){
    me = user;
    authArea.style.display = 'none';
    userArea.style.display = 'flex';
    meAvatar.src = user.photoURL || '';
    meName.textContent = user.displayName || '';
    meEmail.textContent = user.email || '';
    await ensureUserDoc(user);
    startUserListener(user.uid);
    renderContacts();
  } else {
    authArea.style.display = 'flex';
    userArea.style.display = 'none';
  }
});

/* ==========================
   Ensure users/{uid} doc
   ========================== */
async function ensureUserDoc(user){
  const ref = db.collection('users').doc(user.uid);
  const doc = await ref.get();
  if(!doc.exists){
    // create basic doc with temporary username (email prefix) and empty friends
    const basic = {
      uid: user.uid,
      username: (user.email||'user').split('@')[0] + '_' + Math.floor(Math.random()*900),
      email: user.email||'',
      photoURL: user.photoURL||'',
      friends: []
    };
    await ref.set(basic);
    myDoc = basic;
  } else {
    myDoc = doc.data();
  }
}

/* ==========================
   User doc listener
   ========================== */
function startUserListener(uid){
  if(userUnsub) userUnsub();
  userUnsub = db.collection('users').doc(uid).onSnapshot(doc=>{
    if(doc.exists) { myDoc = doc.data(); renderContacts(); }
  }, err=>{
    console.error('user listener err', err);
    toast('–û—à–∏–±–∫–∞ listeners: ' + (err.message||err.code));
  });
}

/* ==========================
   Render contacts
   ========================== */
async function renderContacts(){
  contactsList.innerHTML = '';
  if(!myDoc) return;
  const friends = myDoc.friends || [];
  if(friends.length === 0){
    contactsList.innerHTML = `<div class="small">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –¥–æ–±–∞–≤—å –ø–æ username</div>`;
    return;
  }
  // fetch each friend doc in parallel
  const promises = friends.map(uid => db.collection('users').doc(uid).get().then(d=>d.exists?d.data():null));
  const results = await Promise.all(promises);
  results.filter(Boolean).forEach(f=>{
    const el = document.createElement('div'); el.className='contact';
    el.innerHTML = `<img src="${f.photoURL||''}" class="avatar" style="width:44px;height:44px;border-radius:8px"/><div><div class="name">${f.username||f.email}</div><div class="small">${f.email||''}</div></div>`;
    el.onclick = ()=>selectContact(f);
    contactsList.appendChild(el);
  });
}

/* ==========================
   Add friend by username
   ========================== */
addBtn.onclick = async ()=>{
  const username = (usernameSearch.value||'').trim();
  if(!username){ toast('–í–≤–µ–¥–∏—Ç–µ username'); return; }
  if(!me){ toast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
  try {
    const q = await db.collection('users').where('username','==',username).get();
    if(q.empty){ toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    const target = q.docs[0].data();
    if(target.uid === me.uid){ toast('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è'); return; }
    if((myDoc.friends||[]).includes(target.uid)){ toast('–£–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö'); return; }
    await db.collection('users').doc(me.uid).update({ friends: firebase.firestore.FieldValue.arrayUnion(target.uid) });
    usernameSearch.value = '';
    toast('–î–æ–±–∞–≤–ª–µ–Ω: ' + (target.username||target.email));
  } catch(err){
    console.error('add friend err', err);
    toast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + (err.message||err.code));
  }
};

/* ==========================
   Select contact: subscribe messages
   ========================== */
function selectContact(friend){
  selected = friend;
  chatHeader.innerHTML = `<img src="${friend.photoURL||''}" class="avatar" style="width:44px;height:44px;margin-right:10px"/> <div style="font-weight:700">${friend.username||friend.email}</div>`;
  rightContent.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${friend.photoURL||''}" class="avatar" style="width:72px;height:72px;border-radius:10px"/><div><div style="font-weight:700">${friend.username}</div><div class="small">${friend.email||''}</div></div></div>`;
  // unsubscribe previous
  if(messagesUnsub) messagesUnsub();
  // subscribe to ANY message where current user participates (no orderBy to avoid index requirement)
  messagesUnsub = db.collection('messages')
    .where('participants','array-contains', me.uid)
    .onSnapshot(snap=>{
      const msgs = [];
      snap.forEach(d=>{
        const data = d.data();
        // filter only messages that include selected.uid
        if(!data.participants || !data.participants.includes(selected.uid)) return;
        msgs.push(Object.assign({id:d.id}, data));
      });
      // client-side sort by timestamp (serverTimestamp might be null briefly)
      msgs.sort((a,b)=>{
        const ta = (a.timestamp && a.timestamp.toDate) ? a.timestamp.toDate().getTime() : (a._localTime||0);
        const tb = (b.timestamp && b.timestamp.toDate) ? b.timestamp.toDate().getTime() : (b._localTime||0);
        return ta - tb;
      });
      renderMessages(msgs);
    }, err=>{
      console.error('messages listener err', err);
      // If the error mentions index, give link (no waiting instruction)
      if(err && err.message && err.message.toLowerCase().includes('index')){
        toast('Firestore: query requires an index. –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤ Console (—Å–º. –ª–æ–≥).');
        console.info('Index link (from error): open your Firebase Console ‚Üí Firestore ‚Üí Indexes');
      } else {
        toast('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + (err.message||err.code));
      }
    });
}

/* ==========================
   Render messages
   ========================== */
function renderMessages(msgs){
  chatBody.innerHTML = '';
  if(msgs.length === 0){
    chatBody.innerHTML = `<div class="small">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>`;
    return;
  }
  for(const m of msgs){
    const row = document.createElement('div'); row.className='msgRow ' + (m.senderId===me.uid ? 'me':'');
    const bubble = document.createElement('div'); bubble.className='bubble';
    if(m.type === 'image' && m.mediaURL){
      const img = document.createElement('img'); img.src = m.mediaURL; img.style.maxWidth='360px'; img.style.borderRadius='8px';
      bubble.appendChild(img);
      if(m.text) { const t = document.createElement('div'); t.className='small'; t.textContent = m.text; bubble.appendChild(t); }
    } else if(m.type === 'sticker'){
      const s = document.createElement('div'); s.style.fontSize='28px'; s.textContent = m.text; bubble.appendChild(s);
    } else {
      bubble.textContent = m.text || '';
    }
    const time = document.createElement('div'); time.className='time';
    const ts = (m.timestamp && m.timestamp.toDate) ? m.timestamp.toDate() : null;
    time.textContent = ts ? ts.toLocaleString() : '';
    row.appendChild(bubble);
    row.appendChild(time);
    chatBody.appendChild(row);
  }
  // scroll to bottom
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* ==========================
   Sending messages
   ========================== */
sendBtn.onclick = async ()=>{
  const text = (msgInput.value||'').trim();
  if(!selected){ toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç'); return; }
  if(!text) return;
  await sendMessage({ text, type: 'text' });
  msgInput.value = '';
};

async function sendSticker(s){
  if(!selected){ toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç'); return; }
  await sendMessage({ text: s, type: 'sticker' });
}

attachBtn.onclick = ()=> fileInput.click();

fileInput.onchange = async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  if(!selected){ toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç'); return; }
  const path = `chat_images/${Date.now()}_${me.uid}_${file.name.replace(/\s/g,'_')}`;
  try {
    const ref = storage.ref().child(path);
    const snap = await ref.put(file);
    const url = await snap.ref.getDownloadURL();
    await sendMessage({ text: '', type: 'image', mediaURL: url });
    fileInput.value = '';
  } catch(err){
    console.error('upload err', err);
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (err.message||err.code));
  }
};

async function sendMessage({ text='', type='text', mediaURL=null }){
  const payload = {
    text,
    senderId: me.uid,
    receiverId: selected.uid,
    participants: [me.uid, selected.uid],
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    type,
    mediaURL: mediaURL || null
  };
  try {
    await db.collection('messages').add(payload);
  } catch(err){
    console.error('sendMessage err', err);
    // If requires index (shouldn't for our query), inform user
    if(err && err.message && err.message.toLowerCase().includes('index')){
      toast('–û—à–∏–±–∫–∞: –∑–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–¥–µ–∫—Å–∞. –û—Ç–∫—Ä–æ–π—Ç–µ Firestore ‚Üí Indexes –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∏–Ω–¥–µ–∫—Å.');
      console.info('Index error:', err);
    } else if (err && err.code && err.code.includes('permission')){
      toast('–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ Firestore: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ security rules.');
    } else {
      toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (err.message||err.code));
    }
  }
}

/* ==========================
   Clean up on unload
   ========================== */
window.addEventListener('beforeunload', ()=>{
  if(userUnsub) userUnsub();
  if(messagesUnsub) messagesUnsub();
});
</script>

<!--
  –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø / –£–°–¢–†–ê–ù–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú

  1) "The query requires an index" ‚Äî –≤ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã –¥–µ–ª–∞–ª–∏ .where(...).orderBy('timestamp'),
     —ç—Ç–æ —Ç—Ä–µ–±–æ–≤–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞. –í —ç—Ç–æ–º —Ñ–∞–π–ª–µ —è —É–±—Ä–∞–ª orderBy –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
     –∏ —Å–æ—Ä—Ç–∏—Ä—É—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –∫–æ–º–ø–æ–∑–∏—Ç–Ω–æ–º –∏–Ω–¥–µ–∫—Å–µ.
     –ï—Å–ª–∏ —Ç—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—à—å —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É ‚Äî —Å–æ–∑–¥–∞–π –∏–Ω–¥–µ–∫—Å –≤ Firebase Console:
     Firestore -> Indexes -> Add index:
       collection: messages
       fields: participants (array), timestamp (asc)

  2) –ï—Å–ª–∏ —Ç—ã –≤—Å—ë –∂–µ –≤–∏–¥–∏—à—å –æ—à–∏–±–∫—É –∏–Ω–¥–µ–∫—Å–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ ‚Äî —â—ë–ª–∫–Ω–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
     (–≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞/–≤ –ª–æ–≥–∞—Ö) ‚Äî –æ–Ω–∞ —É–∫–∞–∂–µ—Ç –Ω–∞ —Ç–æ—á–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Firebase Console.

  3) –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∏–∑-–∑–∞ –ø—Ä–∞–≤–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Missing or insufficient permissions),
     —É–±–µ–¥–∏—Å—å, —á—Ç–æ –ø—Ä–∞–≤–∏–ª–∞ Firestore –∏ Storage —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ø—Ä–∏–º–µ—Ä—É, –∫–æ—Ç–æ—Ä—ã–π —è –ø—Ä–∏—Å–ª–∞–ª —Ä–∞–Ω–µ–µ.
     –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—á–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (–ø—Ä–∏–º–µ—Ä):

     Firestore rules:
     rules_version = '2';
     service cloud.firestore {
       match /databases/{database}/documents {
         function isSignedIn(){ return request.auth != null; }
         match /users/{userId} {
           allow read: if isSignedIn();
           allow create: if isSignedIn() && request.auth.uid == userId;
           allow update: if isSignedIn() && request.auth.uid == userId;
         }
         match /messages/{msgId} {
           allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants
                         && request.resource.data.senderId == request.auth.uid;
           allow read: if isSignedIn() && request.auth.uid in resource.data.participants;
           allow update, delete: if isSignedIn() && request.auth.uid in resource.data.participants;
         }
       }
     }

     Storage rules (–ø—Ä–∏–º–µ—Ä):
     rules_version = '2';
     service firebase.storage {
       match /b/{bucket}/o {
         match /{allPaths=**} {
           allow read, write: if request.auth != null;
         }
       }
     }

  4) –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—à—å `auth/popup-closed-by-user`, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ popup –±—ã–ª –∑–∞–∫—Ä—ã—Ç
     –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ‚Äî –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞, –ª–∏–±–æ –ø—Ä–æ–≤–µ—Ä—å Authorized domains –≤ Firebase Console (–¥–æ–±–∞–≤—å localhost –∏ –¥–æ–º–µ–Ω github.io –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å Pages).

  5) –î–∏–∑–∞–π–Ω: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –Ω–∞—Å—Ç–æ–ª—å–Ω—ã–π –≤–∏–¥ (–∫–∞–∫ –≤ :contentReference[oaicite:2]{index=2}/:contentReference[oaicite:3]{index=3}).
     –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Ü–≤–µ—Ç–∞, –æ—Ç—Å—Ç—É–ø—ã –∏–ª–∏ ¬´–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π¬ª —Ä–µ–∂–∏–º (—É–∑–∫–∏–π sidebar, compact view) ‚Äî –º–æ–≥—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –≤—Å—Ç—Ä–æ–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.

  –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–≥—É:
    ‚Ä¢ –¥–æ–±–∞–≤–∏—Ç—å server-side orderBy –æ–±—Ä–∞—Ç–Ω–æ –∏ –¥–∞—Ç—å exact JSON –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏;
    ‚Ä¢ —É–ª—É—á—à–∏—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ (threads/{threadId}/messages) ‚Äî —ç—Ç–æ –∏–∑–±–∞–≤–∏—Ç –æ—Ç –º–Ω–æ–≥–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ —É–ø—Ä–æ—Å—Ç–∏—Ç –ø—Ä–∞–≤–∏–ª–∞;
    ‚Ä¢ —Å–¥–µ–ª–∞—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º –∏–ª–∏ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É.

  –ù–∞–ø–∏—à–∏, —á—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ ‚Äî –∏ —è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –≤–Ω–µ—Å—É –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª (–≤–∫–ª—é—á–∞—è –≥–æ—Ç–æ–≤—ã–π index JSON / –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é).
-->
</body>
</html>
