```html
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Firebase Messenger ‚Äî Google Sign-in (Demo)</title>
  <style>
    body{font-family: Inter, system-ui, sans-serif;margin:0;background:#f6f7fb;color:#111}
    header{background:#334155;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    main{padding:16px;max-width:980px;margin:20px auto}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.06);}
    .row{display:flex;gap:10px;align-items:center}
    #loginBtn{padding:8px 12px;border-radius:8px;border:none;background:#1f2937;color:#fff;cursor:pointer}
    #signOut{background:transparent;border:1px solid rgba(255,255,255,0.2);color:#fff;padding:6px 10px;border-radius:6px}
    #usersList{max-height:220px;overflow:auto;margin-top:8px}
    #chat{display:flex;gap:12px;margin-top:12px}
    #convoList{width:260px}
    #messages{flex:1;display:flex;flex-direction:column;height:420px}
    #msgs{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column}
    .msg{margin:6px 0;padding:8px;border-radius:10px;max-width:70%;position:relative;word-break:break-word}
    .me{align-self:flex-end;background:#e2f0ff}
    .other{align-self:flex-start;background:#f0f4f8}
    .msg img{max-width:260px;border-radius:8px;display:block}
    .time{font-size:11px;color:#6b7280;margin-top:6px;display:inline-block}
    #composer{display:flex;gap:8px;padding:8px}
    input, button, select{font-size:14px}
    .convoRow{display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(0,0,0,0.04)}
    .convoInfo{display:flex;gap:8px;align-items:center}
    .convoName{font-weight:600}
    .unreadBadge{background:#ef4444;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px}
    .favoriteBtn{background:transparent;border:none;cursor:pointer;font-size:16px}
    .smallMuted{font-size:12px;color:#6b7280}
    .msg .bubble-content{display:block}
    /* keep original overall design and colors */
  </style>
</head>
<body>
  <header>
    <div>Firebase Messenger ‚Äî –¥–µ–º–æ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Google)</div>
    <div id="userArea"><button id="loginBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button></div>
  </header>

  <main>
    <section class="card">
      <h3>–ö–æ—Ä–æ—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
      <ol>
        <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π GitHub Pages.</li>
        <li>–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à <code>firebaseConfig</code> –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é <code>FIREBASE_CONFIG</code> (—Å—Ç—Ä–æ–∫–∏ –Ω–∏–∂–µ).</li>
        <li>–†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore / Storage –∏ –∏–Ω–¥–µ–∫—Å (–≤–Ω–∏–∑—É —Ñ–∞–π–ª–∞ ‚Äî –ø–æ–º–µ—á–µ–Ω–æ).</li>
        <li>–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π <em>username</em>.</li>
      </ol>
      <p>–í–Ω–∏–∑—É ‚Äî –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Ñ–∞–π–ª –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è Firestore.</p>
      <p style="color:#b94a48"><strong>–í–∞–∂–Ω–æ:</strong> –µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑-–∑–∞ CORS/404 ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä <code>storageBucket</code> –≤ –≤–∞—à–µ–º <code>firebaseConfig</code> (–æ–±—ã—á–Ω–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ <code>.appspot.com</code>), –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –¥–ª—è bucket —á–µ—Ä–µ–∑ gsutil –∏–ª–∏ –∫–æ–Ω—Å–æ–ª—å GCP. –í –∫–æ–¥–µ –Ω–∏–∂–µ —è —Å–æ—Ö—Ä–∞–Ω–∏–ª —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –Ω–æ –µ—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–∞—é—Ç 404/CORS-–ø—Ä–æ–±–ª–µ–º—ã ‚Äî –∑–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ <code>storageBucket</code> –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–∑ Firebase Console.</p>
    </section>

    <section class="card" style="margin-top:12px">
      <div id="setupArea">
        <div id="chooseUsername" style="display:none">
          <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–π –ª–æ–≥–∏–Ω (–ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _ , -): <input id="usernameInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: mark12"/> <button id="saveUsername">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></p>
          <div id="usernameMsg"></div>
        </div>

        <div id="appUI" style="display:none">
          <div class="row">
            <input id="searchUser" placeholder="–ù–∞–π—Ç–∏ –ø–æ username" /> <button id="searchBtn">–ü–æ–∏—Å–∫</button>
          </div>
          <div id="usersList"></div>
          <div id="chat">
            <div id="convoList" class="card">
              <h4>–ë–µ—Å–µ–¥—ã</h4>
              <div id="convos"></div>
            </div>
            <div class="card" style="flex:1">
              <div id="messages">
                <div id="msgs"></div>
                <div id="composer">
                  <input id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" style="flex:1" />
                  <input type="file" id="imageInput" accept="image/*"/>
                  <select id="stickerSelect">
                    <option value="">–°—Ç–∏–∫–µ—Ä</option>
                    <option value="sticker1">üò∫</option>
                    <option value="sticker2">üéµ</option>
                    <option value="sticker3">üî•</option>
                  </select>
                  <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

  </main>

  <script type="module">
    // --- –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ FIREBASE_CONFIG –Ω–∏–∂–µ –Ω–∞ –≤–∞—à –∫–æ–Ω—Ñ–∏–≥ –∏–∑ Firebase Console ---
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyC54igVqsMXIRriBZwiq1w6knBTnkfKIe4",
      authDomain: "nova-prospect-chat.firebaseapp.com",
      projectId: "nova-prospect-chat",
      // <- –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–æ –ø–æ–ª–µ: –æ–±—ã—á–Ω–æ "your-project-id.appspot.com"
      storageBucket: "nova-prospect-chat.firebasestorage.app",
      messagingSenderId: "256806164650",
      appId: "1:256806164650:web:dd8faf7b8f11b68001d8d3",
      measurementId: "G-9V0Q2E2FNB"
    };

    // –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π Firebase (CDN)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import {
      getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp,
      orderBy, limit, onSnapshot, writeBatch, updateDoc, increment, arrayUnion, arrayRemove
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI elements
    const loginBtn = document.getElementById('loginBtn');
    const userArea = document.getElementById('userArea');
    const chooseUsername = document.getElementById('chooseUsername');
    const usernameInput = document.getElementById('usernameInput');
    const saveUsername = document.getElementById('saveUsername');
    const usernameMsg = document.getElementById('usernameMsg');
    const appUI = document.getElementById('appUI');
    const searchUser = document.getElementById('searchUser');
    const searchBtn = document.getElementById('searchBtn');
    const usersList = document.getElementById('usersList');
    const convosDiv = document.getElementById('convos');
    const msgsDiv = document.getElementById('msgs');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const imageInput = document.getElementById('imageInput');
    const stickerSelect = document.getElementById('stickerSelect');

    let currentUser = null;
    let currentConvoId = null;
    let messagesUnsub = null;
    let convosUnsub = null;
    let convoListeners = {}; // for per-convo listeners if needed

    // --- Utility helpers ---
    function convoIdFor(uidA, uidB){ return [uidA, uidB].sort().join('_'); }

    function formatHM(timestamp){
      if(!timestamp) return '';
      const d = (timestamp instanceof Date) ? timestamp : timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    const STICKER_MAP = {
      'sticker1': 'üò∫',
      'sticker2': 'üéµ',
      'sticker3': 'üî•'
    };

    // --- Auth ---
    loginBtn.addEventListener('click', async ()=>{
      const provider = new GoogleAuthProvider();
      try{ await signInWithPopup(auth, provider); }catch(e){alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: '+e.message)}
    });

    onAuthStateChanged(auth, async user=>{
      currentUser = user;
      if(user){
        userArea.innerHTML = `–ü—Ä–∏–≤–µ—Ç, ${user.displayName} <button id="signOut">–í—ã–π—Ç–∏</button>`;
        document.getElementById('signOut').addEventListener('click', ()=>signOut(auth));

        // request notification permission once user logged in
        if("Notification" in window && Notification.permission === "default"){
          try{ await Notification.requestPermission(); }catch(e){}
        }

        // –ü—Ä–æ–≤–µ—Ä–∏–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const uDoc = await getDoc(doc(db,'users',user.uid));
        if(!uDoc.exists()){
          chooseUsername.style.display = 'block';
          appUI.style.display = 'none';
        } else {
          chooseUsername.style.display = 'none';
          appUI.style.display = 'block';
          initApp();
        }
      } else {
        userArea.innerHTML = `<button id="loginBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>`;
        document.getElementById('loginBtn').addEventListener('click', async ()=>{ const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); });
        chooseUsername.style.display = 'none';
        appUI.style.display = 'none';
        // cleanup listeners
        if(convosUnsub) convosUnsub();
        if(messagesUnsub) messagesUnsub();
      }
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ username
    saveUsername.addEventListener('click', async ()=>{
      const username = usernameInput.value.trim().toLowerCase();
      if(!/^[a-z0-9_-]{3,20}$/.test(username)){ usernameMsg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç username (3-20 —Å–∏–º–≤–æ–ª–æ–≤: a-z0-9_-).'; return; }
      try{
        const unameDocRef = doc(db,'usernames',username);
        const uDocRef = doc(db,'users',currentUser.uid);
        const check = await getDoc(unameDocRef);
        if(check.exists()){ usernameMsg.textContent = '–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.'; return; }
        await setDoc(unameDocRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
        await setDoc(uDocRef, { uid: currentUser.uid, displayName: currentUser.displayName, email: currentUser.email, username, photoURL: currentUser.photoURL, createdAt: serverTimestamp() });
        usernameMsg.textContent = '–ì–æ—Ç–æ–≤–æ ‚Äî –∏–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.';
        chooseUsername.style.display = 'none';
        appUI.style.display = 'block';
        initApp();
      }catch(e){ console.error(e); usernameMsg.textContent = '–û—à–∏–±–∫–∞: '+e.message }
    });

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ username
    searchBtn.addEventListener('click', async ()=>{
      usersList.innerHTML = '–ü–æ–∏—Å–∫...';
      const qTxt = searchUser.value.trim().toLowerCase();
      if(!qTxt){ usersList.innerHTML = ''; return; }
      try{
        const unameDoc = await getDoc(doc(db,'usernames',qTxt));
        if(!unameDoc.exists()){ usersList.innerHTML = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ'; return; }
        const uid = unameDoc.data().uid;
        const u = await getDoc(doc(db,'users',uid));
        if(!u.exists()){ usersList.innerHTML = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ'; return; }
        usersList.innerHTML = '';
        const div = document.createElement('div');
        div.innerHTML = `<strong>${u.data().username}</strong> ‚Äî ${u.data().displayName} <button data-uid="${uid}" class="addFriend">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button> <button data-uid="${uid}" class="openChat">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>`;
        usersList.appendChild(div);
        div.querySelector('.addFriend').addEventListener('click', ()=>addFriend(uid));
        div.querySelector('.openChat').addEventListener('click', ()=>openConversationWith(uid));
      }catch(e){ usersList.innerHTML = '–û—à–∏–±–∫–∞: '+e.message }
    });

    async function addFriend(friendUid){
      if(!currentUser) return;
      if(friendUid === currentUser.uid) return alert('–≠—Ç–æ –≤—ã —Å–∞–º–∏.');
      try{
        await setDoc(doc(db,`users/${currentUser.uid}/friends`,friendUid), { uid: friendUid, createdAt: serverTimestamp() });
        alert('–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω.');
      }catch(e){ alert('–û—à–∏–±–∫–∞: '+e.message) }
    }

    // --- Conversation & messages logic ---

    // Initialize conversations list and listener
    function initApp(){
      // unsubscribe previous
      if(convosUnsub) convosUnsub();

      const convosQuery = query(collection(db,'conversations'), where('participants','array-contains', currentUser.uid), orderBy('updatedAt','desc'));
      convosUnsub = onSnapshot(convosQuery, async snap=>{
        convosDiv.innerHTML = '';
        const promises = [];
        snap.forEach(docSnap=>{
          const data = docSnap.data();
          const convoId = docSnap.id;
          promises.push(renderConvoRow(convoId, data));
        });
        await Promise.all(promises);
      });
    }

    // Render a single conversation row
    async function renderConvoRow(convoId, data){
      const otherUid = (data.participants || []).find(uid => uid !== currentUser.uid) || null;
      let otherUser = { displayName: otherUid, username: otherUid };
      if(otherUid){
        const u = await getDoc(doc(db,'users',otherUid));
        if(u.exists()) otherUser = u.data();
      }
      const row = document.createElement('div');
      row.className = 'convoRow';
      const nameHtml = `<div class="convoInfo"><div><div class="convoName">${otherUser.displayName || otherUser.username}</div><div class="smallMuted">${data.lastMessage || ''}</div></div></div>`;
      const rightHtml = `<div style="display:flex;gap:8px;align-items:center">
                          ${data.unreadCounts && data.unreadCounts[currentUser.uid] ? `<div class="unreadBadge">${data.unreadCounts[currentUser.uid]}</div>` : ''}
                          <button class="favoriteBtn" data-convo="${convoId}">${(data.favorites && data.favorites.includes(currentUser.uid)) ? '‚òÖ' : '‚òÜ'}</button>
                          <button data-open="${convoId}">–û—Ç–∫—Ä—ã—Ç—å</button>
                         </div>`;
      row.innerHTML = nameHtml + rightHtml;
      // click handlers
      row.querySelector('[data-open]').addEventListener('click', ()=>openConversationById(convoId, otherUid));
      row.querySelector('.favoriteBtn').addEventListener('click', async (e)=>{
        const btn = e.currentTarget;
        const convoRef = doc(db,'conversations',convoId);
        const convSnap = await getDoc(convoRef);
        const isFav = convSnap.exists() && convSnap.data().favorites && convSnap.data().favorites.includes(currentUser.uid);
        if(isFav){
          await updateDoc(convoRef, { favorites: arrayRemove(currentUser.uid) });
        } else {
          await updateDoc(convoRef, { favorites: arrayUnion(currentUser.uid) });
        }
      });
      // replace or append
      const existing = document.getElementById('convo_'+convoId);
      row.id = 'convo_'+convoId;
      if(existing) convosDiv.replaceChild(row, existing);
      else convosDiv.appendChild(row);
    }

    // Open conversation by conversation id (used from convo list)
    async function openConversationById(convoId, otherUid){
      currentConvoId = convoId;
      if(messagesUnsub) messagesUnsub();
      convosDiv.querySelectorAll('.convoRow').forEach(r=>r.classList.remove('active'));
      const el = document.getElementById('convo_'+convoId); if(el) el.classList.add('active');

      // Clear unread for current user
      const convoRef = doc(db,'conversations',convoId);
      const convoSnap = await getDoc(convoRef);
      if(convoSnap.exists()){
        const updateObj = {};
        updateObj[`unreadCounts.${currentUser.uid}`] = 0;
        try{ await updateDoc(convoRef, updateObj); }catch(e){}
      }

      // subscribe to messages
      const msgsRef = collection(db,'conversations',convoId,'messages');
      const q = query(msgsRef, orderBy('timestamp'));
      messagesUnsub = onSnapshot(q, snap=>{
        msgsDiv.innerHTML = '';
        snap.forEach(docSnap=>{
          const m = docSnap.data();
          const isMe = m.sender === currentUser.uid;
          const el = document.createElement('div'); el.className = 'msg '+(isMe? 'me':'other');
          let content = '';
          if(m.type === 'text') content = `<span class="bubble-content">${escapeHtml(m.text)}</span>`;
          else if(m.type === 'image') content = `<div class="bubble-content"><img src="${m.url}" alt="image"/></div>`;
          else if(m.type === 'sticker') content = `<span class="bubble-content">${STICKER_MAP[m.sticker] || ('[–°—Ç–∏–∫–µ—Ä:'+escapeHtml(m.sticker)+']')}</span>`;
          const time = formatHM(m.timestamp);
          el.innerHTML = content + `<div class="time">${time}</div>`;
          msgsDiv.appendChild(el);
        });
        msgsDiv.scrollTop = msgsDiv.scrollHeight;
      });
    }

    // Open conversation with a specific uid (creates convo doc if missing)
    async function openConversationWith(otherUid){
      if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ');
      if(otherUid === currentUser.uid) return alert('–ù–µ–ª—å–∑—è –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å —Å–∞–º–∏–º —Å–æ–±–æ–π.');
      const convoId = convoIdFor(currentUser.uid, otherUid);
      const convoRef = doc(db,'conversations',convoId);
      const cSnap = await getDoc(convoRef);
      if(!cSnap.exists()){
        // create minimal convo doc
        await setDoc(convoRef, { participants: [currentUser.uid, otherUid], lastMessage: '', updatedAt: serverTimestamp(), unreadCounts: { [currentUser.uid]: 0, [otherUid]: 0 }, favorites: [] });
      }
      openConversationById(convoId, otherUid);
    }

    // Send message (text/image/sticker)
    sendBtn.addEventListener('click', async ()=>{
      if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ');
      if(!currentConvoId) return alert('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç');
      const text = messageInput.value.trim();
      const sticker = stickerSelect.value;
      const file = imageInput.files[0];

      try{
        const msgsRef = collection(db,'conversations',currentConvoId,'messages');

        // find other user id from convoId
        const parts = currentConvoId.split('_');
        const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];

        let preview = '';
        if(file){
          const path = `images/${currentUser.uid}/${Date.now()}_${file.name}`;
          const storageRef = sRef(storage,path);
          // upload
          const snap = await uploadBytes(storageRef, file);
          // get URL
          const url = await getDownloadURL(storageRef);
          await addDoc(msgsRef, { sender: currentUser.uid, type:'image', url, timestamp: serverTimestamp() });
          preview = '–§–æ—Ç–æ';
        } else if(sticker){
          await addDoc(msgsRef, { sender: currentUser.uid, type:'sticker', sticker, timestamp: serverTimestamp() });
          preview = STICKER_MAP[sticker] || '–°—Ç–∏–∫–µ—Ä';
        } else if(text){
          await addDoc(msgsRef, { sender: currentUser.uid, type:'text', text, timestamp: serverTimestamp() });
          preview = text.slice(0,120);
        } else {
          return;
        }

        // update/create conversation doc (lastMessage, updatedAt, unread counts)
        const convoRef = doc(db,'conversations',currentConvoId);
        const convoSnap = await getDoc(convoRef);
        if(!convoSnap.exists()){
          await setDoc(convoRef, { participants: [currentUser.uid, otherUid], lastMessage: preview, updatedAt: serverTimestamp(), unreadCounts: { [currentUser.uid]: 0, [otherUid]: 1 }, favorites: [] });
        } else {
          // increment unread for other user
          const updateObj = { lastMessage: preview, updatedAt: serverTimestamp() };
          updateObj[`unreadCounts.${otherUid}`] = increment(1);
          await updateDoc(convoRef, updateObj);
        }

        // clear composer
        messageInput.value = '';
        imageInput.value = '';
        stickerSelect.value = '';
      }catch(e){ alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: '+e.message) }
    });

    // Helper to escape text into safe HTML
    function escapeHtml(unsafe){
      return unsafe
           .replaceAll('&','&amp;')
           .replaceAll('<','&lt;')
           .replaceAll('>','&gt;')
           .replaceAll('"','&quot;')
           .replaceAll("'",'&#039;');
    }

    // Listen globally for incoming messages to show browser notification and ensure convo appears
    // We set up a collectionGroup listener for messages where recipient is currentUser (we don't store recipient in message; we'll infer by convo participants).
    // Simpler approach: listen to conversations where currentUser is participant and react to updatedAt changes.
    // We'll use the same convosUnsub snapshot handler to detect new messages and show notifications for ones not sent by me.
    // The onSnapshot above (initApp) will run when convos update; we can detect lastMessage changes and notify.

    // We'll keep a small in-memory map of lastKnownUpdatedAt to compare and detect new incoming messages
    const convoLastSeen = {};

    // Wrap initApp change to detect notifications
    async function initApp(){
      if(convosUnsub) convosUnsub();
      const convosQuery = query(collection(db,'conversations'), where('participants','array-contains', currentUser.uid), orderBy('updatedAt','desc'));
      convosUnsub = onSnapshot(convosQuery, async snap=>{
        convosDiv.innerHTML = '';
        const promises = [];
        for(const docSnap of snap.docs){
          const data = docSnap.data();
          const convoId = docSnap.id;

          // detect incoming message (updatedAt changed and lastMessage author is not me)
          const lastUpdated = data.updatedAt ? data.updatedAt.toMillis ? data.updatedAt.toMillis() : new Date(data.updatedAt).getTime() : 0;
          const prev = convoLastSeen[convoId] || 0;
          if(lastUpdated && lastUpdated > prev){
            // if last message didn't originate from me (we check unreadCounts for current user >0) -> show notification
            const unread = data.unreadCounts && data.unreadCounts[currentUser.uid];
            if(unread && unread > 0){
              // show browser notification
              if("Notification" in window && Notification.permission === "granted"){
                const otherUid = (data.participants || []).find(u => u !== currentUser.uid) || '';
                let otherName = otherUid;
                try{
                  const u = await getDoc(doc(db,'users',otherUid));
                  if(u.exists()) otherName = u.data().displayName || u.data().username || otherUid;
                }catch(e){}
                new Notification(`${otherName}`, { body: data.lastMessage || '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', silent: false });
              }
            }
          }
          convoLastSeen[convoId] = lastUpdated;

          promises.push(renderConvoRow(convoId, data));
        }
        await Promise.all(promises);
      });
    }

    // ensure initApp available early
    // (no-op - real init happens on auth state change)

    // If user clicks a conversation opened from a search/open button, open it by id
    // (openConversationWith already handles creation)

    // small helper to ensure images show properly: if getDownloadURL fails due to CORS/404, we include a placeholder text (handled on render).
    // But usually getDownloadURL returns a proper URL. If you see 404/CORS in console, check storageBucket config and CORS bucket settings.

    // --- End of main script ---
  </script>

  <!--
    --- FIRESTORE RULES (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ Firebase Console -> Firestore -> Rules) ---

    // firestore.rules
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {

        match /usernames/{username} {
          allow create: if request.auth != null && request.resource.data.uid == request.auth.uid && !exists(/databases/$(database)/documents/usernames/$(username));
          allow read: if true;
          allow delete: if false;
        }

        match /users/{userId} {
          allow read: if true;
          allow create: if request.auth != null && request.auth.uid == userId;
          allow update, delete: if request.auth != null && request.auth.uid == userId;

          match /friends/{friendId} {
            allow read: if request.auth != null && request.auth.uid == userId;
            allow create: if request.auth != null && request.auth.uid == userId;
            allow delete: if request.auth != null && request.auth.uid == userId;
          }
        }

        match /conversations/{convoId} {
          allow read: if request.auth != null && request.auth.uid in resource.data.participants;
          allow create: if request.auth != null && request.auth.uid in request.resource.data.participants;
          allow update: if request.auth != null && request.auth.uid in request.resource.data.participants;
          allow delete: if false;

          match /messages/{msgId} {
            allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/conversations/$(convoId)).data.participants;
            allow create: if request.auth != null && request.auth.uid == request.resource.data.sender && request.resource.data.type in ['text','image','sticker'] && request.resource.data.timestamp == request.time;
            allow delete, update: if false;
          }
        }
      }
    }

    --- STORAGE RULES (–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ Firebase Console -> Storage -> Rules) ---

    // storage.rules
    rules_version = '2';
    service firebase.storage {
      match /b/{bucket}/o {
        match /images/{userId}/{allPaths=**} {
          allow read: if true;
          allow write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }

    --- firestore.indexes.json (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å) ---
    {
      "indexes": [
        {
          "collectionGroup": "messages",
          "queryScope": "COLLECTION",
          "fields": [
            { "fieldPath": "timestamp", "order": "ASCENDING" }
          ]
        },
        {
          "collectionGroup": "conversations",
          "queryScope": "COLLECTION",
          "fields": [
            { "fieldPath": "updatedAt", "order": "DESCENDING" }
          ]
        }
      ],
      "fieldOverrides": []
    }
  -->

</body>
</html>
```
